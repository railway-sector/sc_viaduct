import{gs as m,jV as L,gv as Te,jX as v,jZ as De,aO as de,aL as xe,j_ as Ee,ae as he,eV as k,j$ as Ne,cB as ve,bg as Ae}from"./index-BApIjc64.js";import{t as Se,l as Y}from"./arcade-BJu6KTko.js";import{o as x,i as Le,c as $,B as A,p as j,g as E,Z as Ze,K as ue,f as ce,X as me,z as Z,A as H,H as K,t as z,L as Ce,S as W,h as ke,Y as q}from"./Dictionary-RoNWAmlX.js";import{I as Pe}from"./Feature-BIvC14dv.js";import{v as je,R as pe,y as Re,h as ee,e as Ue,i as Me,s as Oe,F as J,E as ze,k as He,O as We,a as O,I as Ve,D as Q,b as C,x as ne}from"./featureSetUtils-HG3KBCaA.js";import{t as _e}from"./ImmutableArray-BPVd6ESQ.js";import{l as Ge}from"./portalUtils-MM5aotfg.js";import{s as Be,v as ye}from"./SpatialFilter-DC1axfCF.js";import{N as we,o as te}from"./shared-CH9Xn1P0.js";import{L as D}from"./WhereClause-C9SAtD4C.js";import{queryAssociations as Ke}from"./queryAssociations-BZr4oM-0.js";import qe from"./QueryAssociationsParameters-CPOEBkQm.js";import"./arcadeEnvironment-Bp82qbDY.js";import"./aiServices-BmqUtjsv.js";import"./commonProperties-DHiB1uzW.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./unitConversion-DCCnHymP.js";import"./number-BtX_N8zf.js";import"./hash-CcEbRgUF.js";import"./operatorsWorkerConnection-Ceky5Vta.js";import"./Association-BTnsfqti.js";function Qe(a){if(a.length===1){if(v(a[0]))return Y("distinct",a[0],-1);if(z(a[0]))return Y("distinct",a[0].toArray(),-1)}return Y("distinct",a,-1)}function ie(a,y,n){const i=a.getVariables();if(i.length>0){const I={};for(const F of i)I[F]=y.evaluateIdentifier(n,{name:F});a.parameters=I}return a}function d(a,y,n=null){for(const i in a)if(i.toLowerCase()===y.toLowerCase())return a[i];return n}function Ie(a){if(a===null)return null;const y={type:d(a,"type",""),name:d(a,"name","")};if(y.type==="range")y.range=d(a,"range",[]);else{y.codedValues=[];for(const n of d(a,"codedValues",[]))y.codedValues.push({name:d(n,"name",""),code:d(n,"code",null)})}return y}function ae(a){if(a===null)return null;const y={},n=d(a,"wkt");n!==null&&(y.wkt=n);const i=d(a,"wkid");return i!==null&&(y.wkid=i),y}function ge(a){if(a===null)return null;const y={hasZ:d(a,"hasz",!1),hasM:d(a,"hasm",!1)},n=d(a,"spatialreference");n!=null&&(y.spatialReference=ae(n));const i=d(a,"x",null);if(i!==null)return y.x=i,y.y=d(a,"y",null),y.hasZ&&(y.z=d(a,"z",null)),y.hasM&&(y.m=d(a,"m",null)),y;const I=d(a,"rings",null);if(I!==null)return y.rings=I,y;const F=d(a,"paths",null);if(F!==null)return y.paths=F,y;const e=d(a,"points",null);if(e!==null)return y.points=e,y;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const l=d(a,t,null);l!==null&&(y[t]=l)}return y}function Je(a,y){for(const n of y)if(n===a)return!0;return!1}function Xe(a){return!!a.layerDefinition&&!!a.featureSet&&Je(a.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&v(a.layerDefinition.fields)!==!1&&v(a.featureSet.features)!==!1}function V(a){return a?.toLowerCase()==="utc"?"UTC":a?.toLowerCase()==="unknown"?"Unknown":a}async function Ye(a,y,n,i,I,F,e){const t=await a.getFeatureSetInfo();if((t?.layerId??null)===null||!I.layerIdLookup.get(t.layerId))return null;const l=a.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),o=[];switch(n){case"connected":o.push("connectivity"),o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity"),o.push("junction-edge-midspan-connectivity"),o.push("junction-junction-connectivity");break;case"container":case"content":o.push("containment");break;case"structure":case"attached":o.push("attachment");break;case"junctionedge":o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity");break;case"midspan":o.push("junction-edge-midspan-connectivity");break;default:throw new m(F,"InvalidParameter",e)}let p=null,u=!1;if(i!==null&&i!==""&&i!==void 0){for(const f of I.terminals)f.terminalName===i&&(p=f.terminalId);p===null&&(u=!0)}const s=[];if(!u){const f=new ve({globalId:y.field(a.globalIdField),networkSourceId:I.layerIdLookup.get(t.layerId).sourceId,...p?{terminalId:p}:""}),c=await Ke(l,new qe({types:o,elements:[f]}));let N=0;for(const w of c.associations){let g=null,T="",P="";if(w.fromNetworkElement?.globalId===f.globalId?(g=w.toNetworkElement,P="to"):w.toNetworkElement?.globalId===f.globalId&&(g=w.fromNetworkElement,P="from"),!g)continue;switch(n){case"attached":if(w.associationType!=="attachment"||P!=="to")continue;break;case"structure":if(w.associationType!=="attachment"||P!=="from")continue;break;case"container":if(w.associationType!=="containment"||P!=="from")continue;break;case"content":if(w.associationType!=="containment"||P!=="to")continue;break;case"connected":break;case"junctionedge":w.associationType==="junction-edge-to-connectivity"?T="to":w.associationType==="junction-edge-from-connectivity"&&(T="from");break;case"midspan":if(w.associationType!=="junction-edge-midspan-connectivity")continue}const _=I.sourceIdLookup.get(g.networkSourceId)?.className??"";s.push(new Ae({geometry:null,attributes:{objectId:N++,globalId:g.globalId,percentAlong:w.percentAlong??0,isContentVisible:w.isContentVisible?0:1,className:_,side:T}}))}}const r=new he({source:s,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new k({name:"objectId",alias:"objectId",type:"oid"}),new k({name:"globalId",alias:"globalId",type:"global-id"}),new k({name:"percentAlong",alias:"percentAlong",type:"double"}),new k({name:"side",alias:"side",type:"string"}),new k({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new k({name:"className",alias:"className",type:"string"})]});return J(r)}function bn(a){if(a.mode==="async"){a.functions.timezone=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,1,2,n,i),Le(e[0])||$(e[0]))return"Unknown";if(A(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?V("unknown"):V(e[0].dateFieldsTimeZone);if(!(e[1]instanceof j)||e[1].hasField("type")===!1)throw new m(n,"InvalidParameter",i);const o=e[1].field("type");if(L(o)===!1)throw new m(n,"InvalidParameter",i);switch(E(o).toLowerCase()){case"preferredtimezone":return V(e[0].preferredTimeZone);case"editfieldsinfo":return V(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return V(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&L(e[1].field("fieldname")))return V(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new m(n,"InvalidParameter",i)}const t=Ze(e[0],ue(n));if(t===null)return null;const l=t.timeZone;return l==="system"?Te.systemTimeZoneCanonicalName:l.toLowerCase()==="utc"?"UTC":l.toLowerCase()==="unknown"?"Unknown":l})},a.functions.sqltimestamp=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{x(e,1,3,n,i);const t=e[0];if(ce(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new m(n,"InvalidParameter",i)}if($(t))return t.toSQLWithKeyword();if(A(t)){if(e.length!==3)throw new m(n,"InvalidParameter",i);await t.load();const l=E(e[1]);if($(e[2]))return e[2].toSQLWithKeyword();if(ce(e[2])===!1)throw new m(n,"InvalidParameter",i);const o=t.fieldTimeZone(l);return o==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(o).toSQLWithKeyword()}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"sqltimestamp",min:2,max:4}),a.functions.featuresetbyid=function(n,i){return a.standardFunctionAsync(n,i,(I,F,e)=>{if(x(e,2,4,n,i),me(e[0])){const t=E(e[1]);let l=Z(e[2],null);const o=H(Z(e[3],!0));if(l===null&&(l=["*"]),v(l)===!1)throw new m(n,"InvalidParameter",i);return e[0].featureSetById(t,o,l)}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"featuresetbyid",min:2,max:4});const y=new De(["datasource","parent","root"]);a.functions.getfeatureset=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,1,2,n,i),K(e[0])){const t=e[1]==null?"datasource":y.lookup(E(e[1]));return je(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference)}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"getfeatureset",min:1,max:2}),a.functions.featuresetbyportalitem=function(n,i){return a.standardFunctionAsync(n,i,(I,F,e)=>{if(x(e,2,5,n,i),e[0]===null)throw new m(n,"PortalRequired",i);if(e[0]instanceof Se){const u=E(e[1]),s=E(e[2]);let r=Z(e[3],null);const f=H(Z(e[4],!0));if(r===null&&(r=["*"]),v(r)===!1)throw new m(n,"InvalidParameter",i);let c;return c=n.services?.portal?n.services.portal:de.getDefault(),c=Ge(e[0],c),pe(u,s,n.spatialReference,r,f,c,n.lrucache,n.interceptor)}if(L(e[0])===!1)throw new m(n,"PortalRequired",i);const t=E(e[0]),l=E(e[1]);let o=Z(e[2],null);const p=H(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new m(n,"InvalidParameter",i);return pe(t,l,n.spatialReference,o,p,n.services?.portal??de.getDefault(),n.lrucache,n.interceptor)})},a.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),a.functions.featuresetbyname=function(n,i){return a.standardFunctionAsync(n,i,(I,F,e)=>{if(x(e,2,4,n,i),me(e[0])){const t=E(e[1]);let l=Z(e[2],null);const o=H(Z(e[3],!0));if(l===null&&(l=["*"]),v(l)===!1)throw new m(n,"InvalidParameter",i);return e[0].featureSetByName(t,o,l)}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"featuresetbyname",min:2,max:4}),a.functions.featureset=function(n,i){return a.standardFunction(n,i,(I,F,e)=>{x(e,1,1,n,i);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(L(e[0])){const l=JSON.parse(e[0]);l.layerDefinition!==void 0?(t.layerDefinition=l.layerDefinition,t.featureSet=l.featureSet,l.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=l.layerDefinition.spatialReference)):(t.featureSet.features=l.features,t.featureSet.geometryType=l.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=l.objectIdFieldName??"",t.layerDefinition.typeIdField=l.typeIdFieldName,t.layerDefinition.globalIdField=l.globalIdFieldName,t.layerDefinition.fields=l.fields,l.spatialReference&&(t.layerDefinition.spatialReference=l.spatialReference))}else{if(!(e[0]instanceof j))throw new m(n,"InvalidParameter",i);{const l=JSON.parse(e[0].castToText(!0)),o=d(l,"layerdefinition");if(o!==null){t.layerDefinition.geometryType=d(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=d(o,"globalidfield",""),t.layerDefinition.objectIdField=d(o,"objectidfield",""),t.layerDefinition.typeIdField=d(o,"typeidfield",""),t.layerDefinition.hasZ=d(o,"hasz",!1)===!0,t.layerDefinition.hasM=d(o,"hasm",!1)===!0;const p=d(o,"spatialreference");p&&(t.layerDefinition.spatialReference=ae(p));const u=[];for(const r of d(o,"fields",[])){const f={name:d(r,"name",""),alias:d(r,"alias",""),type:d(r,"type",""),nullable:d(r,"nullable",!0),editable:d(r,"editable",!0),length:d(r,"length",null),domain:Ie(d(r,"domain"))};u.push(f)}t.layerDefinition.fields=u;const s=d(l,"featureset");if(s){const r={};for(const f of u)r[f.name.toLowerCase()]=f.name;for(const f of d(s,"features",[])){const c={},N=d(f,"attributes",{});for(const w in N)c[r[w.toLowerCase()]]=N[w];t.featureSet.features.push({attributes:c,geometry:ge(d(f,"geometry"))})}}}else{t.layerDefinition.hasZ=d(l,"hasz",!1)===!0,t.layerDefinition.hasM=d(l,"hasm",!1)===!0,t.layerDefinition.geometryType=d(l,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=d(l,"objectidfieldname",""),t.layerDefinition.typeIdField=d(l,"typeidfieldname","");const p=d(l,"spatialreference");p&&(t.layerDefinition.spatialReference=ae(p));const u=[],s=d(l,"fields",null);if(!v(s))throw new m(n,"InvalidParameter",i);for(const c of s){const N={name:d(c,"name",""),alias:d(c,"alias",""),type:d(c,"type",""),nullable:d(c,"nullable",!0),editable:d(c,"editable",!0),length:d(c,"length",null),domain:Ie(d(c,"domain"))};u.push(N)}t.layerDefinition.fields=u;const r={};for(const c of u)r[c.name.toLowerCase()]=c.name;let f=d(l,"features",null);if(v(f))for(const c of f){const N={},w=d(c,"attributes",{});for(const g in w)N[r[g.toLowerCase()]]=w[g];t.featureSet.features.push({attributes:N,geometry:ge(d(c,"geometry",null))})}else f=null,t.featureSet.features=f}}}if(Xe(t)===!1)throw new m(n,"InvalidParameter",i);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),Re.create(t,n.spatialReference)})},a.signatures.push({name:"featureset",min:1,max:1}),a.functions.filter=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,2,2,n,i),v(e[0])||z(e[0])){const t=[];let l,o=e[0];if(o instanceof _e&&(o=o.toArray()),!Ce(e[1]))throw new m(n,"InvalidParameter",i);l=e[1].createFunction(n);for(const p of o){const u=l(p);xe(u)?await u===!0&&t.push(p):u===!0&&t.push(p)}return t}if(A(e[0])){const t=await e[0].load(),l=D.create(e[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),o=l.getVariables();if(o.length>0){const p={};for(const u of o)p[u]=a.evaluateIdentifier(n,{name:u});l.parameters=p}return new ee({parentfeatureset:e[0],whereclause:l})}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"filter",min:2,max:2}),a.functions.orderby=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,2,2,n,i),A(e[0])){const t=new Ue(e[1]);return new Me({parentfeatureset:e[0],orderbyclause:t})}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"orderby",min:2,max:2}),a.functions.top=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,2,2,n,i),A(e[0]))return new Oe({parentfeatureset:e[0],topnum:e[1]});if(v(e[0]))return W(e[1])>=e[0].length?e[0].slice():e[0].slice(0,W(e[1]));if(z(e[0]))return W(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,W(e[1]));throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"top",min:2,max:2}),a.functions.first=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,1,1,n,i),A(e[0])){const t=await e[0].first(I.abortSignal);if(t!==null){const l=Pe.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return l._underlyingGraphic=t,l}return t}return v(e[0])?e[0].length===0?null:e[0][0]:z(e[0])?e[0].length()===0?null:e[0].get(0):null})},a.signatures.push({name:"first",min:1,max:1}),a.functions.attachments=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{x(e,1,2,n,i);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof j){if(e[1].hasField("minsize")&&(t.minsize=W(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=H(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=W(e[1].field("maxsize"))),e[1].hasField("types")){const l=ke(e[1].field("types"),!1);l.length>0&&(t.types=l)}}else if(e[1]!==null)throw new m(n,"InvalidParameter",i)}if(K(e[0])){const l=e[0]._layer;let o;if(A(l))o=l;else{if(l==null||!we(l))return[];o=J(l,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}return await o.load(),o.queryAttachments(e[0].field(o.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata)}if(e[0]===null)return[];throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"attachments",min:1,max:2}),a.functions.featuresetbyrelationshipname=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{x(e,2,4,n,i);const t=e[0],l=E(e[1]);let o=Z(e[2],null);const p=H(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new m(n,"InvalidParameter",i);if(e[0]===null)return null;if(!K(e[0]))throw new m(n,"InvalidParameter",i);const u=t._layer;let s;if(A(u))s=u;else{if(u==null||!we(u))return null;s=J(u,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}s=await s.load();const r=s.relationshipMetaData().filter(g=>g.name===l);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return ze(s,r[0],t.field(s.objectIdField),s.spatialReference,o,p,n.lrucache,n.interceptor);let f=s.serviceUrl();if(!f)return null;f=f.endsWith("/")?f+r[0].relatedTableId.toString():f+"/"+r[0].relatedTableId.toString();const c=await He(f,s.spatialReference,o,p,n.lrucache,n.interceptor);await c.load();let N=c.relationshipMetaData();if(N=N.filter(g=>g.id===r[0].id),t.hasField(r[0].keyField)===!1||t.field(r[0].keyField)===null){const g=await s.getFeatureByObjectId(t.field(s.objectIdField),[r[0].keyField]);if(g){const T=D.create(N[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:g.attributes[r[0].keyField]},c.filter(T)}return new Be({parentfeatureset:c})}const w=D.create(N[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return w.parameters={id:t.field(r[0].keyField)},c.filter(w)})},a.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),a.functions.featuresetbyassociation=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{x(e,2,3,n,i);const t=e[0],l=Ee(E(Z(e[1],""))),o=L(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!K(e[0]))throw new m(n,"InvalidParameter",i);let p=t._layer;if(p instanceof he&&(p=J(p,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),p===null||A(p)===!1)return null;await p.load();const u=p.serviceUrl(),s=await We(u,n.spatialReference,!0);if(s.unVersion>=8)return await Ye(p,t,l,o,s,n,i);const r=s.associations;let f=null,c=null,N=!1;if(o!==null&&o!==""&&o!==void 0){for(const b of s.terminals)b.terminalName===o&&(c=b.terminalId);c===null&&(N=!0)}const w=r.getFieldsIndex(),g=w.get("TOGLOBALID").name,T=w.get("FROMGLOBALID").name,P=w.get("TOTERMINALID").name,_=w.get("FROMTERMINALID").name,G=w.get("FROMNETWORKSOURCEID").name,B=w.get("TONETWORKSOURCEID").name,M=w.get("ASSOCIATIONTYPE").name,Fe=w.get("ISCONTENTVISIBLE").name,be=w.get("OBJECTID").name;for(const b of p.fields)if(b.type==="global-id"){f=t.field(b.name);break}let R=null,re=new O(new k({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),le=new O(new k({name:"side",alias:"side",type:"string"}),D.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const S="globalid",oe="globalId",se={};for(const b in s.lkp)se[b]=s.lkp[b].sourceId;const U=new Ve(new k({name:"classname",alias:"classname",type:"string"}),null,se);let h="";switch(l){case"midspan":{h=`((${g}='${f}') OR ( ${T}='${f}')) AND (${M} IN (5))`,U.codefield=D.create(`CASE WHEN (${g}='${f}') THEN ${G} ELSE ${B} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const b=te(C.findField(r.fields,T));b.name=S,b.alias=S,R=new O(b,D.create(`CASE WHEN (${T}='${f}') THEN ${g} ELSE ${T} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),re=s.unVersion>=4?new ne(C.findField(r.fields,w.get("PERCENTALONG").name)):new O(new k({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{h=`((${g}='${f}') OR ( ${T}='${f}')) AND (${M} IN (4,6))`,U.codefield=D.create(`CASE WHEN (${g}='${f}') THEN ${G} ELSE ${B} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const b=te(C.findField(r.fields,T));b.name=S,b.alias=S,R=new O(b,D.create(`CASE WHEN (${T}='${f}') THEN ${g} ELSE ${T} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),le=new O(new k({name:"side",alias:"side",type:"string"}),D.create(`CASE WHEN (${M}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let b=`${g}='@T'`,fe=`${T}='@T'`;c!==null&&(b+=` AND ${P}=@A`,fe+=` AND ${_}=@A`),h="(("+b+") OR ("+fe+"))",h=q(h,"@T",f??""),b=q(b,"@T",f??""),c!==null&&(b=q(b,"@A",c.toString()),h=q(h,"@A",c.toString())),U.codefield=D.create("CASE WHEN "+b+` THEN ${G} ELSE ${B} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const X=te(C.findField(r.fields,T));X.name=S,X.alias=S,R=new O(X,D.create("CASE WHEN "+b+` THEN ${T} ELSE ${g} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":h=`${g}='${f}' AND ${M} = 2`,c!==null&&(h+=` AND ${P} = `+c.toString()),U.codefield=G,h="( "+h+" )",R=new Q(C.findField(r.fields,T),S,S);break;case"content":h=`(${T}='${f}' AND ${M} = 2)`,c!==null&&(h+=` AND ${_} = `+c.toString()),U.codefield=B,h="( "+h+" )",R=new Q(C.findField(r.fields,g),S,S);break;case"structure":h=`(${g}='${f}' AND ${M} = 3)`,c!==null&&(h+=` AND ${P} = `+c.toString()),U.codefield=G,h="( "+h+" )",R=new Q(C.findField(r.fields,T),S,oe);break;case"attached":h=`(${T}='${f}' AND ${M} = 3)`,c!==null&&(h+=` AND ${_} = `+c.toString()),U.codefield=B,h="( "+h+" )",R=new Q(C.findField(r.fields,g),S,oe);break;default:throw new m(n,"InvalidParameter",i)}return N&&(h="1 <> 1"),new C({parentfeatureset:r,adaptedFields:[new ne(C.findField(r.fields,be)),new ne(C.findField(r.fields,Fe)),R,le,U,re],extraFilter:h?D.create(h,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},a.signatures.push({name:"featuresetbyassociation",min:2,max:6}),a.functions.groupby=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,3,3,n,i),!A(e[0]))throw new m(n,"InvalidParameter",i);const t=await e[0].load(),l=[],o=[];let p=!1,u=[];if(L(e[1]))u.push(e[1]);else if(e[1]instanceof j)u.push(e[1]);else if(v(e[1]))u=e[1];else{if(!z(e[1]))throw new m(n,"InvalidParameter",i);u=e[1].toArray()}for(const s of u)if(L(s)){const r=D.create(E(s),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),f=ye(r)===!0?E(s):"%%%%FIELDNAME";l.push({name:f,expression:r}),f==="%%%%FIELDNAME"&&(p=!0)}else{if(!(s instanceof j))throw new m(n,"InvalidParameter",i);{const r=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",f=s.hasField("expression")?s.field("expression"):"";if(r==="%%%%FIELDNAME"&&(p=!0),!r)throw new m(n,"InvalidParameter",i);l.push({name:r,expression:D.create(f||r,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(u=[],L(e[2]))u.push(e[2]);else if(v(e[2]))u=e[2];else if(z(e[2]))u=e[2].toArray();else{if(!(e[2]instanceof j))throw new m(n,"InvalidParameter",i);u.push(e[2])}for(const s of u){if(!(s instanceof j))throw new m(n,"InvalidParameter",i);{const r=s.hasField("name")?s.field("name"):"",f=s.hasField("statistic")?s.field("statistic"):"",c=s.hasField("expression")?s.field("expression"):"";if(!(r&&f&&L(f)&&c))throw new m(n,"InvalidParameter",i);o.push({name:r,statistic:f,expression:D.create(c,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(p){const s={};for(const f of t.fields)s[f.name.toLowerCase()]=1;for(const f of l)f.name!=="%%%%FIELDNAME"&&(s[f.name.toLowerCase()]=1);for(const f of o)f.name!=="%%%%FIELDNAME"&&(s[f.name.toLowerCase()]=1);let r=0;for(const f of l)if(f.name==="%%%%FIELDNAME"){for(;s["field_"+r.toString()]===1;)r++;s["field_"+r.toString()]=1,f.name="FIELD_"+r.toString()}}for(const s of l)ie(s.expression,a,n);for(const s of o)ie(s.expression,a,n);return e[0].groupby(l,o)})},a.signatures.push({name:"groupby",min:3,max:3}),a.functions.distinct=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(A(e[0])){x(e,2,2,n,i);const t=await e[0].load(),l=[];let o=[];if(L(e[1]))o.push(e[1]);else if(e[1]instanceof j)o.push(e[1]);else if(v(e[1]))o=e[1];else{if(!z(e[1]))throw new m(n,"InvalidParameter",i);o=e[1].toArray()}let p=!1;for(const u of o)if(L(u)){const s=D.create(E(u),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),r=ye(s)===!0?E(u):"%%%%FIELDNAME";l.push({name:r,expression:s}),r==="%%%%FIELDNAME"&&(p=!0)}else{if(!(u instanceof j))throw new m(n,"InvalidParameter",i);{const s=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",r=u.hasField("expression")?u.field("expression"):"";if(s==="%%%%FIELDNAME"&&(p=!0),!s)throw new m(n,"InvalidParameter",i);l.push({name:s,expression:D.create(r||s,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(p){const u={};for(const r of t.fields)u[r.name.toLowerCase()]=1;for(const r of l)r.name!=="%%%%FIELDNAME"&&(u[r.name.toLowerCase()]=1);let s=0;for(const r of l)if(r.name==="%%%%FIELDNAME"){for(;u["field_"+s.toString()]===1;)s++;u["field_"+s.toString()]=1,r.name="FIELD_"+s.toString()}}for(const u of l)ie(u.expression,a,n);return e[0].groupby(l,[])}return Qe(e)})},a.functions.getfeaturesetinfo=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,1,1,n,i),!A(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?j.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},ue(n),!1,!1):null})},a.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),a.functions.filterbysubtypecode=function(n,i){return a.standardFunctionAsync(n,i,async(I,F,e)=>{if(x(e,2,2,n,i),A(e[0])){const t=await e[0].load(),l=e[1];if(!Ne(l))throw new m(n,"InvalidParameter",i);if(t.subtypeField){const p=D.create(`${t.subtypeField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ee({parentfeatureset:e[0],whereclause:p})}if(t.typeIdField===null||t.typeIdField==="")throw new m(n,"FeatureSetDoesNotHaveSubtypes",i);const o=D.create(`${t.typeIdField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ee({parentfeatureset:e[0],whereclause:o})}throw new m(n,"InvalidParameter",i)})},a.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{bn as registerFunctions};
