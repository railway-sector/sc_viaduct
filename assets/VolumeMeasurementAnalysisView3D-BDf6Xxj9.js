import{cH as b,cV as J,dq as y,ce as mt,lB as gt,m6 as ye,m8 as fe,dp as me,Ib as Ht,nT as _t,n,p as u,u as M,e as zt,Ic as ae,uV as Ut,Id as yt,HP as qt,FA as It,F9 as Y,vM as ee,Hh as Fe,Hi as Bt,Fk as B,Fh as A,Fl as te,Fm as ie,_ as se,Ho as Pe,Fn as re,Fs as oe,oK as ft,g$ as Nt,km as H,Fb as Wt,Ie as Qt,Hg as Se,v$ as vt,FS as Xt,If as Kt,FW as Zt,Hp as wt,HK as bt,Hq as ge,aR as Jt,ma as I,la as q,l7 as Yt,v9 as De,pG as ei,Ig as ti,hr as Ct,l8 as Vt,js as xt,sZ as Ft,cS as Pt,cT as D,ad as w,gO as ii,d8 as N,d4 as $t,lz as si,b3 as ri,eF as Tt,dy as ve,dz as we,dv as be,kR as Rt,l2 as Gt,fz as $e,il as oi,d5 as P,uq as ni,ht as ai,Ga as li,yl as je,sT as ui,Fj as ci,Gd as hi,FQ as di,FP as pi,t6 as mi,HJ as gi,Ih as Ee,t5 as _i,Ii as ke,Ij as le,Ha as _e,HL as yi,eI as fi,yt as vi,G as wi,tj as Ae,bJ as He,yu as ze,i7 as W,eG as K,i6 as Ue,v2 as bi,H2 as Ci,ii as qe,ys as Vi,yb as Ce,v4 as xi,qQ as Ie,iU as ue,og as Fi,sH as Pi,CL as $i,eY as Ti,mS as Be,i$ as Ve,gN as Ne,cW as Ri,d7 as We,hm as Gi,bg as Mi,ym as Oi,dh as Qe}from"./index-Dqeu25xh.js";import{e as Li}from"./AnalysisView3D-ixIIQPp7.js";import{e as Mt}from"./earcut-D9gy186-.js";import{a as Si,p as ce,w as Di}from"./ShadedColorMaterial.glsl-BIf2VFf-.js";import{r as xe,X as ji}from"./Graphics3DExtrudeSymbolLayer-By6gnz43.js";import{F as Xe,R as Ke}from"./euclideanLengthMeasurementUtils-DsSYAwvk.js";import{f as Ze,m as Ei}from"./Segment-T5fEuIOj.js";import{R as Je}from"./OutlineVisualElement-Dz-y7eaK.js";import{h as ki}from"./lineStippleUtils-CCavR4OV.js";import{n as Ai}from"./GraphicsLayer-CLescf7g.js";import{_ as Hi,S as zi}from"./SlicePlaneMaterial.glsl-Hc01QpSA.js";import{T as Ui}from"./dragEventPipeline3D-BfQR8AQ0.js";import{r as qi,p as Ii,j as Bi}from"./InteractiveToolBase-FrXzbC5J.js";import{l as Ot,a as Ye}from"./SketchOptions-CZ5FNx2S.js";import{r as Ni,R as Wi,H as Qi}from"./SketchTooltipInfo-BQMaGrvD.js";import{h as Xi}from"./TooltipInfoWithCoordinates-CtXGffzq.js";import{s as Ki}from"./ExclusiveOperationManager-kpylPjlZ.js";import{a as Zi}from"./allLayerSnapping-D98Wqhpf.js";import{d as Ji}from"./SketchViewModel-peohQBdl.js";import"./AnalysisView-D2hl6qUU.js";import"./VisualElement-DRPn_oYO.js";import"./line-k_ehIwcE.js";import"./ColorMaterial.glsl-DlmBUqka.js";import"./TriangleMaterial-DbRxUlrk.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-IOR__TQb.js";import"./triangulationUtils-ClgSV8j-.js";import"./deduplicate-BMr5G7Rm.js";import"./geometry2dUtils-C2B4NjSX.js";import"./SnappingManager-DEgPRx55.js";import"./geodeticLengthOperator-B6neOLu-.js";import"./geodeticCurveType-CirnHLSB.js";import"./TextOverlayItem-BMgG5hh3.js";import"./EngineVisualElement-DPku0b7r.js";import"./LaserlinePath.glsl-Bbcm0W9T.js";import"./line-q1Sfkgv3.js";import"./sliceToolConfig-DLenlu20.js";import"./SlicePlane-DxdFgKJV.js";import"./DefaultLayouts-juzw26H5.js";import"./EditGeometryOperations-D7DPjg8h.js";import"./rotate-VZ_1_9rA.js";import"./curveOperationUtils-CeaEXbm6.js";import"./angularMeasurementUtils-C2faDVPI.js";import"./isSupportedObject-BflEdBjV.js";import"./automaticAreaMeasurementUtils-mmnzggTB.js";import"./geodesicAreaMeasurementUtils-ZJga7rDi.js";import"./automaticLengthMeasurementUtils-X3ho6kxi.js";const et=new b("black");let Yi=class{constructor(){this.geometryOutlineWidth=1.5,this.geometryOutlineColor=new b("rgb(128,128,128)"),this.cutColor=new b("rgba(153, 198, 111, 0.75)"),this.fillColor=new b("rgba(200, 200, 230, 0.75)"),this.cutColorMuted=new b("rgba(176, 176, 176, 0.75)"),this.fillColorMuted=new b("rgba(194, 194, 194, 0.75)"),this.cutProjectionLineColor=b.blendColors(this.cutColor,et,.4),this.fillProjectionLineColor=b.blendColors(this.fillColor,et,.4),this.projectionLineWidth=2,this.projectionLineStippleSize=4,this.labelDistance=40,this.labelPrecisions={"cubic-millimeters":0,"cubic-centimeters":0,"cubic-decimeters":1,"cubic-meters":2,"cubic-kilometers":6,"cubic-inches":0,"cubic-feet":2,"cubic-yards":2,"cubic-miles":6,liters:2},this.maxVolumeExtentSizeVw=.7,this.minVolumeExtentSizePixels=250,this.minTargetElevation=-11e3,this.maxTargetElevation=9e3,this.targetElevationRange=this.maxTargetElevation-this.minTargetElevation,this.maxPerimeterLocalWebMercator=1e4,this.maxPerimeterGlobal=5e4}};const G=new Yi;let V=class extends J{constructor(e){super(e),this.rawResult=null}get localOriginRenderSpace(){const{extent:e,localOrigin:i,renderCoordsHelper:s}=this,r=y();return s.toRenderCoords(i,e.spatialReference,r),r}get cameraPositionRenderSpace(){const{localOriginRenderSpace:e,renderCoordsHelper:i}=this,s=y(),r=1/i.unitInMeters;return i.setAltitude(s,ts*r,e),s}get boundingRect(){const{extent:e,renderCoordsHelper:i}=this,s=mt();return i.viewingMode===2?gt(e,s):(this._expandBoundingRect(e.xmin,e.ymin,s),this._expandBoundingRect(e.xmax,e.ymin,s),this._expandBoundingRect(e.xmin,e.ymax,s),this._expandBoundingRect(e.xmax,e.ymax,s)),s}get cameraDimensions(){const{boundingRect:e}=this;return{width:fe(e),height:ye(e)}}get cameraNearFar(){const{renderCoordsHelper:{unitInMeters:e}}=this,i=1/e;return{near:is*i,far:ss*i}}get upVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,2,y())}get northVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,1,y())}get eastVector(){return this.renderCoordsHelper.worldBasisAtPosition(this.cameraPositionRenderSpace,0,y())}_expandBoundingRect(e,i,s){const{extent:r,eastVector:l,northVector:a,upVector:c,renderCoordsHelper:h}=this,d=r.center.z??0;me(he,e,i,d),h.toRenderCoords(he,r.spatialReference,he),Ht(he,l,a,c,tt),_t(s,tt,s)}};n([u()],V.prototype,"renderCoordsHelper",void 0),n([u()],V.prototype,"extent",void 0),n([u()],V.prototype,"localOrigin",void 0),n([u()],V.prototype,"localOriginRenderSpace",null),n([u()],V.prototype,"cameraPositionRenderSpace",null),n([u()],V.prototype,"boundingRect",null),n([u()],V.prototype,"cameraDimensions",null),n([u()],V.prototype,"upVector",null),n([u()],V.prototype,"northVector",null),n([u()],V.prototype,"eastVector",null),n([u()],V.prototype,"rawResult",void 0),V=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillComputation")],V);const he=y(),tt=y(),es=100,ts=G.maxTargetElevation,is=0,ss=G.targetElevationRange+es;let ne=class extends zt{constructor(e,i,s){super(e,i,s),this.name="unknown",this.name=e}};class it extends ne{constructor(){super("perimeter-too-large","The input geometry's perimeter is too large for the current viewing mode and spatial reference.")}}let rs=class extends ne{constructor(){super("distance-too-far","The measurement geometry is too far from the camera.")}},os=class extends ne{constructor(){super("distance-too-close","The measurement geometry is too close to the camera.")}};class ns extends ne{constructor(){super("unsupported-coordinate-system","The coordinate system of the view (viewing mode and spatial reference) is not supported.")}}let as=class extends ne{constructor(){super("unsupported-layer-transparency","The volume measurement analysis does not support transparent layers.")}};function ls(t,e,i="cubic-meters"){const s=t-e,r=t+e;return{cutVolume:ae(t,i),fillVolume:ae(e,i),netVolume:ae(s,i),totalVolume:ae(r,i)}}function de(t,e){return t?Ut(t,yt(t.value,t.unit,e)):null}let T=class extends J{constructor(e){super(e)}get cutVolume(){return de(this.rawResult.cutVolume,this.unit)}get fillVolume(){return de(this.rawResult.fillVolume,this.unit)}get netVolume(){return de(this.rawResult.netVolume,this.unit)}get totalVolume(){return de(this.rawResult.totalVolume,this.unit)}};n([u({constructOnly:!0})],T.prototype,"measureType",void 0),n([u()],T.prototype,"cutVolume",null),n([u()],T.prototype,"fillVolume",null),n([u()],T.prototype,"netVolume",null),n([u()],T.prototype,"totalVolume",null),n([u({constructOnly:!0})],T.prototype,"rawResult",void 0),n([u({constructOnly:!0})],T.prototype,"unit",void 0),T=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementResult")],T);class Lt extends qt{constructor(){super(...arguments),this.output=0}}n([It({count:11})],Lt.prototype,"output",void 0);let Te=class extends Y{};function St(){const t=new ee;return t.include(Fe),t.fragment.include(Bt),t.fragment.uniforms.add(new B("cutFillReferenceDepthTexture",e=>e.referenceDepthTexture),new B("cutFillTargetDepthTexture",e=>e.targetDepthTexture)),t.fragment.code.add(A`bool outsideFar(float depth) {
return depth >= 1.0;
}`),t.fragment.main.add(A`float referenceDepth = depthFromTexture(cutFillReferenceDepthTexture, uv);
float targetDepth = depthFromTexture(cutFillTargetDepthTexture, uv);
if (outsideFar(targetDepth)) {
discard;
}
float depth = referenceDepth - targetDepth;
float cut = min(0.0, depth);
float fill = max(0.0, depth);
fragColor = vec4(cut, fill, 0.0, 0.0);`),t}const us=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:St},Symbol.toStringTag,{value:"Module"}));let st=class extends te{constructor(e,i){super(e,i,new ie(us,()=>se(()=>Promise.resolve().then(()=>$s),void 0)),Pe)}initializePipeline(){return re({colorWrite:oe})}},Re=class extends Y{};function Dt(){const t=new ee;return t.include(Fe),t.fragment.uniforms.add(new B("cutFillDepthTexture",e=>e.depthTexture)),t.fragment.main.add(A`ivec2 iuv = ivec2(gl_FragCoord.xy) * 2;
vec2 sum = vec2(0.0);
for (int dx = 0; dx < 2; dx++) {
for (int dy = 0; dy < 2; dy++) {
sum += texelFetch(cutFillDepthTexture, iuv + ivec2(dx, dy), 0).rg;
}
}
fragColor = vec4(sum.r, sum.g, 0.0, 0.0);`),t}const cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:Dt},Symbol.toStringTag,{value:"Module"}));class rt extends te{constructor(e,i){super(e,i,new ie(cs,()=>se(()=>Promise.resolve().then(()=>Ts),void 0)),Pe)}initializePipeline(){return re({colorWrite:oe})}}let Ge=class extends Y{constructor(){super(...arguments),this.origin=ft,this.cutFillCamera={projectionMatrix:H(),viewMatrix:H(),nearFar:Nt()}}};function jt(t){const e=new ee,{vertex:i,fragment:s,varyings:r,attributes:l}=e;return e.include(Wt),e.include(Qt,t),l.add("position","vec3"),r.add("depth","float",{invariant:!0}),i.uniforms.add(new Se("proj",a=>a.cutFillCamera.projectionMatrix),new Se("view",a=>vt(hs,a.cutFillCamera.viewMatrix,a.origin)),new Xt("nearFar",a=>a.cutFillCamera.nearFar)),i.main.add(A`gl_Position = transformPositionWithDepth(proj, view, position, nearFar, depth);`),s.main.add(A`fragColor = vec4(1.0);
outputDepth(depth);`),e}const hs=H(),ds=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:jt},Symbol.toStringTag,{value:"Module"}));let ot=class extends te{constructor(e,i){super(e,i,new ie(ds,()=>se(()=>Promise.resolve().then(()=>Rs),void 0)),Kt)}initializePipeline(){return re({colorWrite:oe,depthWrite:Zt,depthTest:{func:519}})}},j=class extends wt{constructor(e){super(e),this.consumes={required:[bt.TRANSPARENT]},this.produces=ge.CUTFILL_DEPTH,this._cutFillTargetDepthConfiguration=new Lt,this._cutFillTargetDepthParameters=new Ge,this._cutFillDepthParameters=new Te,this._cutFillReductionParameters=new Re,this.needsRender=!1,this.done=!0,this._localOrigin=y(),this._maxTextureSize=4096,this._width=0,this._height=0,this._reducedWidth=0,this._reducedHeight=0,this._depthFormat=13,this._colorFormat=10,this._targetVao=null}initialize(){this._maxTextureSize=Math.min(Jt("esri-mobile")?1024:this._maxTextureSize,this.fboCache.rctx.parameters.maxTextureSize),this._cutFillTargetDepthConfiguration.output=8}destroy(){this._targetVao=I(this._targetVao)}precompile(){this.techniques.precompile(ot,this._cutFillTargetDepthConfiguration),this.techniques.precompile(st),this.techniques.precompile(rt),this.view.stage.renderer.precompileCutFill()}render(e){const i=e.find(({name:C})=>C===ge.CUTFILL_DEPTH);if(!this._orthographicCamera||!this._targetVao||!this.needsRender)return i;const s=this.techniques.get(ot,this._cutFillTargetDepthConfiguration),r=this.techniques.get(st),l=this.techniques.get(rt);if(!s.compiled||!r.compiled||!l.compiled)return this.requestRender(1),i;this.needsRender=!1;const a=this.renderingContext,c=this.fboCache,h=a.getViewport(),d=c.acquire(this._width,this._height,"cutfill reference depth",this._depthFormat);a.bindFramebuffer(d.fbo),a.setViewport(0,0,this._width,this._height),a.clear(1280),this.view.stage.renderer.renderCutFillReferenceDepth(this._orthographicCamera);const o=c.acquire(this._width,this._height,"cutfill target depth",this._depthFormat);a.bindFramebuffer(o.fbo),a.setViewport(0,0,this._width,this._height),a.setClearDepth(1),a.clear(256),this._cutFillTargetDepthParameters.origin=this._localOrigin,this._cutFillTargetDepthParameters.cutFillCamera=this._orthographicCamera,a.bindTechnique(s,this.bindParameters,this._cutFillTargetDepthParameters),a.bindVAO(this._targetVao),a.drawArrays(q.TRIANGLES,0,this._targetVao.vertexCount("geometry"));let p=c.acquire(this._width,this._height,"cutfill reduction even",this._colorFormat),m=c.acquire(this._width,this._height,"cutfill reduction odd",this._colorFormat);this._cutFillDepthParameters.referenceDepthTexture=d.depthTexture,this._cutFillDepthParameters.targetDepthTexture=o.depthTexture,a.bindFramebuffer(p.fbo),a.bindTechnique(r,this.bindParameters,this._cutFillDepthParameters),a.setClearColor(0,0,0,0),a.clear(16384),a.screen.draw(),d.release(),o.release();let f=this._width,v=this._height;const _=Math.ceil(Math.log2(Math.min(f,v)));for(let C=0;C<_;C++)f=Math.ceil(f/2),v=Math.ceil(v/2),this._cutFillReductionParameters.depthTexture=p.getTexture(),this._prepareFBO(m,f,v),a.bindTechnique(l,this.bindParameters,this._cutFillReductionParameters),a.screen.draw(),[p,m]=[m,p];return this._buffer=new Float32Array(f*v*2),p.fbo?.readPixels(0,0,f,v,33319,Yt.FLOAT,this._buffer),this._reducedWidth=f,this._reducedHeight=v,p.release(),m.release(),a.setViewport(h.x,h.y,h.width,h.height),this.done=!0,i}setup(e,i){const s=this.renderingContext,{cameraDimensions:{width:r,height:l},localOriginRenderSpace:a}=e,c=this._maxTextureSize,h=l/r,d=r>l?c:c/h,o=r>l?c*h:c;this._width=De(d),this._height=De(o);const p=[this._width,this._height];this._orthographicCamera=this._createCamera(e,p),this._targetVao=I(this._targetVao),this._targetVao=ps(s,i),this._localOrigin=a,this.done=!1}start(){this._width!==0&&this._height!==0&&(this.needsRender=!0)}getDepth(){let e=0,i=0;for(let s=0;s<this._reducedWidth;s++)for(let r=0;r<this._reducedHeight;r++){const l=s+r*this._reducedHeight;e+=this._buffer?.[2*l]??0,i+=this._buffer?.[2*l+1]??0}return{cut:e,fill:i}}get width(){return this._width}get height(){return this._height}get updating(){return this.needsRender||!this.done}_prepareFBO(e,i,s){const r=this.renderingContext;r.bindFramebuffer(e.fbo),r.setViewport(0,0,i,s),r.setClearColor(0,0,0,0),r.clear(16384)}_createCamera(e,i){const{cameraPositionRenderSpace:s,localOriginRenderSpace:r,northVector:l,cameraDimensions:{width:a,height:c},cameraNearFar:{near:h,far:d}}=e,o=new ei({eye:s,center:r,up:l,near:h,far:d});return o.viewport=[0,0,i[0],i[1]],ti(o.projectionMatrix,-a/2,a/2,-c/2,c/2,h,d),o}};n([u()],j.prototype,"consumes",void 0),n([u()],j.prototype,"produces",void 0),n([u()],j.prototype,"needsRender",void 0),n([u()],j.prototype,"done",void 0),n([u()],j.prototype,"updating",null),j=n([M("esri.views.3d.webgl-engine.lib.CutFillDepth")],j);const nt=Ct().vec3f("position").freeze();function ps(t,e){const{positions:i,indices:s}=e,r=nt.createBuffer(s.length),l=r.position;for(let c=0;c<s.length;++c){const h=3*s[c];l.set(c,0,i[h]),l.set(c,1,i[h+1]),l.set(c,2,i[h+2])}const a=new Vt(t,xt(nt),r.buffer);return new Ft(t,a)}let ms=class{constructor(e,i){this.positions=e,this.indices=i}},g=class extends J{constructor(t){super(t),this._getElevationProvider=()=>this.view.elevationProvider,this._updatingHandles=new Pt,this._computationValue=null}initialize(){const t=this.view;this._renderer=new j({view:t}),this._updatingHandles.add(()=>({computation:this._computation,renderGeometry:this._targetGeometryRenderInfo}),({computation:e,renderGeometry:i})=>{e&&i&&(this._renderer.setup(e,i),this._renderer.start())},D),this.addHandles([this._createElevationUpdateHandle(),w(()=>this._targetGeometry,e=>this.analysisViewData.targetGeometry=e,N),w(()=>this._elevationAlignedGeometry,e=>this.analysisViewData.elevationAlignedGeometry=e,N),w(()=>({computation:this._computation,extent:this._projectedGeometry?.extent,localOrigin:this._localOrigin}),({computation:e,extent:i,localOrigin:s})=>{e&&i&&s&&(e.extent=i,e.localOrigin=s)},$t),ii(()=>this._renderer.done,()=>this._updateResult())])}destroy(){this._updatingHandles.destroy(),this._renderer.destroy()}get _projectedGeometry(){if(!this.analysis.valid)return null;const t=this.analysis.geometry,e=si(t,this.view.spatialReference);return e.pending?(this._updatingHandles.addPromise(e.pending),null):(t&&!e.geometry&&Si(this.analysis,t.spatialReference,ri.getLogger(this)),e.geometry)}get _localOrigin(){const t=this._projectedGeometry?.extent;return t?Tt(t.center.x,t.center.y,0):null}get _elevationAlignedGeometry(){const t=this._projectedGeometry;if(!t)return null;const e=t.clone();return gs(this._getElevationProvider(),e),e}get _targetGeometry(){const t=this._elevationAlignedGeometry;if(!t)return null;const e=this.analysis.measureType,{effectiveTargetElevation:i}=this.analysisViewData;if(e==="stockpile"||i==null)return t;const s=t.clone();return s.rings[0].forEach(r=>r[2]=i),s}get _targetGeometryRenderInfo(){const t=this._targetGeometry,e=this._projectedGeometry?.extent,i=this._localOrigin;if(!t||!e||!i)return null;const{elevationProvider:s,renderCoordsHelper:r}=this.view,l=xe(t,s,r,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:a}=l,c=a[0],h=Mt(c.position,c.holeIndices,3),d=be(3*c.count),o=H(),p=H();return Rt(e.spatialReference,i,o,r.spatialReference),p[12]=-o[12],p[13]=-o[13],p[14]=-o[14],Gt(d,c.position,p),new ms(d,h)}get updating(){return this._renderer.updating||this._updatingHandles.updating}get result(){const t=this._computation?.rawResult;return t?new T({measureType:this.analysis.measureType,rawResult:t,unit:this.analysisViewData.effectiveDisplayUnits.volume}):null}get error(){return this._unsupportedCoordinateSystemError??this._unsupportedLayerTransparencyError??this._perimeterTooLargeError??this._tooNearFarError}get _tooNearFarError(){const t=this._elevationAlignedGeometry;if(!t)return null;const{view:e}=this,{elevationProvider:i,renderCoordsHelper:s}=e,{camera:r}=e.state,l=xe(t,i,s,ve.fromElevationInfo(new we({mode:"absolute-height"}))),{polygons:a}=l,c=a[0].position;$e(Q);for(let m=0;m<c.length;m+=3)r.projectToScreen(me(vs,c[m],c[m+1],c[m+2]),ut),_t(Q,ut,Q);const h=fe(Q),d=ye(Q),{maxVolumeExtentSizeVw:o,minVolumeExtentSizePixels:p}=G;return h>r.width/r.pixelRatio*o||d>r.height/r.pixelRatio*o?new os:Math.max(h,d)<p?new rs:null}get _perimeterTooLargeError(){return this._perimeterTooLargeLocalError??this._perimeterTooLargeGlobalError}get _perimeterTooLargeLocalError(){const{spatialReference:t,state:{isLocal:e}}=this.view;if(!e||!t.isWebMercator)return null;const i=this._perimeter,{maxPerimeterLocalWebMercator:s}=G;return i!=null&&i>s?new it:null}get _perimeterTooLargeGlobalError(){if(!this.view.state.isGlobal)return null;const t=this._perimeter,{maxPerimeterGlobal:e}=G;return t!=null&&t>e?new it:null}get _unsupportedCoordinateSystemError(){return this.view.state.isLocal&&this.view.spatialReference.isGeographic?new ns:null}get _unsupportedLayerTransparencyError(){return(this.view.map?.ground.opacity??1)<1?new as:null}get _perimeter(){const t=this._targetGeometryRenderInfo?.positions,e=t?ys(fs(t)):null;return e!=null?e/this.view.renderCoordsHelper.unitInMeters:null}get _enabled(){return!this.error}get _computation(){const t=this._projectedGeometry?.extent;if(!t||!this._enabled)return this._computationValue=P(this._computationValue),null;if(this._computationValue)return this._computationValue;const e=this._localOrigin;if(!e)return null;const{renderCoordsHelper:i}=this.view;return this._computationValue=new V({extent:t,localOrigin:e,renderCoordsHelper:i}),this._computationValue}_createElevationUpdateHandle(){const t=e=>{const i=this._projectedGeometry?.extent;e.context==="ground"&&i&&(ni(e.extent,e.spatialReference,at,this.view.spatialReference),gt(i,lt),ai(at,lt)&&(this._getElevationProvider=()=>this.view.elevationProvider))};return this.view.elevationProvider.on("elevation-change",e=>t(e))}_updateResult(){if(!this._computation)return;const{spatialReference:t,viewingMode:e}=this.view,{extent:i,boundingRect:s,cameraNearFar:{near:r,far:l}}=this._computation,{width:a,height:c}=this._renderer;let h,d;e==="local"&&t.isWebMercator?{width:h,height:d}=_s(i):(h=fe(s),d=ye(s));const o=h/a*(d/c),p=this._renderer.getDepth(),m=_=>_*(l-r)+r,f=m(p.cut)*o,v=m(p.fill)*o;this._computation.rawResult=ls(Math.abs(f),v)}};function gs(t,e){e.rings[0].forEach(i=>{i[2]=li(t,i,"ground")??0})}function _s(t){const e=Xe([t.xmin,t.ymin,0],[t.xmax,t.ymin,0],t.spatialReference),i=Xe([t.xmin,t.ymin,0],[t.xmin,t.ymax,0],t.spatialReference);return{width:e?.value??0,height:i?.value??0}}function ys(t){if(!t)return null;let e=null,i=null,s=0;for(const r of t)e||(e=[r[0],r[1],r[2]??0]),i?s+=je(i,r):i=[0,0,0],i[0]=r[0],i[1]=r[1],i[2]=r[2];return e&&i&&(s+=je(i,e)),Math.sqrt(s)}function*fs(t){const e=y();for(let i=0;i<t.length;i+=3)e[0]=t[i],e[1]=t[i+1],e[2]=t[i+2],yield e}n([u()],g.prototype,"_projectedGeometry",null),n([u()],g.prototype,"_localOrigin",null),n([u()],g.prototype,"_getElevationProvider",void 0),n([u()],g.prototype,"_elevationAlignedGeometry",null),n([u()],g.prototype,"_targetGeometry",null),n([u()],g.prototype,"_targetGeometryRenderInfo",null),n([u({constructOnly:!0})],g.prototype,"analysis",void 0),n([u({constructOnly:!0})],g.prototype,"analysisViewData",void 0),n([u({constructOnly:!0})],g.prototype,"view",void 0),n([u()],g.prototype,"updating",null),n([u()],g.prototype,"result",null),n([u()],g.prototype,"error",null),n([u()],g.prototype,"_tooNearFarError",null),n([u()],g.prototype,"_perimeterTooLargeError",null),n([u()],g.prototype,"_perimeterTooLargeLocalError",null),n([u()],g.prototype,"_perimeterTooLargeGlobalError",null),n([u()],g.prototype,"_unsupportedCoordinateSystemError",null),n([u()],g.prototype,"_unsupportedLayerTransparencyError",null),n([u()],g.prototype,"_perimeter",null),n([u()],g.prototype,"_enabled",null),n([u()],g.prototype,"_renderer",void 0),n([u({readOnly:!0})],g.prototype,"_updatingHandles",void 0),n([u()],g.prototype,"_computation",null),g=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillController")],g);const at=$e(),lt=$e(),vs=y(),Q=mt(),ut=oi();let Me=class extends Y{constructor(){super(...arguments),this.borderColor=ui()}};function Et(){const t=new ee;return t.include(Fe),t.outputs.add("fragColor","vec4",0),t.fragment.uniforms.add(new B("colorTexture",e=>e.color),new B("cutFillVolumes",e=>e.cutFillVolumes),new B("cutFillMask",e=>e.cutFillMask),new ci("pixelRatio",(e,i)=>i.camera.pixelRatio),new hi("borderColor",e=>e.borderColor)).main.add(A`vec4 color = texture(colorTexture, uv, 0.0);
vec4 volumesColor = texture(cutFillVolumes, uv, 0.0);
ivec2 iuv = ivec2(uv * vec2(textureSize(cutFillMask, 0)));
vec2 m0 = texelFetch(cutFillMask, iuv, 0).rg;
vec2 m1 = texelFetch(cutFillMask, iuv + ivec2(-1, 0), 0).rg;
vec2 m2 = texelFetch(cutFillMask, iuv + ivec2(1, 0), 0).rg;
vec2 m3 = texelFetch(cutFillMask, iuv + ivec2(0, -1), 0).rg;
vec2 m4 = texelFetch(cutFillMask, iuv + ivec2(0, 1), 0).rg;
float d = (
step(1.5, abs(m0.r - m1.r) + abs(m0.g - m1.g))
+ step(1.5, abs(m0.r - m2.r) + abs(m0.g - m2.g))
+ step(1.5, abs(m0.r - m3.r) + abs(m0.g - m3.g))
+ step(1.5, abs(m0.r - m4.r) + abs(m0.g - m4.g))
) * 0.25 * pixelRatio;
vec4 base = mix(color, volumesColor, max(m0.r, m0.g) * volumesColor.a);
fragColor = mix(base, borderColor, d);`),t}const ws=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:Et},Symbol.toStringTag,{value:"Module"}));let ct=class extends te{constructor(e,i){super(e,i,new ie(ws,()=>se(()=>Promise.resolve().then(()=>Gs),void 0)),Pe)}initializePipeline(){return re({colorWrite:oe})}};class Oe extends Y{constructor(){super(...arguments),this.origin=ft}}function kt(){const t=new ee;return t.attributes.add("position","vec3"),t.outputs.add("fragColor","vec4",0),t.vertex.uniforms.add(new di("proj",e=>e.camera.projectionMatrix),new pi("view",(e,i)=>vt(bs,i.camera.viewMatrix,e.origin))).main.add(A`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),t.fragment.main.add(A`fragColor = vec4(1, 1, 0, 0);`),t}const bs=H(),Cs=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));class ht extends te{constructor(e,i){super(e,i,new ie(Cs,()=>se(()=>Promise.resolve().then(()=>Ms),void 0)),mi(gi))}initializePipeline(){return re({colorWrite:oe,depthTest:{func:515}})}}let E=class extends wt{constructor(t){super(t),this.consumes={required:[bt.OPAQUE]},this.produces=ge.CUTFILL_COLOR,this._vaoCut=null,this._vaoFill=null,this._countCut=0,this._countFill=0,this._maskParameters=new Oe,this._cutVolumeParameters=new Ee,this._fillVolumeParameters=new Ee,this._compositeParameters=new Me,this._drawParameters=new _i;const e=t.view.state.viewingMode===1;this._cutVolumeTechniqueConfiguration=new ke(e),this._cutVolumeTechniqueConfiguration.customDepthTest=2,this._cutVolumeTechniqueConfiguration.writeDepth=!1,this._cutVolumeTechniqueConfiguration.cullFace=1,this._cutVolumeTechniqueConfiguration.doubleSidedMode=1,this._fillVolumeTechniqueConfiguration=new ke(e),this._fillVolumeTechniqueConfiguration.cullFace=2}initialize(){this.addHandles([w(()=>[this.cutColor,this.fillColor],()=>this._updateColors(),N)])}destroy(){this._vaoCut=I(this._vaoCut),this._vaoFill=I(this._vaoFill)}precompile(){this.techniques.precompile(le,this._cutVolumeTechniqueConfiguration),this.techniques.precompile(le,this._fillVolumeTechniqueConfiguration),this.techniques.precompile(ht),this.techniques.precompile(ct)}render(t){const e=this.techniques.get(le,this._cutVolumeTechniqueConfiguration),i=this.techniques.get(le,this._fillVolumeTechniqueConfiguration),s=this.techniques.get(ht),r=this.techniques.get(ct),l=t.find(({name:_})=>_===this.produces);if(!this._vaoCut||!this._vaoFill)return l;if(!(e&&i&&s.compiled&&r.compiled))return this.requestRender(1),l;const a=this.bindParameters,c=a.camera,h=c.fullViewport[2],d=c.fullViewport[3],o=this.renderingContext,p=this.fboCache,m=p.acquire(h,d,"cutfill color mask",2);m.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(m.fbo),o.setClearColor(0,0,0,1),o.clear(17408),o.setViewport(0,0,h,d),o.bindTechnique(s,a,yi,this._maskParameters),o.setFaceCullingEnabled(!1),o.setStencilTestEnabled(!0),o.setStencilOpSeparate(1028,7680,34055,7680),o.setStencilOpSeparate(1029,7680,34056,7680),o.setDepthWriteEnabled(!1),o.bindVAO(this._vaoCut),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!1,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countCut),o.setDepthTestEnabled(!1),o.setStencilWriteMask(0),o.setStencilFunction(517,0,255),o.setColorMask(!0,!1,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countCut),o.bindVAO(this._vaoFill),o.setDepthTestEnabled(!0),o.setStencilWriteMask(255),o.setStencilFunction(519,0,255),o.setColorMask(!1,!0,!1,!1),o.drawArrays(q.TRIANGLES,0,this._countFill);const f=p.acquire(h,d,"cutfill color volumes",5);f.attachDepth(l.getAttachment(_e)),o.bindFramebuffer(f.fbo),o.setClearColor(0,0,0,0),o.clear(16384),o.setColorMask(!0,!0,!0,!0),o.bindTechnique(e,this.bindParameters,this._cutVolumeParameters,this._drawParameters),o.setPolygonOffset(1,1),o.setPolygonOffsetFillEnabled(!0),o.bindVAO(this._vaoCut),o.drawArrays(q.TRIANGLES,0,this._countCut),o.bindTechnique(i,this.bindParameters,this._fillVolumeParameters,this._drawParameters),o.setPolygonOffset(0,0),o.setPolygonOffsetFillEnabled(!1),o.bindVAO(this._vaoFill),o.drawArrays(q.TRIANGLES,0,this._countFill);const v=this.fboCache.acquire(h,d,this.produces);return o.bindFramebuffer(v.fbo),this._compositeParameters.color=l.getTexture(),this._compositeParameters.cutFillVolumes=f.getTexture(),this._compositeParameters.cutFillMask=m.getTexture(),b.toUnitRGBA(this.borderColor,this._compositeParameters.borderColor),o.bindTechnique(r,a,this._compositeParameters),o.screen.draw(),m.release(),f.release(),v.attachDepth(l.getAttachment(_e)),v}enable(){this.produces=ge.CUTFILL_COLOR,this.requestRender(1)}disable(){this.produces="disabled",this.requestRender(1)}updateGeometries(t,e,i){this._vaoCut=I(this._vaoCut),this._vaoCut=this._createVao(t),this._countCut=t.indicesBottom.length+t.indicesExtruded.length,this._vaoFill=I(this._vaoFill),this._vaoFill=this._createVao(e),this._countFill=e.indicesBottom.length+e.indicesExtruded.length,this._maskParameters.origin=i,fi(this._drawParameters.origin,i),this.requestRender(1)}_updateColors(){this._cutVolumeParameters.diffuse=b.toUnitRGB(this.cutColor),this._cutVolumeParameters.opacity=this.cutColor.a,this._fillVolumeParameters.diffuse=b.toUnitRGB(this.fillColor),this._fillVolumeParameters.opacity=this.fillColor.a,this.requestRender(1)}_createVao(t){const e=this.renderingContext,{vertices:i,normals:s,indicesBottom:r,indicesExtruded:l}=t,a=dt.createBuffer(r.length+l.length),{position:c,normal:h}=a;for(let o=0;o<r.length;o++){const p=3*r[o];c.set(o,0,i[p]),c.set(o,1,i[p+1]),c.set(o,2,i[p+2]),h.set(o,0,s[p]),h.set(o,1,s[p+1]),h.set(o,2,s[p+2])}for(let o=0;o<l.length;o++){const p=o+r.length,m=3*l[o];c.set(p,0,i[m]),c.set(p,1,i[m+1]),c.set(p,2,i[m+2]),h.set(p,0,s[m]),h.set(p,1,s[m+1]),h.set(p,2,s[m+2])}const d=new Vt(e,xt(dt),a.buffer);return new Ft(e,d)}};n([u()],E.prototype,"consumes",void 0),n([u()],E.prototype,"produces",void 0),n([u()],E.prototype,"cutColor",void 0),n([u()],E.prototype,"fillColor",void 0),n([u()],E.prototype,"borderColor",void 0),E=n([M("esri.views.3d.webgl-engine.lib.CutFillColor")],E);const dt=Ct().vec3f("position").vec3f("normal").freeze();class Vs{constructor(e,i,s,r){this.vertices=e,this.indicesBottom=i,this.indicesExtruded=s,this.normals=r}}let F=class extends J{get visible(){return this.analysisViewData.visible&&this.analysisViewData.elevationAlignedGeometry!=null&&this.analysisViewData.targetGeometry!=null}get updating(){return this.loadingMessages}get hasUnsupportedError(){const{error:t}=this.analysisViewData;return!!t&&["unsupported-coordinate-system","unsupported-layer-transparency"].includes(t.name)}constructor(t){super(t),this.unitsMessages=null,this.messages=null,this.loadingMessages=!0,this._elevationContext=ve.fromElevationInfo(new we({mode:"absolute-height"})),this._extrusionHeight=G.targetElevationRange,this._projectionLines=[]}initialize(){const{view:t}=this,e={view:t,isDecoration:!0},i=G,s={...e,width:i.geometryOutlineWidth};this._elevationAlignedGeometry=new Je({...s,isDraped:!0,color:b.toUnitRGBA(i.geometryOutlineColor)}),this._targetGeometry=new Je(s);const r={...e,attached:!0,width:i.projectionLineWidth,renderOccluded:4,polygonOffset:!0},l={...r,stipplePattern:ki(i.projectionLineStippleSize)},a=b.toUnitRGBA(i.cutProjectionLineColor),c=b.toUnitRGBA(i.fillProjectionLineColor);this._cutProjectionLines=new ce({...r,color:a}),this._occludedCutProjectionLines=new ce({...l,color:a}),this._fillProjectionLines=new ce({...r,color:c}),this._occludedFillProjectionLines=new ce({...l,color:c});const h={...e,attached:!0};this._cutVolumeLabel=new Ze(h),this._fillVolumeLabel=new Ze(h),this._cutFillRenderNode=new E({view:t,cutColor:i.cutColor,fillColor:i.fillColor,borderColor:i.geometryOutlineColor}),this.addHandles([w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry}),({elevationAlignedGeometry:d,targetGeometry:o})=>{this._elevationAlignedGeometry.geometry=d,this._targetGeometry.geometry=o},D),w(()=>({interactive:this.analysisViewData.interactive,measureType:this.analysis.measureType,visible:this.visible}),({visible:d,interactive:o,measureType:p})=>{this._elevationAlignedGeometry.visible=d&&!o,this._targetGeometry.visible=d&&p==="cut-fill"},D),w(()=>({elevationAlignedGeometry:this.analysisViewData.elevationAlignedGeometry,targetGeometry:this.analysisViewData.targetGeometry,visible:this.visible}),({elevationAlignedGeometry:d,targetGeometry:o,visible:p})=>this._updateProjectionLines(d,o,p),D),w(()=>({interactive:this.analysisViewData.interactive,accentColor:this.view.effectiveTheme.accentColor,hasResult:!!this.analysisViewData.result}),({interactive:d,accentColor:o,hasResult:p})=>{this._updateColors(d,o,p)},D),w(()=>this.analysisViewData.targetGeometry,()=>this._updateCutFillGeometry(),D),w(()=>this.visible&&!this.hasUnsupportedError,d=>this._updateCutFillVisibility(d),D),w(()=>{const{messages:d,unitsMessages:o,visible:p,analysisViewData:m}=this;return{labelAnchors:m.labelAnchors,effectiveDisplayUnits:m.effectiveDisplayUnits,messages:d,unitsMessages:o,result:m.result,visible:p&&!!m.result}},d=>this._updateLabels(d)),w(()=>this.view.state.camera,d=>this._updateProjectionLineOcclusion(d),D),vi(()=>this._updateMessageBundle())]),this._updateMessageBundle()}destroy(){this._elevationAlignedGeometry=P(this._elevationAlignedGeometry),this._targetGeometry=P(this._targetGeometry),this._cutProjectionLines=P(this._cutProjectionLines),this._occludedCutProjectionLines=P(this._occludedCutProjectionLines),this._fillProjectionLines=P(this._fillProjectionLines),this._occludedFillProjectionLines=P(this._occludedFillProjectionLines),this._cutVolumeLabel=P(this._cutVolumeLabel),this._fillVolumeLabel=P(this._fillVolumeLabel),this._cutFillRenderNode.destroy()}_updateProjectionLines(t,e,i){if(this._cutProjectionLines.visible=i,this._occludedCutProjectionLines.visible=i,this._fillProjectionLines.visible=i,this._occludedFillProjectionLines.visible=i,!t||!e)return;const{renderCoordsHelper:s}=this.view,r=[],l=t.spatialReference,a=t.rings[0],c=a.length>1&&wi(a[0],a[a.length-1]),h=a.length-(c?1:0);for(let _=0;_<h;++_){const C=a[_],O=me(y(),C[0],C[1],C[2]);s.toRenderCoords(O,l,O);const L=e.rings[0][_],$=me(y(),L[0],L[1],L[2]);s.toRenderCoords($,l,$);const U=new Ei(O,$);r.push(U)}t.isClockwise(a)||r.reverse();const d=[],o=[],p=[],m=[],f=[],v=this.view.state.camera;for(let _=0;_<r.length;++_){const C=r[_],O=r[_===0?r.length-1:_-1],L=r[_===r.length-1?0:_+1],$=t.rings[0][_],U=e.rings[0][_],z=$[2]>U[2],S=new xs(C,O,L,z);d.push(S),S.updateOccluded(v);const Le=S.isOccluded;z?(Le?p:o).push(C):(Le?f:m).push(C)}this._projectionLines=d,this._cutProjectionLines.setGeometryFromSegments(o),this._occludedCutProjectionLines.setGeometryFromSegments(p),this._fillProjectionLines.setGeometryFromSegments(m),this._occludedFillProjectionLines.setGeometryFromSegments(f)}_updateProjectionLineOcclusion(t){const e=[],i=[],s=[],r=[];let l=!1,a=!1;for(const c of this._projectionLines){c.updateOccluded(t)&&(l||=c.isCut,a||=!c.isCut);const h=c.isOccluded;(c.isCut?h?i:e:h?r:s).push(c.segment)}a&&(this._fillProjectionLines.setGeometryFromSegments(s),this._occludedFillProjectionLines.setGeometryFromSegments(r)),l&&(this._cutProjectionLines.setGeometryFromSegments(e),this._occludedCutProjectionLines.setGeometryFromSegments(i))}_updateColors(t,e,i){const{geometryOutlineColor:s,cutColor:r,fillColor:l,cutColorMuted:a,fillColorMuted:c,cutProjectionLineColor:h,fillProjectionLineColor:d}=G;if(this._cutFillRenderNode.cutColor=i?r:a,this._cutFillRenderNode.fillColor=i?l:c,t){const o=b.toUnitRGBA(e);this._targetGeometry.color=o,this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o,this._fillProjectionLines.color=o,this._occludedFillProjectionLines.color=o,this._cutFillRenderNode.borderColor=e}else{this._targetGeometry.color=b.toUnitRGBA(s);const o=b.toUnitRGBA(i?h:a);this._cutProjectionLines.color=o,this._occludedCutProjectionLines.color=o;const p=b.toUnitRGBA(i?d:c);this._fillProjectionLines.color=p,this._occludedFillProjectionLines.color=p,this._cutFillRenderNode.borderColor=s}}_updateLabels(t){const{labelDistance:e}=G,{effectiveDisplayUnits:i,labelAnchors:s,messages:r,unitsMessages:l,result:a,visible:c}=t;if(this._cutVolumeLabel.visible=c,this._fillVolumeLabel.visible=c,this._cutVolumeLabel.geometry=s.cut?{type:"point",point:s.cut,callout:{distance:e,offset:0}}:null,this._fillVolumeLabel.geometry=s.fill?{type:"point",point:s.fill,callout:{distance:-e,offset:0}}:null,a==null||r==null||l==null)return this._cutVolumeLabel.text="-",void(this._fillVolumeLabel.text="-");const h=i.volume,d=Ae(r.labels.cut,{volume:pt(l,a.cutVolume,h)}),o=Ae(r.labels.fill,{volume:pt(l,a.fillVolume,h)});this._cutVolumeLabel.text=d,this._fillVolumeLabel.text=o}_updateCutFillVisibility(t){t?this._cutFillRenderNode.enable():this._cutFillRenderNode.disable()}_updateCutFillGeometry(){const{renderCoordsHelper:t}=this.view,{targetGeometry:e}=this.analysisViewData;if(!e?.extent)return;const{center:i}=e.extent,s=Tt(i.x,i.y,0),r=y();t.toRenderCoords(s,e.spatialReference,r);const l=this._getExtrudedVolumes(e,this._extrusionHeight,s),a=this._getExtrudedVolumes(e,-this._extrusionHeight,s);this._cutFillRenderNode.updateGeometries(l,a,r)}_getExtrudedVolumes(t,e,i){const{renderCoordsHelper:s,spatialReference:r,elevationProvider:l}=this.view,a=y(),c=s.viewingMode===1;c||s.worldUpAtPosition([0,0,0],a);const h=xe(t,l,s,this._elevationContext),{polygons:d,mapPositions:o,position:p}=h,m=d[0],f=m.count,v=Mt(m.mapPositions,m.holeIndices,3),_=v.length,C=6*f,O=He(C+_),L=He(_),$=be(3*C),U=be(3*C);ji(p,o,v,m,$,null,U,null,O,L,e,a,c);const z=H(),S=H();return Rt(r,i,z,s.spatialReference),S[12]=-z[12],S[13]=-z[13],S[14]=-z[14],Gt($,$,S),new Vs($,L,O,U)}async _updateMessageBundle(){this.loadingMessages=!0;try{this.unitsMessages=await ze("esri/core/t9n/Units"),this.messages=await ze("esri/views/3d/analysis/VolumeMeasurement/t9n/VolumeMeasurementAnalysis")}finally{this.loadingMessages=!1}}};function pt(t,e,i){if(!e||!t)return null;const s=yt(e.value,e.unit,i),r=G.labelPrecisions[s];return Vi(t,e,s,r)}n([u({constructOnly:!0})],F.prototype,"view",void 0),n([u({constructOnly:!0})],F.prototype,"analysis",void 0),n([u({constructOnly:!0})],F.prototype,"analysisViewData",void 0),n([u()],F.prototype,"unitsMessages",void 0),n([u()],F.prototype,"messages",void 0),n([u()],F.prototype,"loadingMessages",void 0),n([u({readOnly:!0})],F.prototype,"visible",null),n([u()],F.prototype,"updating",null),n([u()],F.prototype,"hasUnsupportedError",null),F=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementCutFillVisualization")],F);class xs{constructor(e,i,s,r){this.segment=e,this.previous=i,this.next=s,this.isCut=r,this._isOccluded=!1,this._n1=y(),this._n2=y();const l=W(X,K(X,e.endRenderSpace,e.startRenderSpace));W(this._n1,Ue(this._n1,l,W(pe,K(pe,i.startRenderSpace,e.startRenderSpace)))),W(this._n2,Ue(this._n2,l,W(pe,K(pe,e.startRenderSpace,s.startRenderSpace)))),this._isConvex=bi.normalize(Ci(this._n1,this._n2,l))<0}get isOccluded(){return this._isOccluded}updateOccluded(e){K(X,this.segment.startRenderSpace,e.eye);const i=qe(this._n1,X)<0,s=qe(this._n2,X)<0,r=this._isOccluded;return this._isOccluded=this._isConvex?i&&s:i||s,this._isOccluded!==r}}const X=y(),pe=y();function Fs(t){return At(t?.geometry)}function At(t){return t!=null&&t.type==="polygon"}let Z=class extends Xi(Ni){constructor(t){super(t),this.type="elevation",this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get allFields(){return[this.elevation]}};n([u()],Z.prototype,"type",void 0),n([u()],Z.prototype,"allFields",null),Z=n([M("esri.views.interactive.tooltip.infos.ElevationTooltipInfo")],Z);let k=class extends qi{constructor(t){super(t),this.sketchOptions=new Ot}initialize(){const{view:t}=this;this._shiftManipulator=new Hi(t,0),this._shiftManipulator.state|=zi,this.manipulators.add(this._shiftManipulator),this.addHandles([this._createDragPipeline(),w(()=>this.analysisViewData.targetGeometry,()=>this._updateManipulatorPosition(),$t),w(()=>[this.analysisViewData.interactive,this.analysisViewData.targetGeometry,this.analysis.measureType],()=>this._updateManipulatorVisibility(),N)]),this._initializeTooltip(),this.finishToolCreation()}_initializeTooltip(){const{view:t}=this;this.tooltip=Wi(()=>({view:t,options:this.sketchOptions.tooltips})),this._tooltipInfo=new Z({sketchOptions:this.sketchOptions}),this.sketchOptions.tooltips.placement="trailing",this._updateSketchOptions(),this.addHandles([w(()=>this.analysisViewData.effectiveTargetElevation,()=>this._updateTooltip()),w(()=>this._shouldShowTooltip,e=>{e?this._showTooltip():this._hideTooltip()}),this.tooltip.on("commit",()=>{const e=this._tooltipInfo.elevation.actual,i=Ce(this.view.spatialReference);if(e==null||i==null)return;const s=xi(e,i);this._updateValue(s,{recordUndo:this.analysis.cutFillOptions.targetElevation})}),w(()=>[this.analysis.displayUnits.elevation,this.analysis.inputUnits.elevation],()=>this._updateSketchOptions(),N)])}destroy(){this._shiftManipulator.destroy(),this.tooltip.destroy()}onInputEvent(t){if(!this.destroyed&&!Qi(t,this.tooltip))return super.onInputEvent(t)}get _shouldShowTooltip(){return this.hasFocusedManipulators||this.tooltip.mode==="input"}_createDragPipeline(){return Ii(this._shiftManipulator,(t,e,i)=>{const s=Be(t.renderLocation),r=this.analysis.inputUnits.elevation??"meters",l=Ce(this.view.spatialReference);let a;e.next(Ui(this.view,s,this.view.spatialReference)).next(Bi()).next(c=>{if(c.action==="start"){const{targetElevation:h}=this.analysis.cutFillOptions;a=h&&l?Ve(h,r,l):void 0}return this._updateValue(a!=null?a+c.translationZ:c.mapEnd.z,c.action==="end"?{recordUndo:a}:void 0),c}),i.next(()=>{this._updateValue(a)})})}_updateManipulatorPosition(){const{targetGeometry:t}=this.analysisViewData,{renderCoordsHelper:e}=this.view;if(!t)return;const i=.5,s=t.rings[0],r=Ie(s[0]),l=Ie(s[1]);e.toRenderCoords(r,t.spatialReference,r),e.toRenderCoords(l,t.spatialReference,l);const a=ue.get();K(a,l,r);const c=ue.get();Fi(c,r,l,i);const h=e.worldBasisAtPosition(c,1,ue.get()),d=e.worldBasisAtPosition(c,0,ue.get()),o=Di(h,d,c,Pi.get()),p=e.headingAtPosition(c,a),m=t.isClockwise(t.rings[0])?-Math.PI/2:Math.PI/2;$i(o,o,Ti(p)+m),o[12]=0,o[13]=0,o[14]=0,this._shiftManipulator.renderLocation=Be(c),this._shiftManipulator.modelTransform=o}_updateManipulatorVisibility(){const{interactive:t,targetGeometry:e}=this.analysisViewData,{measureType:i}=this.analysis,s=t&&e!=null&&i==="cut-fill";this._shiftManipulator.available=s}_updateValue(t,e){const i=Ke(t,this.view.spatialReference);if(i==null)return;const s=this.analysis.inputUnits.elevation??"meters",r=Ve(i.value,i.unit,s),l=a=>{this.analysis.cutFillOptions.targetElevation=a};if(l(r),e&&"recordUndo"in e){const a=e.recordUndo;this.emit("record-undo",{apply:()=>l(r),undo:()=>l(a)})}}_getUpdatedTooltipInfo(){const{effectiveTargetElevation:t}=this.analysisViewData;return t?(this._tooltipInfo.elevation.actual=Ke(t,this.view.spatialReference),this._tooltipInfo):this._tooltipInfo}_updateTooltip(){this._shouldShowTooltip&&(this.tooltip.info=this._getUpdatedTooltipInfo())}_showTooltip(){this._updateTooltip()}_hideTooltip(){this.tooltip?.clear()}_updateSketchOptions(){const{analysis:t}=this,{displayUnits:e,inputUnits:i}=t;this.sketchOptions.values.inputUnits=new Ye({verticalLength:i.elevation}),this.sketchOptions.values.displayUnits=new Ye({verticalLength:e.elevation})}};n([u({constructOnly:!0})],k.prototype,"analysis",void 0),n([u({constructOnly:!0})],k.prototype,"view",void 0),n([u({constructOnly:!0})],k.prototype,"analysisViewData",void 0),n([u({constructOnly:!0,type:Ot})],k.prototype,"sketchOptions",void 0),n([u()],k.prototype,"_shouldShowTooltip",null),k=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementShiftTool")],k);let R=class extends J{constructor(t){super(t),this._updatingHandles=new Pt,this._operationManager=new Ki,this._onUndoRedo=()=>{this._updateGeometryFromSketchGraphic()}}initialize(){const{analysis:t,analysisViewData:e,view:i}=this;this._graphicsLayer=new Ai({listMode:"hide",internal:!0,elevationInfo:{mode:"on-the-ground"}});const s=Zi(i,{selfEnabled:!0,excludeInternal:!0});this._sketchViewModel=new Ji({layer:this._graphicsLayer,view:i,updateOnGraphicClick:!1,defaultUpdateOptions:{reshapeOptions:{shapeOperation:"none"},enableRotation:!1,enableScaling:!1,enableMoveAllGraphics:!1,enableZ:!1,multipleSelectionEnabled:!1,toggleToolOnClick:!1,tool:"reshape"},polygonSymbol:this._polygonSymbol,snappingOptions:s.options}),this.addHandles([this._sketchViewModel.on(["undo","redo"],this._onUndoRedo),w(()=>({map:i.map,internalGraphicsLayer:this._graphicsLayer,state:this.state}),({map:r,internalGraphicsLayer:l,state:a})=>{switch(Ps(r,l),a){case"idle":case"reshaping-disabled":this._operationManager.stop(),this._graphicsLayer.removeAll(),this._ensureUpdatedSketchGraphic();break;case"reshaping":Ne(this._startReshape());break;case"awaiting-sketch":this.analysisViewData.interactive=!0}},N),s]),this._shiftTool=new k({analysis:t,view:i,analysisViewData:e}),this.addHandles(this._shiftTool.on("record-undo",r=>{const l=this._sketchViewModel.activeComponent;l?.type==="reshape-3d"&&l.recordUndo(r.apply,r.undo)})),i.tools.add(this._shiftTool),this.addHandles({remove:()=>i.tools.remove(this._shiftTool)})}destroy(){this._operationManager.destroy(),this._sketchViewModel.destroy();const t=this._graphicsLayer;this.view.map.remove(t),t.destroy()}get sketchGraphic(){return this._get("sketchGraphic")}set sketchGraphic(t){t!==this._get("sketchGraphic")&&(this._set("sketchGraphic",t),this._updateGeometryFromSketchGraphic())}get state(){const{geometry:t}=this.analysis,{interactive:e,visible:i}=this.analysisViewData;return i?this._sketchViewModel.createGraphic?this._sketchViewModel.createGraphic===this.sketchGraphic?"sketching":"awaiting-sketch":t?e?"reshaping":"reshaping-disabled":"idle":"idle"}get updating(){return this._sketchViewModel.updating||this._updatingHandles.updating}get _polygonSymbol(){return new Ri({color:[0,0,0,0],outline:{color:[0,0,0,0]}})}place(t){return this._operationManager.start("place",async e=>{const i=this.analysis.clone();this._ensureUpdatedSketchGraphic();const s=this._sketchViewModel.on("create",r=>{switch(r.state){case"start":this._graphicsLayer.removeAll(),this.sketchGraphic=r.graphic;break;case"active":this._updateGeometryFromSketchGraphic();break;case"complete":this._updateGeometryFromSketchGraphic(),e.stop();break;case"cancel":e.stop()}});e.handles.push(s,We(()=>(s.remove(),this._sketchViewModel.cancel(),this._updateGeometryFromSketchGraphic(),this.analysis.valid?Gi(t)||i.equals(this.analysis)?e.reject():void e.resolve({}):(this._clearGeometry(),e.reject())))),await this._updatingHandles.addPromise(this._sketchViewModel.create("polygon"))},t)}_startReshape(){return this._operationManager.start("reshape",async t=>{const e=()=>{const s=this._ensureUpdatedSketchGraphic();return s?(this._graphicsLayer.removeAll(),this._graphicsLayer.add(s),this._updatingHandles.addPromise(this._sketchViewModel.update(s,{tool:"reshape"}))):Promise.resolve()};if(!this._ensureUpdatedSketchGraphic())return;const i=this._sketchViewModel.on("update",s=>{this._updateGeometryFromSketchGraphic(),s.state==="complete"&&(this.state==="reshaping"?Ne(e()):t.resolve())});t.handles.push(i,We(()=>{i.remove(),this._sketchViewModel.cancel(),t.resolve()})),await e()})}_ensureUpdatedSketchGraphic(){const{geometry:t}=this.analysis;return At(t)?(this.sketchGraphic??=new Mi({geometry:t,symbol:this._polygonSymbol}),this.sketchGraphic.geometry=t,this.sketchGraphic):(this.sketchGraphic=null,null)}_clearGeometry(){this.sketchGraphic=null,this.analysis.geometry=null}_updateGeometryFromSketchGraphic(){const t=this.sketchGraphic;this.analysis.geometry=Fs(t)?t.geometry:null}get test(){}};function Ps(t,e){e&&(e.removeFromParent(),t?.add(e))}n([u({constructOnly:!0})],R.prototype,"analysisViewData",void 0),n([u({constructOnly:!0})],R.prototype,"view",void 0),n([u({constructOnly:!0})],R.prototype,"analysis",void 0),n([u()],R.prototype,"sketchGraphic",null),n([u({nonNullable:!0})],R.prototype,"state",null),n([u()],R.prototype,"updating",null),n([u()],R.prototype,"_polygonSymbol",null),R=n([M("esri.views.3d.analysis.VolumeMeasurement.VolumeMeasurementTool")],R);let x=class extends Li{constructor(t){super(t),this.type="volume-measurement-view-3d",this.analysis=null,this.elevationAlignedGeometry=null,this.targetGeometry=null}initialize(){const{analysis:t,view:e}=this;this._analysisController=new g({view:e,analysis:t,analysisViewData:this}),this._analysisTool=new R({analysis:t,view:e,analysisViewData:this}),this._analysisVisualization=new F({view:e,analysis:t,analysisViewData:this})}destroy(){this._analysisController=P(this._analysisController),this._analysisVisualization=P(this._analysisVisualization),this._analysisTool.destroy()}get error(){return this._analysisController?.error??null}get result(){return this._analysisController?.result}get interactive(){return super.interactive}set interactive(t){super.interactive=t}get visible(){return super.visible}set visible(t){super.visible=t}get effectiveTargetElevation(){const{cutFillOptions:t,inputUnits:e}=this.analysis,{targetElevation:i}=t,s=e?.elevation??"meters",r=Ce(this.view.spatialReference);if(i!=null&&r!=null)return Ve(i,s,r);const l=this.elevationAlignedGeometry?.extent;return l?.zmin==null||l?.zmax==null?null:(l.zmax+l.zmin)/2}get effectiveDisplayUnits(){const{displayUnits:t}=this.analysis,e=Oi(this.view);return{elevation:t.elevation??e,volume:t.volume??e}}get labelAnchors(){const{elevationAlignedGeometry:t,view:e}=this,{renderCoordsHelper:i}=e;if(!t)return{cut:null,fill:null};let s=t.rings[0][0],r=t.rings[0][0];t.rings[0].forEach(o=>{o[2]>s[2]&&(s=o),o[2]<r[2]&&(r=o)});const{spatialReference:l}=t,a=new Qe({x:s[0],y:s[1],z:s[2],spatialReference:l}),c=new Qe({x:r[0],y:r[1],z:r[2],spatialReference:l}),h=y(),d=y();return i.toRenderCoords(a,h),i.toRenderCoords(c,d),{cut:h,fill:d}}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisTool.updating||this._analysisVisualization.updating}place(t){return this._analysisTool.place(t)}get test(){}};n([u()],x.prototype,"error",null),n([u({readOnly:!0})],x.prototype,"type",void 0),n([u({constructOnly:!0,nonNullable:!0})],x.prototype,"analysis",void 0),n([u({readOnly:!0})],x.prototype,"result",null),n([u()],x.prototype,"elevationAlignedGeometry",void 0),n([u({type:Number})],x.prototype,"effectiveTargetElevation",null),n([u()],x.prototype,"targetGeometry",void 0),n([u()],x.prototype,"effectiveDisplayUnits",null),n([u()],x.prototype,"labelAnchors",null),n([u()],x.prototype,"updating",null),x=n([M("esri.views.3d.analysis.VolumeMeasurementAnalysisView3D")],x);const zr=x,$s=Object.freeze(Object.defineProperty({__proto__:null,CutFillDepthParameters:Te,build:St},Symbol.toStringTag,{value:"Module"})),Ts=Object.freeze(Object.defineProperty({__proto__:null,CutFillReductionParameters:Re,build:Dt},Symbol.toStringTag,{value:"Module"})),Rs=Object.freeze(Object.defineProperty({__proto__:null,CutFillTargetDepthParameters:Ge,build:jt},Symbol.toStringTag,{value:"Module"})),Gs=Object.freeze(Object.defineProperty({__proto__:null,CutFillCompositionPassParameters:Me,build:Et},Symbol.toStringTag,{value:"Module"})),Ms=Object.freeze(Object.defineProperty({__proto__:null,CutFillMaskDrawParameters:Oe,build:kt},Symbol.toStringTag,{value:"Module"}));export{zr as default};
