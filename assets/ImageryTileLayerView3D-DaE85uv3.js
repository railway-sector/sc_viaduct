import{ad as T,d4 as b,oQ as R,oR as D,n as p,p as _,u as S,ma as c,oS as v,e as P,he as L,gE as G,oT as F}from"./index-Dqeu25xh.js";import{u as M}from"./rasterProjectionHelper-DBKu128_.js";import{l as O}from"./LayerView3D-EkH3eMgg.js";import{p as A}from"./TiledLayerView3D-BRg50gFB.js";import{l as C}from"./throttle-BQQdfyrd.js";import{y as U}from"./dataUtils-a2W2H0xD.js";import{r as V,c as $}from"./FlowSubView3D-B5rBADRl.js";import{h as y,c as k}from"./loadUtils-Dd_Qz5GE.js";import{i as j,m as E,l as H,c as q,f as B,u as W,o as x}from"./rasterUtils-Du3s_DcH.js";import{f as J}from"./ImageryTileLayerView-B4M9KIhQ.js";import{d as N}from"./LayerView-ipM9LArx.js";import{i as Q}from"./RefreshableLayerView-DjR-BTT2.js";import"./utils-B91ZvGWF.js";import"./SubView3D-4grhKWL4.js";import"./line-k_ehIwcE.js";import"./FeatureTileDescriptor-DEeqzc0Y.js";import"./rasterFieldUtils-DXDfL-8a.js";import"./timeSupport-kcfUlgPt.js";import"./datasetUtils-DdDUWBI2.js";const f={type:"delete"},K={type:"waiting"},X={type:"on-worker",upsampled:!1},Y={type:"on-worker",upsampled:!0};let g=class extends V{constructor(t){super(t),this._resetTileData=!0,this._throttledTriggerLoad=null,this._throttling=!1}initialize(){this.addHandles([this.surface.on("tile-data-changed",({tile:t,layerIndex:e,layerClass:r})=>{this.renderedTiles!=null&&(this.loadByTileTreesAllowed||this._tileIsUpsampled(t))&&e===this._layerIndex&&r===1&&this._updateFlowDataTile(t)}),T(()=>this.renderedTiles,t=>{const e=this.frameTask.scheduleGenerator(r=>this._updateFlowDataTiles(t,r));this.updatingHandles.addPromise(e)},b),T(()=>this._pixelSize,()=>{this.invalidateTileData(),this._resetTileData=!0},b)]),this._throttledTriggerLoad=C(()=>{super.triggerLoad(),this._throttling=!1},()=>this._throttling=!0,$,this),this.addHandles(this._throttledTriggerLoad)}async*_updateFlowDataTiles(t,e){const r=w();for(const s of t??[]){const i=this._flowDataTiles?.get(y(s)),a=i==null||i.type==="delete"||i.type==="waiting"?this._getLoadedState(s):i;a!=null&&r.set(y(s),a),e.madeProgress(),e.done&&(e=yield)}this._flowDataTiles=r,this._resetTileData=!0,this.triggerLoad()}abort(){super.abort(),this._throttling=!1}get _layerIndex(){return this.surface.getLayerIndexByUID(1,this.layerView.uid)}get loadByTileTreesAllowed(){return super.loadByTileTreesAllowed||!this._allTilesLoaded}get _pixelSize(){return this.surface.tilingScheme.pixelSize}doRefresh(){this.invalidateTileData(),super.doRefresh()}triggerLoad(){const{_throttledTriggerLoad:t}=this;this._allTilesLoaded?(t.hasPendingUpdates()||t(),t.forceUpdate()):t()}async fetchDataAndGenerateStreamlines(t,e){const{_flowDataTiles:r,needsMagnitude:s,workerHandle:i}=this,a=this.getSimulationSettings(t);if(a==null||i==null||r==null)return;const n=this._resetTileData;this._resetTileData=!1;const h=w();r.forEach((o,l)=>{o.type==="delete"?(h.set(l,f),r.delete(l)):(n||o.type!=="on-worker"&&o.type!=="waiting")&&(h.set(l,o),r.set(l,o.type!=="waiting"&&o.upsampled?Y:X))});const u={simulationSettings:a,flowExtentInfo:t.flowExtentInfo,flowDataTiles:h,reset:n,needsMagnitude:s,startPositions:this.startPositions(t)},{streamlines:d}=await i.generateTiledStreamlines(u,e);return d}getUpdating(){return super.getUpdating()||this._throttling}_getLoadedState(t){const{_layerIndex:e}=this,r=t.surface==null;if(e==null||r)return f;const s=t.getLayerInfo(e,1);if(s==null)return f;if(!t.visible&&s.requestAbort==null)return s.requestAbort=new AbortController,this.surface.requestTileData(t,e,1,s.requestAbort),f;const i=this._getRasterTile(s,t,e);return i==null?this._upsampleFlowData(e,s.upsampleInfo,t.lij,t.extent):{type:"loaded",data:this._createFlowDataTile(i,t.lij,t.extent,this._pixelSize),upsampled:!1}}_upsampleFlowData(t,e,r,s){if(e==null)return f;const i=e.tile;if(i==null)return f;const a=i.getLayerInfo(t,1);if(a==null)return f;const n=this._getRasterTile(a,i,t);if(n==null)return f;const{scale:h,offset:u}=e,d=Math.max(Math.floor(this._pixelSize*h),1),o=n.source,l=Math.floor(u[0]*o.width),z=Math.floor((1-u[1]-h)*o.height);return{type:"loaded",data:this._createFlowDataTile(n,r,s,d,l,z),upsampled:!0}}_getRasterTile(t,e,r){const{data:s}=t;return!t.dataMissing&&e.hasLayerData(r,1)&&R(s)?s:null}_createFlowDataTile(t,e,r,s,i,a){const n=U(this.layer.serviceRasterInfo.dataType,t.source,s,s,i,a),h=n.mask.slice();return new k(n.data,h,n.width,n.height,e,D(r))}_updateFlowDataTile(t){const{renderedTiles:e,_layerIndex:r}=this;if(e==null||r==null)return;if(e.has(t)){const i=this._getLoadedState(t);return void(this._setTileData(t,i)&&this.triggerLoad())}let s=this._setTileData(t,f);for(const i of e.values()){const a=i.getLayerInfo(r,1);if(a==null||this._getRasterTile(a,i,r)!=null||a.upsampleInfo?.tile!==t)continue;const h=this._getLoadedState(i),u=this._setTileData(i,h);s||=u}s&&this.triggerLoad()}_setTileData(t,e){const{_flowDataTiles:r}=this;if(r==null)return!1;const s=y(t);return(r.get(s)!=null||e.type!=="delete")&&(r.set(s,e),!0)}get _allTilesLoaded(){let t=0;for(const e of this._flowDataTiles?.values()??[])e.type!=="delete"&&e.type!=="waiting"&&t++;return t===this.renderedTiles?.size}invalidateTileData(){const{_flowDataTiles:t}=this;t?.forEach((e,r)=>{t.set(r,K)})}_tileIsUpsampled(t){const e=this._flowDataTiles?.get(y(t));return e!=null&&(e.type==="loaded"||e.type==="on-worker")&&e.upsampled}get usedMemory(){const t=9*this._pixelSize**2,e=(this._flowDataTiles?.size??0)*t;return super.usedMemory+e}get test(){return{...super.test,loadedTiles:this._flowDataTiles??w()}}};function w(){return new Map}p([_()],g.prototype,"_throttling",void 0),g=p([S("esri.views.3d.support.flow.FlowSubViewTiles3D")],g);const I={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class Z{constructor(e,r,s=null,i=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=r,this.width=s||r.width,this.height=i||r.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=c(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...I,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||I}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((r,s)=>!!this._bandIds?.[s]&&r===this._bandIds[s])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(r==="bilinear"?9729:9728)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=c(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=j(e,this.transformGrid))),!0)}getUniforms(e){const{symbolizerParameters:r,transformGrid:s,width:i,height:a,opacity:n}=this,h=E(s,[i,a],[this.source.width,this.source.height],n),u=H(r.colormap,r.colormapOffset),d=this.symbolizerParameters.type==="stretch"?q(this.symbolizerParameters):null,o=this.symbolizerParameters.type==="hillshade"?B(this.symbolizerParameters):null,l=e.emptyTexture;return new v(h,u,d||o,this._rasterTexture??l,this._transformGridTexture??l,this._colormapTexture??l)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,s)=>r+s,0)}return this._memoryUsed}release(){return this._rasterTexture=c(this._rasterTexture),this._transformGridTexture=c(this._transformGridTexture),this._colormapTexture=c(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const s=this.source?this.source.extractBands(r):null;if(!(s?.pixels&&s.pixels.length>0))return void(this._rasterTexture=c(this._rasterTexture));const i=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&i)return;this._rasterTexture=c(this._rasterTexture);const a=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=W(e,s,a,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,s=this.symbolizerParameters.colormap;return s?r?s.length!==r.length||s.some((i,a)=>i!==r[a])?(this._colormapTexture=c(this._colormapTexture),this._colormapTexture=x(e,s),void(this._colormap=s)):void 0:(this._colormapTexture=x(e,s),void(this._colormap=s)):(this._colormapTexture=c(this._colormapTexture),void(this._colormap=null))}}let m=class extends J(Q(A(O(N)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0,this._flowSubView=null,this.ignoresMemoryFactor=!1,this.unloadedMemory=0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new P("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const t=L(()=>this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const e=this.view.basemapTerrain.tilingScheme,r=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(r.format)&&e.compatibleWith(r),this.tileInfo=this._isAlignedMapTile?r:e.toTileInfo(),this.addHandles([T(()=>this.layer.renderer,s=>{this._setSubView(s),this._updatingHandles.addPromise(this.doRefresh())},b),T(()=>[this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this._updatingHandles.addPromise(this.doRefresh()),b)])});this._setSubView(this.layer.renderer),this.addResolvingPromise(t)}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this._flowSubView?.destroy()}_setSubView(t){if(this.layer.type==="wcs")return;const e=t?.type==="flow",r=this._flowSubView;e&&r!=null||(r?.destroy(),this._flowSubView=e?new g({layerView:this}):null)}get _blankTile(){const t=document.createElement("canvas"),e=t.getContext("2d"),[r,s]=this.tileInfo.size;return t.width=r,t.height=s,e.clearRect(0,0,r,s),e.getImageData(0,0,r,s)}get _hasFlow(){return this._flowSubView!=null}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){const t=this.layer.tileInfo,e=this.tileInfo.lodAt(0)?.scale,r=t.lodAt(t.lods.length-1)?.scale;return this.levelRangeFromScaleRange(e,r)}get visibleAtCurrentScale(){return this._flowSubView?.visibleAtCurrentScale??this.tilesVisibleAtCurrentScale()}_getFullExtent(){return M(this.layer.serviceRasterInfo,this.view.basemapTerrain?.spatialReference??this.view.spatialReference)}async fetchTile(t,e){const r=this.tileInfo,s=this._canSymbolizeInWebGL(),i={tileInfo:r,requestRawData:s&&!this._hasFlow,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,requestProjectedLocalDirections:this._hasFlow,noClip:!1},{layer:a}=this,[n,h,u]=t,d=await a.fetchTile(n,h,u,i);if(d instanceof HTMLImageElement)return d;let o=d?.pixelBlock;if(o==null)return this._blankTile;if(!s&&!this._hasFlow&&(o=await a.applyRenderer(d),o==null))return this._blankTile;const l=new Z([n,h,u],o,r.size[0],r.size[1]);return s?(l.symbolizerRenderer=a.symbolizer.rendererJSON,l.symbolizerParameters=a.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(n)),l.transformGrid=d.transformGrid,l.bandIds=a.bandIds):(l.isRendereredSource=!0,l.bandIds=null),l.interpolation=a.interpolation,l}_getSymbolizerOptions(t){const e=this.tileInfo.lodAt(t).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain?.spatialReference!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(t){this._canSymbolizeInWebGL()&&JSON.stringify(t.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(t.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(t.lij[0])))}createFetchPopupFeaturesQueryGeometry(t,e){return G(t,e,this.view)}async doRefresh(){this.suspended||(this._flowSubView?.doRefresh(),this.emit("data-changed"))}isUpdating(){return this._flowSubView?.updating??!1}_canSymbolizeInWebGL(){const t=F(),{symbolizer:e}=this.layer,r=e.lookup.colormapLut?.indexedColormap,s=!!this.layer.rasterFunction?.hasClipFunction,i=r&&r.length>4*(t.maxTextureSize||4096);return e.canRenderInWebGL&&!i&&!s}get usedMemory(){return this._flowSubView?.usedMemory??0}get test(){}};p([_({readOnly:!0})],m.prototype,"_blankTile",null),p([_()],m.prototype,"_hasFlow",null),p([_({readOnly:!0})],m.prototype,"imageFormatIsOpaque",null),p([_({readOnly:!0})],m.prototype,"hasMixedImageFormats",null),p([_()],m.prototype,"_flowSubView",void 0),p([_({readOnly:!0})],m.prototype,"dataLevelRange",null),p([_({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),m=p([S("esri.views.3d.layers.ImageryTileLayerView3D")],m);const Te=m;export{Te as default};
