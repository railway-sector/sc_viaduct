import{cF as R,cG as q,cH as P,cI as E,ax as x,cJ as U,cK as H,e as I,cL as $,cM as G,ch as F,cN as J,cO as K,cP as Q,cQ as W,cR as C}from"./index-BApIjc64.js";import{y as j}from"./densifyCurvedGeometry-B-MPkHXd.js";const N="picture-fill",V="picture-marker",X="simple-fill",Y="simple-line",_="simple-marker",tt="text",et="Aa",at=22,L=120,nt=80,A=50,D=225,ot=document.createElement("canvas");function Z(e,t,s){const{extent:n}=e;if(!n)return"";const p=n.width||1,r=n.height||1;if(e.type==="polygon"){const h=e.clone();F(h)&&(h.rings=j(h,{minSegmentsPerCurve:128}).rings),J({originPosition:"upperLeft",scale:[p/t,r/s],translate:[n.xmin,n.ymax]},h,h);let l="";for(let a=0;a<h.rings.length;a++){const m=h.rings[a];for(let c=0;c<m.length;c++){const f=m[c][0],o=m[c][1],i=c===0?"M":"l",M=c===m.length-1?" Z":"";l+=`${l!==""?" ":""}${i}${f.toString()} ${o.toString()}${M}`}}return l}if(e.type==="polyline"){const h=e.clone();F(h)&&(h.paths=j(h,{minSegmentsPerCurve:128}).paths),K({originPosition:"upperLeft",scale:[p/t,r/s],translate:[n.xmin,n.ymax]},h,h);let l="";for(let a=0;a<h.paths.length;a++){const m=h.paths[a];for(let c=0;c<m.length;c++){const f=m[c][0],o=m[c][1];l+=`${l!==""?" ":""}${c===0?"M":"l"}${f.toString()} ${o.toString()}`}}return l}return""}function O(e,t){const s=ot.getContext("2d"),n=[];t&&(t.weight&&n.push(t.weight),t.size&&n.push(t.size+"px"),t.family&&n.push(t.family)),s.font=n.join(" ");const{width:p,actualBoundingBoxLeft:r,actualBoundingBoxRight:h,actualBoundingBoxAscent:l,actualBoundingBoxDescent:a}=s.measureText(e);return{width:Math.ceil(Math.max(p,r+h)),height:Math.ceil(l+a),x:Math.floor(r),y:Math.floor((l-a)/2)}}function S(e){const t=e?.size;return{width:t!=null&&typeof t=="object"&&"width"in t?x(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?x(t.height):null}}async function it(e,t){const s=t.fill,n=e.color;if(s?.type==="pattern"&&n&&e.type!==N){const p=await Q(s.src,n.toCss(!0));s.src=p,t.fill=s}}async function lt(e,t,s,n){if(!("font"in e)||!e.font||t.shape.type!=="text")return;try{await W(e.font)}catch{}const{width:p,height:r}=S(n);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:h,height:l,x:a,y:m}=O(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});s[0]=p??h,s[1]=r??l,t.shape.x=a,t.shape.y=m;let c="angle"in e?e.angle:null;if(n?.rotation!=null&&(c=(c??0)+n.rotation),c){const f=c*(Math.PI/180),o=Math.abs(Math.sin(f)),i=Math.abs(Math.cos(f));s[1]=s[0]*o+s[1]*i}}}function st(e,t,s,n,p){if(e.haloColor!=null&&e.haloSize!=null){p.masking??=s.map(()=>[]);const r=x(e.haloSize);n[0]+=r,n[1]+=r,s.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*r,join:"round",cap:"round"}}]),p.masking.unshift([{shape:{type:"rect",x:0,y:0,width:n[0]+2*C,height:n[1]+2*C},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}e.backgroundColor==null&&e.borderLineColor==null||(n[0]+=2*C,n[1]+=2*C,s.unshift([{shape:{type:"rect",x:0,y:0,width:n[0],height:n[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:x(e.borderLineSize)}}]),p.masking?.unshift([]))}function T(e,t){return e>t?"dark":"light"}function rt(e,t){const s=typeof t?.size=="number"?t?.size:null,n=s!=null?x(s):null,p=t?.maxSize!=null?x(t.maxSize):null;let r="angle"in e?e.angle:null;t?.rotation!=null&&(r=(r??0)+t.rotation);const h=R(e);let l=q(e);ht(e,245)!=="dark"||t?.ignoreWhiteSymbols||(l={width:.75,...l,color:"#bdc3c7"});let a=null;const m={shape:null,fill:h,stroke:l,offset:[0,0]};l?.width&&(l.width=Math.min(l.width,nt));const c=l?.width||0;let f=t?.size!=null&&(t?.scale==null||t?.scale),o=0,i=0,M=!1;switch(e.type){case _:{const g=e.style,{width:d,height:u}=S(t);let b=d===u&&d!=null?d:n??Math.min(x(e.size),p||L);if(t?.useMarkerSymbolSize===!0&&d!==null&&u!==null){const y=Math.min(x(e.size),p||L);b=y>d&&y>u?Math.min(d,u):y}switch(o=b,i=b,g){case"circle":m.shape={type:"circle",cx:0,cy:0,r:.5*b},f||(o+=c,i+=c);break;case"cross":m.shape={type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[o,.5*i]},{command:"M",values:[.5*o,0]},{command:"L",values:[.5*o,i]}]};break;case"diamond":m.shape={type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*o,0]},{command:"L",values:[o,.5*i]},{command:"L",values:[.5*o,i]},{command:"Z",values:[]}]},f||(o+=c,i+=c);break;case"square":m.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,i]},{command:"L",values:[0,i]},{command:"Z",values:[]}]},f||(o+=c,i+=c),r&&(M=!0);break;case"triangle":m.shape={type:"path",path:[{command:"M",values:[.5*o,0]},{command:"L",values:[o,i]},{command:"L",values:[0,i]},{command:"Z",values:[]}]},f||(o+=c,i+=c),r&&(M=!0);break;case"x":m.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,i]},{command:"M",values:[o,0]},{command:"L",values:[0,i]}]},r&&(M=!0);break;case"path":m.shape={type:"path",path:e.path||""},f||(o+=c,i+=c),r&&(M=!0),f=!0}break}case Y:{const{width:g,height:d}=S(t),u=H(l).reduce((v,k)=>v+k,0),b=u&&Math.ceil(A/u),y=d??n??c,w=g??(u*b||A);if(f=!0,t?.geometry?.type==="polyline"&&t?.geometry?.extent){o=w,i=d??o;const v=1e3,k=.15*v;a=[o,i],i=a[0]>a[1]?v*a[1]/a[0]:v,o=a[0]>a[1]?v:v*a[0]/a[1],l?.width&&(l.width=l.width*v/(a[1]>a[0]?a[1]:a[0]),l.width>k&&(l.width=k)),m.shape={type:"path",path:Z(t.geometry,o,i)}}else o=t?.maxSize!=null?Math.min(w,t.maxSize):w,i=y,l&&(l.width=y),m.shape={type:"path",path:[{command:"M",values:[y/2,i/2]},{command:"L",values:[o-y/2,i/2]}]};break}case N:case X:{const g=typeof t?.symbolConfig=="object"&&!!t?.symbolConfig?.isSquareFill,{width:d,height:u}=S(t);o=!g&&d!==u||d==null?n??at:d,i=!g&&d!==u||u==null?o:u,f||(o+=c,i+=c),f=!0,t?.geometry?.extent&&t?.geometry?.type==="polygon"?(a=[o,i],i=a[0]>a[1]?1e3*a[1]/a[0]:1e3,o=a[0]>a[1]?1e3:1e3*a[0]/a[1],m.shape={type:"path",path:Z(t.geometry,o,i)}):m.shape=g?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,i]},{command:"L",values:[0,i]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:U.fill[0];break}case V:{const g=Math.min(x(e.width),p||L),d=Math.min(x(e.height),p||L),{width:u,height:b}=S(t),y=u===b&&u!=null?u:n??Math.max(g,d),w=e.width/e.height;o=w<=1?Math.ceil(y*w):y,i=w<=1?y:Math.ceil(y/w),m.shape={type:"image",x:-Math.round(o/2),y:-Math.round(i/2),width:o,height:i,src:e.url||""},r&&(M=!0);break}case tt:{const g=e,d=t?.overrideText||g.text||et,u=g.font,{width:b,height:y}=S(t),w=y??n??Math.min(x(u.size),p||L),{width:v,height:k}=O(d,{weight:u.weight,size:w,family:u.family}),z=/[\uE600-\uE6FF]/.test(d);o=b??(z?w:v),i=z?w:k;let B=.5*(z?w:k);z&&(B+=5),m.shape={type:"text",text:d,x:g.xoffset||0,y:g.yoffset||B,align:"middle",alignBaseline:g.verticalAlignment,decoration:u&&u.decoration,rotated:g.rotated,kerning:g.kerning},m.font=u&&{size:w,style:u.style,decoration:u.decoration,weight:u.weight,family:u.family};break}}return{shapeDescriptor:m,size:[o,i],outputSize:a,renderOptions:{node:t?.node,scale:f,opacity:t?.opacity,rotations:[r],useRotationSize:M,cssEffectFilter:t?.cssEffectFilter,ariaLabel:t?.ariaLabel,clipBloomEffect:t?.clipBloomEffect}}}async function mt(e,t){const{shapeDescriptor:s,size:n,renderOptions:p,outputSize:r}=rt(e,t);if(!s.shape)throw new I("symbolPreview: renderPreviewHTML2D","symbol not supported.");await it(e,s),await lt(e,s,n,t);const h=[[s]];if(typeof t?.symbolConfig=="object"&&t?.symbolConfig?.applyColorModulation){const a=.6*n[0];h.unshift([{...s,offset:[-a,0],fill:$(s.fill,-.3)}]),h.push([{...s,offset:[a,0],fill:$(s.fill,.3)}]),n[0]+=2*a,p.scale=!1}e.type==="text"&&st(e,s,h,n,p);const l=G(h,n,p);if(r&&l){const a=l.nodeName.toLowerCase()==="img"?l:l.firstChild;a.nodeName.toLowerCase()==="svg"&&a.setAttribute("viewBox",`0 0 ${n[0].toString()} ${n[1].toString()}`),a.setAttribute("width",r[0].toString()),a.setAttribute("height",r[1].toString()),r.length>2&&(a.style.setProperty("padding-left",r[2]?.toString()+"px"),a.style.setProperty("padding-right",r[2]?.toString()+"px"),a.style.setProperty("padding-top",r[3]?.toString()+"px"),a.style.setProperty("padding-bottom",r[3]?.toString()+"px"),a.style.setProperty("box-sizing","border-box"))}return l}function ht(e,t=D){const s=R(e),n=q(e),p=!s||"type"in s?null:new P(s),r=n?.color?new P(n?.color):null,h=p?T(E(p),t):null,l=r?T(E(r),t):null;return l?h?h===l?h:t>=D?"light":"dark":l:h}export{ht as getContrastingBackgroundTheme,rt as getRenderSymbolParameters,mt as previewSymbol2D};
