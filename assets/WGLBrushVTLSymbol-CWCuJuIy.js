import{v5 as H,bR as K,ma as Z,v6 as L,la as N,l8 as J,h as Q,v7 as Y,v8 as G,l7 as b,v9 as ee,bW as F,nt as te,va as $}from"./index-DxtJ83V_.js";let A=class{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(i,t){}draw(i,t,e){}drawMany(i,t,e){for(const r of t)r.visible&&this.draw(i,r,e)}};class le extends A{constructor(){super(...arguments),this._color=H(1,0,0,1),this._patternMatrix=K(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao=Z(this._vao)}drawMany(i,t){const{context:e,painter:r,requestRender:l,allowDelayedRender:y}=i;this._loadWGLResources(i);const d=i.displayLevel,s=i.styleLayer,v=s.backgroundMaterial,c=r.vectorTilesMaterialManager,x=s.getPaintValue("background-color",d),p=s.getPaintValue("background-opacity",d),D=s.getPaintValue("background-pattern",d),g=D!==void 0,P=1|window.devicePixelRatio,M=i.spriteMosaic;let E,U;const f=P>Y?2:1,_=this._programOptions;_.pattern=g;const n=c.getMaterialProgram(e,v,_);if(!y||l==null||n.compiled){if(e.bindVAO(this._vao),e.useProgram(n),g){const a=M.getMosaicItemPosition(D,!0);if(a!=null){const{tl:u,br:m,page:o}=a;E=m[0]-u[0],U=m[1]-u[1];const I=M.getPageSize(o);I!=null&&(M.bind(e,9729,o,L),n.setUniform4f("u_tlbr",u[0],u[1],m[0],m[1]),n.setUniform2fv("u_mosaicSize",I),n.setUniform1i("u_texture",L))}n.setUniform1f("u_opacity",p)}else{const a=x[3]*p;this._color[0]=a*x[0],this._color[1]=a*x[1],this._color[2]=a*x[2],this._color[3]=a,n.setUniform4fv("u_color",this._color)}n.setUniform1f("u_depth",s.z||0);for(const a of t){if(n.setUniform1f("u_coord_range",a.rangeX),n.setUniformMatrix3fv("u_dvsMat3",a.transforms.displayViewScreenMat3),g){const u=Math.max(2**(Math.round(d)-a.key.level),1),m=f*a.width*u,o=m/G(E),I=m/G(U);this._patternMatrix[0]=o,this._patternMatrix[4]=I,n.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}e.setStencilFunction(514,0,255),e.drawArrays(N.TRIANGLE_STRIP,0,4)}}else l()}_loadWGLResources(i){if(this._vao)return;const{context:t,styleLayer:e}=i,r=e.backgroundMaterial,l=new Int8Array([0,0,1,0,0,1,1,1]),y=new J(t,r.geometryLayout,l);this._vao=new Q(t,y)}}let ue=class extends A{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:r,requiredLevel:l,state:y,painter:d,spriteMosaic:s,styleLayerUID:v,requestRender:c,allowDelayedRender:x}=i;if(!t.some(n=>n.layerData.get(v)?.circleIndexCount??!1))return;const p=i.styleLayer,D=p.circleMaterial,g=d.vectorTilesMaterialManager,P=1.2,M=p.getPaintValue("circle-translate",r),E=p.getPaintValue("circle-translate-anchor",r),U=this._programOptions,f=g.getMaterialProgram(e,D,U);if(x&&c!=null&&!f.compiled)return void c();e.useProgram(f),f.setUniformMatrix3fv("u_displayMat3",E===1?y.displayMat3:y.displayViewMat3),f.setUniform2fv("u_circleTranslation",M),f.setUniform1f("u_depth",p.z),f.setUniform1f("u_antialiasingWidth",P);let _=-1;for(const n of t){if(!n.layerData.has(v))continue;n.key.level!==_&&(_=n.key.level,D.setDataUniforms(f,r,p,_,s));const a=n.layerData.get(v);if(!a.circleIndexCount)continue;a.prepareForRendering(e);const u=a.vao;u!=null&&(e.bindVAO(u),f.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),l!==n.key.level?e.setStencilFunction(514,n.stencilRef,255):e.setStencilFunction(516,255,255),e.drawElements(N.TRIANGLES,a.circleIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.circleIndexStart),n.triangleCount+=a.circleIndexCount/3)}}};const q=1/65536;let ce=class extends A{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(i,t){const{displayLevel:e,renderPass:r,spriteMosaic:l,styleLayerUID:y}=i;let d=!1;for(const f of t)if(f.layerData.has(y)){const _=f.layerData.get(y);if(_.fillIndexCount>0||_.outlineIndexCount>0){d=!0;break}}if(!d)return;const s=i.styleLayer,v=s.getPaintProperty("fill-pattern"),c=v!==void 0,x=c&&v.isDataDriven;let p;if(c&&!x){const f=v.getValue(e);p=l.getMosaicItemPosition(f,!0)}const D=!c&&s.getPaintValue("fill-antialias",e);let g=!0,P=1;if(!c){const f=s.getPaintProperty("fill-color"),_=s.getPaintProperty("fill-opacity");if(!f?.isDataDriven&&!_?.isDataDriven){const n=s.getPaintValue("fill-color",e);P=s.getPaintValue("fill-opacity",e)*n[3],P>=1&&(g=!1)}}if(g&&r==="opaque")return;const M=s.getPaintValue("fill-translate",e),E=s.getPaintValue("fill-translate-anchor",e);(g||r!=="translucent")&&this._drawFill(i,y,s,t,M,E,c,p,x);const U=!s.hasDataDrivenOutlineColor&&s.outlineUsesFillColor&&P<1;D&&r!=="opaque"&&!U&&this._drawOutline(i,y,s,t,M,E)}_drawFill(i,t,e,r,l,y,d,s,v){if(d&&!v&&s==null)return;const{context:c,displayLevel:x,state:p,painter:D,pixelRatio:g,spriteMosaic:P,requestRender:M,allowDelayedRender:E}=i,U=e.fillMaterial,f=D.vectorTilesMaterialManager,_=g>Y?2:1,n=this._fillProgramOptions;n.pattern=d;const a=f.getMaterialProgram(c,U,n);if(E&&M!=null&&!a.compiled)return void M();if(c.useProgram(a),s!=null){const{page:m}=s,o=P.getPageSize(m);o!=null&&(P.bind(c,9729,m,L),a.setUniform2fv("u_mosaicSize",o),a.setUniform1i("u_texture",L))}a.setUniformMatrix3fv("u_displayMat3",y===1?p.displayMat3:p.displayViewMat3),a.setUniform2fv("u_fillTranslation",l),a.setUniform1f("u_depth",e.z+q);let u=-1;for(const m of r){if(!m.layerData.has(t))continue;m.key.level!==u&&(u=m.key.level,U.setDataUniforms(a,x,e,u,P));const o=m.layerData.get(t);if(!o.fillIndexCount)continue;o.prepareForRendering(c);const I=o.fillVAO;if(I!=null){if(c.bindVAO(I),a.setUniformMatrix3fv("u_dvsMat3",m.transforms.displayViewScreenMat3),c.setStencilFunction(514,m.stencilRef,255),d){const h=Math.max(2**(Math.round(x)-m.key.level),1),w=m.rangeX/(_*m.width*h);a.setUniform1f("u_patternFactor",w)}if(v){const h=o.patternMap;if(!h)continue;for(const[w,T]of h){const O=P.getPageSize(w);O!=null&&(P.bind(c,9729,w,L),a.setUniform2fv("u_mosaicSize",O),a.setUniform1i("u_texture",L),c.drawElements(N.TRIANGLES,T[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*T[0]))}}else c.drawElements(N.TRIANGLES,o.fillIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*o.fillIndexStart);m.triangleCount+=o.fillIndexCount/3}}}_drawOutline(i,t,e,r,l,y){const{context:d,displayLevel:s,state:v,painter:c,pixelRatio:x,spriteMosaic:p,requestRender:D,allowDelayedRender:g}=i,P=e.outlineMaterial,M=c.vectorTilesMaterialManager,E=.75/x,U=this._outlineProgramOptions,f=M.getMaterialProgram(d,P,U);if(g&&D!=null&&!f.compiled)return void D();d.useProgram(f),f.setUniformMatrix3fv("u_displayMat3",y===1?v.displayMat3:v.displayViewMat3),f.setUniform2fv("u_fillTranslation",l),f.setUniform1f("u_depth",e.z+q),f.setUniform1f("u_outline_width",E);let _=-1;for(const n of r){if(!n.layerData.has(t))continue;n.key.level!==_&&(_=n.key.level,P.setDataUniforms(f,s,e,_,p));const a=n.layerData.get(t);if(a.prepareForRendering(d),!a.outlineIndexCount)continue;const u=a.outlineVAO;u!=null&&(d.bindVAO(u),f.setUniformMatrix3fv("u_dvsMat3",n.transforms.displayViewScreenMat3),d.setStencilFunction(514,n.stencilRef,255),d.drawElements(N.TRIANGLES,a.outlineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a.outlineIndexStart),n.triangleCount+=a.outlineIndexCount/3)}}};class pe extends A{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(i,t){const{context:e,displayLevel:r,state:l,painter:y,pixelRatio:d,spriteMosaic:s,styleLayerUID:v,requestRender:c,allowDelayedRender:x}=i;if(!t.some(h=>h.layerData.get(v)?.lineIndexCount??!1))return;const p=i.styleLayer,D=p.lineMaterial,g=y.vectorTilesMaterialManager,P=p.getPaintValue("line-translate",r),M=p.getPaintValue("line-translate-anchor",r),E=p.getPaintProperty("line-pattern"),U=E!==void 0,f=U&&E.isDataDriven;let _,n;if(U&&!f){const h=E.getValue(r);_=s.getMosaicItemPosition(h)}let a=!1;if(!U){const h=p.getPaintProperty("line-dasharray");if(n=h!==void 0,a=n&&h.isDataDriven,n&&!a){const w=h.getValue(r),T=p.getDashKey(w,p.getLayoutValue("line-cap",r));_=s.getMosaicItemPosition(T)}}const u=1/d,m=this._programOptions;m.pattern=U,m.sdf=n;const o=g.getMaterialProgram(e,D,m);if(x&&c!=null&&!o.compiled)return void c();if(e.useProgram(o),o.setUniformMatrix3fv("u_displayViewMat3",l.displayViewMat3),o.setUniformMatrix3fv("u_displayMat3",M===1?l.displayMat3:l.displayViewMat3),o.setUniform2fv("u_lineTranslation",P),o.setUniform1f("u_depth",p.z),o.setUniform1f("u_antialiasing",u),_&&_!=null){const{page:h}=_,w=s.getPageSize(h);w!=null&&(s.bind(e,9729,h,L),o.setUniform2fv("u_mosaicSize",w),o.setUniform1i("u_texture",L))}let I=-1;for(const h of t){if(!h.layerData.has(v))continue;h.key.level!==I&&(I=h.key.level,D.setDataUniforms(o,r,p,I,s));const w=2**(r-I)/d;o.setUniform1f("u_zoomFactor",w);const T=h.layerData.get(v);if(!T.lineIndexCount)continue;T.prepareForRendering(e);const O=T.vao;if(O!=null){if(e.bindVAO(O),o.setUniformMatrix3fv("u_dvsMat3",h.transforms.displayViewScreenMat3),e.setStencilFunction(514,h.stencilRef,255),f||a){const k=T.patternMap;if(!k)continue;for(const[S,z]of k){const V=s.getPageSize(S);V!=null&&(s.bind(e,9729,S,L),o.setUniform2fv("u_mosaicSize",V),o.setUniform1i("u_texture",L),e.drawElements(N.TRIANGLES,z[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*z[0]))}}else e.drawElements(N.TRIANGLES,T.lineIndexCount,b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*T.lineIndexStart);h.triangleCount+=T.lineIndexCount/3}}}}const ae=256/360,ie=1/Math.LN2;function ne(R,i){return(R%=i)>=0?R:R+i}function B(R){return ne(R*ae,256)}function me(R){return Math.log(R)*ie}const re=1/65536;class ge extends A{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=ee()}dispose(){}drawMany(i,t){const e=i.styleLayer;this._drawIcons(i,e,t),this._drawText(i,e,t)}_drawIcons(i,t,e){const{context:r,displayLevel:l,painter:y,spriteMosaic:d,state:s,styleLayerUID:v,requestRender:c,allowDelayedRender:x}=i,p=t.iconMaterial,D=y.vectorTilesMaterialManager;let g,P=!1;for(const o of e)if(o.layerData.has(v)&&(g=o.layerData.get(v),g.iconPerPageElementsMap.size>0)){P=!0;break}if(!P)return;const M=t.getPaintValue("icon-translate",l),E=t.getPaintValue("icon-translate-anchor",l);let U=t.getLayoutValue("icon-rotation-alignment",l);U===2&&(U=t.getLayoutValue("symbol-placement",l)===0?1:0);const f=U===0,_=t.getLayoutValue("icon-keep-upright",l)&&f,n=g.isIconSDF,a=this._iconProgramOptions;a.sdf=n;const u=D.getMaterialProgram(r,p,a);if(x&&c!=null&&!u.compiled)return void c();r.useProgram(u),u.setUniformMatrix3fv("u_displayViewMat3",U===0?s.displayViewMat3:s.displayMat3),u.setUniformMatrix3fv("u_displayMat3",E===1?s.displayMat3:s.displayViewMat3),u.setUniform2fv("u_iconTranslation",M),u.setUniform1f("u_depth",t.z),u.setUniform1f("u_mapRotation",B(s.rotation)),u.setUniform1f("u_keepUpright",_?1:0),u.setUniform1f("u_level",10*l),u.setUniform1i("u_texture",L),u.setUniform1f("u_fadeDuration",F/1e3),u.setUniform1i("u_isStencilPass",i.stencilSymbols?1:0);let m=-1;for(const o of e){if(!o.layerData.has(v)||(o.key.level!==m&&(m=o.key.level,p.setDataUniforms(u,l,t,m,d)),g=o.layerData.get(v),g.iconPerPageElementsMap.size===0))continue;g.prepareForRendering(r),g.updateOpacityInfo();const I=g.iconVAO;if(I!=null){r.bindVAO(I),u.setUniformMatrix3fv("u_dvsMat3",o.transforms.displayViewScreenMat3),u.setUniform1f("u_time",(performance.now()-g.lastOpacityUpdate)/1e3);for(const[h,w]of g.iconPerPageElementsMap)this._renderIconRange(i,u,w,h,o)}}}_renderIconRange(i,t,e,r,l){const{context:y,spriteMosaic:d}=i;this._spritesTextureSize[0]=d.getWidth(r)/4,this._spritesTextureSize[1]=d.getHeight(r)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),d.bind(y,9729,r,L),this._setStencilState(i,l),y.drawElements(N.TRIANGLES,e[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*e[0]),l.triangleCount+=e[1]/3}_drawText(i,t,e){const{context:r,displayLevel:l,glyphMosaic:y,painter:d,pixelRatio:s,spriteMosaic:v,state:c,styleLayerUID:x,requestRender:p,allowDelayedRender:D}=i,g=t.textMaterial,P=d.vectorTilesMaterialManager;let M,E=!1;for(const V of e)if(V.layerData.has(x)&&(M=V.layerData.get(x),M.glyphPerPageElementsMap.size>0)){E=!0;break}if(!E)return;const U=t.getPaintProperty("text-opacity");if(U&&!U.isDataDriven&&U.getValue(l)===0)return;const f=t.getPaintProperty("text-color"),_=!f||f.isDataDriven||f.getValue(l)[3]>0,n=t.getPaintProperty("text-halo-width"),a=t.getPaintProperty("text-halo-color"),u=(!n||n.isDataDriven||n.getValue(l)>0)&&(!a||a.isDataDriven||a.getValue(l)[3]>0);if(!_&&!u)return;const m=24/8;let o=t.getLayoutValue("text-rotation-alignment",l);o===2&&(o=t.getLayoutValue("symbol-placement",l)===0?1:0);const I=o===0,h=t.getLayoutValue("text-keep-upright",l)&&I,w=.8*m/s;this._glyphTextureSize||(this._glyphTextureSize=te(y.width/4,y.height/4));const T=t.getPaintValue("text-translate",l),O=t.getPaintValue("text-translate-anchor",l),k=this._sdfProgramOptions,S=P.getMaterialProgram(r,g,k);if(D&&p!=null&&!S.compiled)return void p();r.useProgram(S),S.setUniformMatrix3fv("u_displayViewMat3",o===0?c.displayViewMat3:c.displayMat3),S.setUniformMatrix3fv("u_displayMat3",O===1?c.displayMat3:c.displayViewMat3),S.setUniform2fv("u_textTranslation",T),S.setUniform1f("u_depth",t.z+re),S.setUniform2fv("u_mosaicSize",this._glyphTextureSize),S.setUniform1f("u_mapRotation",B(c.rotation)),S.setUniform1f("u_keepUpright",h?1:0),S.setUniform1f("u_level",10*l),S.setUniform1i("u_texture",$),S.setUniform1f("u_antialiasingWidth",w),S.setUniform1f("u_fadeDuration",F/1e3);let z=-1;for(const V of e){if(!V.layerData.has(x)||(V.key.level!==z&&(z=V.key.level,g.setDataUniforms(S,l,t,z,v)),M=V.layerData.get(x),M.glyphPerPageElementsMap.size===0))continue;M.prepareForRendering(r),M.updateOpacityInfo();const C=M.textVAO;if(C==null)continue;r.bindVAO(C),S.setUniformMatrix3fv("u_dvsMat3",V.transforms.displayViewScreenMat3),this._setStencilState(i,V);const W=(performance.now()-M.lastOpacityUpdate)/1e3;S.setUniform1f("u_time",W),M.glyphPerPageElementsMap.forEach((X,j)=>{this._renderGlyphRange(r,X,j,y,S,u,_,V)})}}_renderGlyphRange(i,t,e,r,l,y,d,s){r.bind(i,9729,e,$),y&&(l.setUniform1f("u_halo",1),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3),d&&(l.setUniform1f("u_halo",0),i.drawElements(N.TRIANGLES,t[1],b.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),s.triangleCount+=t[1]/3)}_setStencilState(i,t){const{context:e,is3D:r,stencilSymbols:l}=i;if(e.setStencilTestEnabled(!0),l)return e.setStencilWriteMask(255),void e.setStencilFunction(519,t.stencilRef,255);e.setStencilWriteMask(0),r?e.setStencilFunction(514,t.stencilRef,255):e.setStencilFunction(516,255,255)}}export{ue as a,pe as b,ge as c,me as e,le as m,ce as r,A as t};
