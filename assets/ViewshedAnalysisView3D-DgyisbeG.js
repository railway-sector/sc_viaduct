import{eY as y,cH as te,eH as G,sC as Q,km as S,ix as Qt,iy as Ct,iw as Pt,i7 as he,dq as p,eI as N,eE as ue,GT as Kt,GU as Yt,H6 as Ve,ii as pe,eM as P,ie as Be,dr as K,ds as j,cV as Me,dh as Ee,eF as q,i6 as Xt,iI as Ge,qQ as Jt,n,p as h,u as ie,m9 as ye,d5 as C,gM as At,H7 as be,vY as Ht,sE as Se,dp as Y,wp as ze,dt as Zt,ad as M,cT as x,kZ as Ie,iE as ei,t5 as Le,sB as Ue,ws as Je,o_ as me,H8 as W,wn as ti,pD as ve,fH as ii,pI as si,mD as ai,d8 as le,N as ri,hJ as ke,Ga as oi,za as ni,gh as Ze,hI as li,a$ as hi,i as ci,j1 as di,hO as qe,gO as we,d4 as Et,tA as et,yp as ui,fK as pi,d7 as vi,x$ as wi,ll as fi,lk as mi,yo as gi,mS as zt,hc as _i,pG as Vi,sP as bi,mC as tt,aR as Mi,H9 as it,Ha as yi,Hb as Si,Hc as Di,d as Oi,F8 as Ti,Hd as $i,He as xi,Hf as Ri,v_ as It,nL as Lt,Fg as je,kY as st,vL as Fi,Hg as Ci,Hh as Pi,Hi as Ai,Hj as Hi,FP as at,Gu as Oe,FR as Te,Fi as Ei,Fj as rt,Hk as ot,Hl as zi,Hm as Ii,Fk as Li,Fl as Ui,_ as ki,Hn as ji,Fm as Ni,GM as Wi,Fr as Bi,Ho as Gi,bo as qi,Hp as $e,ma as Qi,mN as Ki,kW as Yi,mM as nt,it as Xi,b3 as Ji,bc as Zi,k2 as es,iD as ts,lz as is,um as ss,fz as as,Hq as rs}from"./index-DxtJ83V_.js";import{s as os,I as ns}from"./featureReferenceUtils-B85nxpkz.js";import{e as ls}from"./AnalysisView3D-hbdmKtYz.js";import{w as hs,j as cs,t as re,Y as De,g as ds,o as us,p as se,a as ps}from"./ShadedColorMaterial.glsl-BDXIgnbc.js";import{P as lt,D as vs}from"./dragEventPipeline3D-CjSNxyPb.js";import{u as ws}from"./Viewshed-jMghyhx8.js";import{y as Ut,o as kt,a as fs,p as ms}from"./MoveManipulation-BT-QzeYG.js";import{p as _e,R as gs,h as xe,f as _s}from"./InteractiveToolBase-KJX1Zv1L.js";import{s as Qe}from"./sliceToolConfig-1JD1unhX.js";import{m as jt}from"./ColorMaterial.glsl-CWGzJyYa.js";import{g as Vs}from"./EditGeometryOperations-FiCEjtqd.js";import{b as bs}from"./settings-D1mWdYSb.js";import{G as Ms}from"./ExtendedLineVisualElement-D3BEvLYT.js";import{c as ys}from"./LaserlinePath.glsl-Cm7ShamG.js";import{o as Ss,m as Ds,f as Os,d as ht}from"./analysisViewUtils-mJBkVTIZ.js";import{o as Ts}from"./ToolIntersector-FyXM-2RI.js";import{x as $s}from"./PointVisualElement-BcBrrFTX.js";import{h as xs}from"./lineStippleUtils-CCavR4OV.js";import"./AnalysisView-B6lPQ_ia.js";import"./VisualElement-BqlQBNTF.js";import"./line-BjcwFX9F.js";import"./TriangleMaterial-D9WJ-qst.js";import"./geometry2dUtils-B4XXC69h.js";import"./rotate-B-mcQBtp.js";import"./curveOperationUtils-D2zS_4Te.js";import"./EngineVisualElement-t2KVw7A4.js";const ct=2,Rs=4,Nt=y(2),Fs=1.5;let Cs=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Rs,this.fovFocusedArcWidth=ct*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ct/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const E=new Cs;class Ps{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new te([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:te.toUnitRGBA(new te([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:1,cullFace:2,writeDepth:!1}}}const J=new Ps;function Ke({tiltedUpVector:i,rightVector:e,observerRenderSpace:t},s){const a=hs(i,e,t,s);return a[12]=0,a[13]=0,a[14]=0,a}function Ne(i,e,t,s){const a=p(),r=Qt(t.plane),o=As(e,r);let l;if(Math.abs(o)>E.viewAngleThreshold)l=i.next(lt(e,t.plane));else{const c=Ct(s.targetRenderSpace,t.basis1,Pt()),u=he(Wt,t.basis1),d=he(Hs,t.basis2);l=i.next(lt(e,c)).next(v=>{const w=T=>{const D=pe(P(dt,T,t.origin),d),R=Math.acos(Be(D/s.farDistanceRenderSpace,-1,1)),A=Math.sin(R)*s.farDistanceRenderSpace;return K(p(),t.origin,K(p(),j(dt,u,A),j(Es,d,D)))},f=w(v.renderStart),m=w(v.renderEnd);return{...v,renderStart:f,renderEnd:m}})}return l.next(c=>{c.action==="start"&&N(a,c.renderStart);const u=ue(cs(a,c.renderEnd,t.origin,r));return{...c,deltaAngle:u}})}function As(i,e){const t=Wt;i.renderCoordsHelper.toRenderCoords(i.camera.position,t);const s=Kt(i,t,i.camera.heading,i.camera.tilt,Yt()).direction;return ue(Ve(s,e))-90}function ee(i,e,t,s){return Q(ut,t,s),G(i,e,ut)}const Wt=p(),Hs=p(),dt=p(),Es=p(),ut=S();var We;let g=We=class extends Me{constructor(i){super(i),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new Ee}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,p())}get target(){const i=this.targetRenderSpace;return this.renderSpaceToPoint(i,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const i=P(p(),this.targetRenderSpace,this.observerRenderSpace);return he(i,i)}get tiltedUpVector(){const i=ee(p(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return he(i,i)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const i=this._basis;return q(i[8],i[9],i[10])}get northVector(){const i=this._basis;return q(i[4],i[5],i[6])}get leftVector(){const i=this.upVector,e=ee(p(),this.northVector,-y(this.heading),i);return Xt(e,i,e)}get rightVector(){return Ge(p(),this.leftVector)}clone(){return new We({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(i,e,t){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=P(Re,a,s);return ee(r,r,-y(e),this.leftVector),ee(r,r,-y(i),this.tiltedUpVector),K(t,r,s)}cornerPoints(i){const e=this.horizontalFieldOfView/2,t=this.verticalFieldOfView/2;this.pointOnSphere(-e,t,i.topLeft),this.pointOnSphere(e,t,i.topRight),this.pointOnSphere(-e,-t,i.bottomLeft),this.pointOnSphere(e,-t,i.bottomRight)}arcCentersPoints(i){const e=this.horizontalFieldOfView/2,t=this.verticalFieldOfView/2;this.pointOnSphere(0,t,i.top),this.pointOnSphere(0,-t,i.bottom),this.pointOnSphere(-e,0,i.left),this.pointOnSphere(e,0,i.right)}parallelCenterPoints(i){const e=this.observerRenderSpace,t=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),s=j(Re,this.tiltedUpVector,t);K(i.top,e,s),P(i.bottom,e,s)}renderSpaceToPoint(i,e){const t=Re;return this.renderCoordsHelper.fromRenderCoords(i,t,e),new Ee(t[0],t[1],t[2],e)}_pointToRenderSpace(i,e){const t=Jt(i.toArray());return this.renderCoordsHelper.toRenderCoords(t,i.spatialReference,e),e}_computeTargetRenderSpace(i){const{leftVector:e,northVector:t,upVector:s}=this,a=this.farDistanceRenderSpace,r=p();return j(r,t,a),ee(r,r,-y(this.heading),s),ee(r,r,-y(this.tiltParallelToSurface),e),K(r,i,r),r}};n([h()],g.prototype,"renderCoordsHelper",void 0),n([h()],g.prototype,"viewshed",void 0),n([h()],g.prototype,"observerRenderSpaceOverride",void 0),n([h()],g.prototype,"needUpdateByFeature",void 0),n([h()],g.prototype,"observer",null),n([h()],g.prototype,"effectiveObserverRenderSpace",null),n([h()],g.prototype,"effectiveObserver",null),n([h()],g.prototype,"effectiveTargetRenderSpace",null),n([h()],g.prototype,"farDistance",null),n([h()],g.prototype,"farDistanceRenderSpace",null),n([h()],g.prototype,"heading",null),n([h()],g.prototype,"tilt",null),n([h()],g.prototype,"feature",null),n([h()],g.prototype,"tiltParallelToSurface",null),n([h()],g.prototype,"horizontalFieldOfView",null),n([h()],g.prototype,"verticalFieldOfView",null),n([h()],g.prototype,"observerRenderSpace",null),n([h()],g.prototype,"target",null),n([h()],g.prototype,"targetRenderSpace",null),n([h()],g.prototype,"targetDirection",null),n([h()],g.prototype,"tiltedUpVector",null),n([h()],g.prototype,"_basis",null),n([h()],g.prototype,"upVector",null),n([h()],g.prototype,"northVector",null),n([h()],g.prototype,"leftVector",null),n([h()],g.prototype,"rightVector",null),n([h()],g.prototype,"valid",null),n([h()],g.prototype,"metersPerUnit",null),g=We=n([ie("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],g);const Re=p();let zs=class extends Ut{constructor(e){super(),this._handles=new ye,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(t=>this._tool.manipulators.add(t))}destroy(){this._handles=C(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const s=Object.values(this._manipulators);return At(s.map(({manipulator:a,side:r})=>_e(a,(o,l,c,u,d)=>{const v=Ns(r,t),w=l.next(m=>({...m,manipulatorType:2,side:r})),f=Ne(w,this._view,v,t);e(o,f,c)})))}updateManipulatorsTransform(e){e.arcCentersPoints(pt),this._forEachManipulatorInfo(t=>this._updateArcManipulatorTransform(t,e,pt[t.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(t=>this._updateArcManipulatorVisuals(t,e))}_updateArcManipulatorVisuals({manipulator:e,side:t},s){const a=[];if(s!=null){const[r,o]=Is(t,s,this._unfocusedArcMaterial);a.push(new re(r,1),new re(r.instantiate({material:this._focusedArcMaterial}),2)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=a,e.radius=E.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:t},s,a){const r=s.horizontalFieldOfView,o=y(s.verticalFieldOfView/2),l=y(r/2),c=fe(t);e.renderLocation=a;const u=S(),d=T=>{Ie(u,T,u)};d(be(oe,y(-90))),c||d(Ht(oe,o));const v=s.farDistanceRenderSpace;let w,f;d(Se(oe,Y(Bt,v,v,v))),d(ze(oe,ks(t))),d(Ke(s,oe)),c?(w=l,f=s.tiltedUpVector):(f=s.rightVector,w=o),w*=t==="right"||t==="bottom"?-1:1;const m=Q(oe,w,f);m!=null&&d(m),e.modelTransform=u}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),s=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:s,bottom:a},[[a.manipulator,s.manipulator],[e.manipulator,t.manipulator]].forEach(([r,o])=>{r.metadata={pairedManipulator:o},o.metadata={pairedManipulator:r}})}_createArcManipulator(e){const t=new De({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:t,side:e};return this._updateArcManipulatorVisuals(s),this._handles.add(t.events.on(["focus-changed","grab-changed"],a=>{const r=t.metadata?.pairedManipulator;r!=null&&(r.hovering!==t.hovering&&(r.hovering=t.hovering),r.grabbing!==t.grabbing&&(r.grabbing=t.grabbing))})),s}_createArcMaterial(e){const t=E.getFovArcWidth(e),s=new Zt({renderOccluded:4,isDecoration:!0,width:t},this._view.state.isGlobal);return this._handles.add(M(()=>te.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>s.setParameters({color:a}),x)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:t})=>e(t,2))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(t=>e(t))}get test(){return{manipulators:this._manipulators}}};function Is(i,e,t){const{horizontalFieldOfView:s,verticalFieldOfView:a}=e,r=fe(i),o=y(Be((r?a:s)/2,0,15)),l=Ls(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[ei(t,l),l]}function Ls(i,e,t,s=10){Le(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=e-i;if(a<=0||t<=0)return[q(0,0,.01),q(0,0,-.01)];const r=[],o=a/s;for(let l=0;l<s;l++){let c=i+l*o;l===s-1&&(c=e);const u=Math.cos(c)*t,d=Math.sin(c)*t,v=q(u-t,0,d);r.push(v)}return r}function Us(i){switch(i){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function ks(i){return Us(i)*Ws}function fe(i){return i==="left"||i==="right"}function js(i){return i==="left"?"right":i==="right"?"left":i==="top"?"bottom":"top"}function Ns(i,{observerRenderSpace:e,targetRenderSpace:t,tiltedUpVector:s,rightVector:a,farDistanceRenderSpace:r}){const o=P(Bt,t,e),l=fe(i)?a:s,c=j(Bs,l,r);return Ue(e,o,c)}const Ws=Math.PI/2,oe=S(),Bt=p(),Bs=p(),pt={top:p(),bottom:p(),left:p(),right:p()};let Fe=class extends De{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.collisionRadius}),this._handles=new ye,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),s=1,a=[q(0,0,0),q(0,0,s)],r=Je(t,a,e,16,!1),o=Je(t,a,e*Qe,16,!1),l=vt(!1,t,e),c=vt(!0,t,e),u=S();me(u,a[a.length-1]),W(u,u,Ht(wt,Math.PI/2)),W(u,u,be(wt,Math.PI/2)),l.transformation=u,c.transformation=u,this.renderObjects=[new re(r,1),new re(o,2),new re(l,1),new re(c,2)];const d=q(0,E.getScaleOrientArrowTipLength(!0),0),v=G(d,d,u),w=[...a,v];this.collisionType={type:"line",paths:[w]}}_createMaterial(){const e=new jt({cullFace:2,renderOccluded:4,isDecoration:!0});return this._handles.add(M(()=>te.toUnitRGBA(this.view.effectiveTheme.accentColor),t=>e.setParameters({color:t}),x)),e}};function vt(i,e,t){const s=E.getScaleOrientArrowTipLength(i);let a=2*t;i&&(a*=Qe);const r=s/2;return ti(e,s,r,r,a,0)}const wt=S();let Gs=class extends Ut{constructor(e){super(),this._handles=new ye,this._tool=e.tool,this._view=e.view;const t=E.scaleOrientHandleRadius;this._manipulatorHeading=new Fe(this._view,t),this._manipulatorTilt=new Fe(this._view,t),this._manipulatorDistance=new Fe(this._view,t),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return _e(this._manipulatorHeading,(s,a,r,o,l)=>{const c=this._view,{tiltParallelToSurface:u,farDistanceRenderSpace:d,upVector:v,observerRenderSpace:w,targetRenderSpace:f,rightVector:m}=t,T=Math.sin(y(u))*d,D=K(ge,w,j(Ce,v,T)),R=P(Ce,f,D),A=j(qs,m,ve(R)),F=Ue(D,R,A),z=Ne(a,c,F,t).next(I=>({...I,manipulatorType:3}));e(s,z,r)})}createTiltDragPipeline(e,t){return _e(this._manipulatorTilt,(s,a,r,o,l)=>{const{observerRenderSpace:c,farDistanceRenderSpace:u,upVector:d,targetDirection:v}=t,w=pe(v,d),f=ii(ge,v,d,-w);j(f,he(f,f),u);const m=j(Ce,d,u),T=Ue(c,f,m),D=Ne(a,this._view,T,t).next(R=>({...R,manipulatorType:3}));e(s,D,r)})}createDistanceDragPipeline(e,t){return _e(this._manipulatorDistance,(s,a,r,o,l)=>{const c=si(t.observerRenderSpace,t.targetDirection),u=a.next(gs(this._view,s.location)).next(vs(this._view,c)).next(d=>({...d,manipulatorType:2}));e(s,u,r)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const s=S(),a=d=>{Ie(s,d,s)},r=E.scaleOrientSize*(kt/fs);a(Se(ce,Y(ge,r,r,r))),a(Ke(e,ce));const o=E.scaleOrientHandleRadius*Qe*r,l=j(ge,e.targetDirection,o);a(me(ce,l));const c=ze(ce,-Pe);W(c,c,be(ft,-Pe)),this._manipulatorHeading.modelTransform=W(S(),s,c);const u=be(ce,Pe);W(u,u,ze(ft,Math.PI)),this._manipulatorTilt.modelTransform=Ie(S(),s,u),this._manipulatorDistance.modelTransform=s}forEachManipulator(e){e(this._manipulatorHeading,3),e(this._manipulatorTilt,3),e(this._manipulatorDistance,2)}};const ce=S(),ft=S(),ge=p(),Ce=p(),qs=p(),Pe=Math.PI/2;let Gt=class extends De{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.observerSize,interactive:!1}),this._handles=new ye;const s=ds(this._color);this.renderObjects=[new re(ai(s,E.observerSize,32,32))],t.manipulators.add(this),this._handles.add([M(()=>this._color,a=>{s.setParameters({color:a})},x)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return te.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([h()],Gt.prototype,"_color",null);const mt=Symbol("dragHandles"),gt=Symbol("hideManipulators"),_t=Symbol("hideFoVManipulators"),Vt=Symbol("hideObserverManipulator");let L=class extends Me{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new zs({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Gs({view:this.view,tool:this.parentTool}),this._observerManipulator=new Gt(this.view,this.parentTool),this.addHandles([M(()=>this.viewshedComputedData?.observerRenderSpace,t=>{t!=null&&(this._moveManipulation.renderLocation=t,this._observerManipulator.renderLocation=t)},le),M(()=>this.viewshedComputedData?.heading,t=>{t&&(this._moveManipulation.angle=y(90-t))},x),M(()=>{const{viewshedComputedData:t}=this;return{viewshedComputedData:t,observer:t?.observer}},({viewshedComputedData:t,observer:s},a)=>{this._grabbing&&s!==a?.observer||(this.removeHandles(mt),t?.valid&&this.addHandles([this._buildObserverDragPipeline(t),this._buildFOVDragPipeline(t),this._buildScaleOrientDragPipeline(t)].filter(ri),mt))},x),M(()=>{const t=this.viewshedComputedData;return t?.valid?{viewshedCompData:t,target:t.targetRenderSpace,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(t.viewshedCompData)},x),M(()=>{const t=this.viewshedComputedData;return t?.valid?{viewshedCompData:t,hFOV:t.horizontalFieldOfView,vFOV:t.verticalFieldOfView,tilt:t.tilt}:null},t=>{t!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(t.viewshedCompData)},x),M(()=>{const t=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:t&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:t&&(!this.parentTool.creating||s)}},({fovManipulationAvailable:t,nonFOVManipulationAvailable:s})=>{this._moveManipulation.available=s,this._scaleOrientManipulation.available=s,this._observerManipulator.available=s,this._fieldOfViewManipulation.available=t},x),M(()=>{const t=this.viewshedComputedData;if(!t?.valid)return null;const{observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}=t;return{viewshedCompData:t,observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}},t=>{t!=null&&this._scaleOrientManipulation.updateManipulators(t.viewshedCompData)},x)]);const e=t=>{const s=this.analysisViewData;this.addHandles([t.events.on("focus-changed",()=>{const a=this._someManipulatorHovering();a&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||a||(this._forceHoveringTask=li(async r=>{await(this._forceHoveringTestPromise??hi(E.hoverTimeoutMilliseconds,r)),ci(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),t.events.on("grab-changed",a=>{this._grabbing=a.action==="start",a.action==="end"&&s.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)}),this._setInteractive(r=>r.hasManipulator(t)||!this._grabbing)}),t.events.on("drag",a=>{a.action==="start"&&s.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(e)}destroy(){this._forceHoveringTask=ke(this._forceHoveringTask),this._moveManipulation=C(this._moveManipulation),this._fieldOfViewManipulation=C(this._fieldOfViewManipulation),this._scaleOrientManipulation=C(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=C(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(e){const t=this.viewshed;t!=null&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t=typeof e=="boolean";this._forEachManipulation(s=>s.interactive=t?e:e(s))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator(s=>{t=t||s===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new ms({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:kt})}_buildObserverDragPipeline(e){const t={mode:"absolute-height",offset:0},s=e.observer;if(s==null)return null;const a=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,o,l,c,u)=>{c=c.next(xe(this,["observer"]));const d=oi(s,a);if(d==null)return{steps:l,cancel:c};const v=Vs.fromGeometry(d,ni(this.view.viewingMode));return{steps:l.next(_s({operations:v})).next(w=>(this.observer=v.data.geometry,w)),cancel:c}},t,a,void 0)}_buildFOVDragPipeline(e){let t=0,s=0;return this._fieldOfViewManipulation.createDragPipeline((a,r,o)=>{if(e==null)return{steps:r,cancel:o};const l=e.viewshed;let c=null;return o=o.next(xe(l,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(u=>{u.action==="start"&&(c=null,t=e.horizontalFieldOfView,s=e.verticalFieldOfView);const d=u.deltaAngle;if(c==null&&d!==0){const f=u.side==="bottom"||u.side==="left"?d>0:d<0;c=fe(u.side)?t===0&&f||t===360&&!f:s===0&&f}const v=c?js(u.side):u.side;let w=0;switch(v){case"left":w=t/2-d;break;case"right":w=t/2+d;break;case"top":w=s+2*d;break;case"bottom":w=s-2*d}return fe(v)?(w=Ze.normalize(w),w=w>270?0:w>180?180:w,l.horizontalFieldOfView=2*w):l.verticalFieldOfView=w,u}),cancel:o}},e)}_buildScaleOrientDragPipeline(e){let t=0,s=0;const a=(r,o)=>(l,c,u)=>{if(e==null)return{steps:c,cancel:u};const d=e.viewshed;return u=u.next(xe(d,[r])),{steps:c=c.next(o(d,e)),cancel:u}};return At([this._scaleOrientManipulation.createHeadingDragPipeline(a("heading",(r,o)=>l=>(l.action==="start"&&(s=e.heading),r.heading=Ze.normalize(s+l.deltaAngle),l)),e),this._scaleOrientManipulation.createTiltDragPipeline(a("tilt",(r,o)=>l=>{l.action==="start"&&(t=e.tilt);let c=t+l.deltaAngle;return c<-90?c=180:c>270&&(c=0),r.tilt=Ks.clamp(c),l}),e),this._scaleOrientManipulation.createDistanceDragPipeline(a("farDistance",(r,o)=>l=>{const c=P(Qs,l.renderEnd,o.observerRenderSpace),u=ve(c)*o.metersPerUnit,d=pe(c,o.targetDirection)<0?E.scaleOrientMinDistance:u;return r.farDistance=d,l}),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=this._forceHoveringTask!=null||this._someManipulatorHovering(),s=this._fieldOfViewManipulation.hovering,a=this.parentTool.creating;let r=[];const o=l=>{r.push(l.disableDisplay())};e||!a&&t?this.removeHandles(gt):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,gt),r=[]),e||!a&&t||a&&s?this.removeHandles(_t):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,_t)),e||!a?this.removeHandles(Vt):this.addHandles(this._observerManipulator.disableDisplay(),Vt)}_resetHoveringTask(){this._forceHoveringTask=ke(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation(t=>{t.forEachManipulator(e)}),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};n([h({constructOnly:!0})],L.prototype,"analysis",void 0),n([h({constructOnly:!0})],L.prototype,"analysisViewData",void 0),n([h({constructOnly:!0})],L.prototype,"parentTool",void 0),n([h({constructOnly:!0,nonNullable:!0})],L.prototype,"view",void 0),n([h()],L.prototype,"viewshed",null),n([h()],L.prototype,"_grabbing",void 0),n([h()],L.prototype,"grabbing",null),n([h()],L.prototype,"viewshedComputedData",void 0),n([h()],L.prototype,"observer",null),L=n([ie("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],L);const Qs=p(),Ks=new di(0,180),Ae=Symbol("interactionVisuals");let O=class extends Ss{constructor(i){super(i),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=yt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new bs({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Ts(this.view.state.viewingMode),this._createInteractionVisuals();const i=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=qe(()=>i,({viewshedComputedData:e})=>{const t=new L({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:t,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),t.destroy()}}}),this.addHandles([we(()=>this._valid,()=>this.finishToolCreation(),le),M(()=>this._stagedViewshed,e=>{const t=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&t!=null?this._findSubTool(e)?.viewshedComputedData:null},le),this.analysis.viewsheds.on("after-remove",e=>{const t=this._stagedViewshed;t!=null&&e.item===t&&this.analysis.viewsheds.add(t)}),M(()=>this.firstGrabbedManipulator,e=>{if(e!=null){const t=this._findSubTool(e)?.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},Et),M(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),we(()=>{const e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:t,observer:s,target:a}=e;t?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):t?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)},x),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,e=>{const t=this._selectedManipulator,s=this._selectedSubTool;e==null?this._selectManipulator(null):t!=null&&s.hasManipulator(t)||this._selectManipulator(s.discManipulator)},x)])}destroy(){this.subToolHandles=C(this.subToolHandles),this.removeHandles(Ae)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some(i=>i.viewshedComputedData.valid)??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(i){const e=this._selectedManipulator;e!==i&&(this._selectedManipulator=i,e!=null&&(e.selected=!1),i!=null&&(i.selected=!0),this._findSubTool(e)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(i){this.analysisViewData.selectedViewshed=i}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:i})=>i.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}place(i){this.selectedViewshed=null,this._placementMode=i,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(i=>i.subTool.onManipulatorSelectionChanged())}onInputEvent(i){switch(i.type){case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":et.cancel===i.key?this._cancelKeyHandler(i):et.delete.includes(i.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(i){i.type==="immediate-click"&&this._clickPlacementHandler(i)}onActivate(){this._placementMode=yt}_clickPlacementHandler(i){if(!this.creating||this.hasFocusedManipulators)return;const e=this._intersectScreen(i,Mt);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+Fs;const t=new ws({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(t),this._stagedViewshed=t,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);const t=this._stagedViewshed;this._stagedViewshed=null,this._placementMode==="multiple"?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=t}i.stopPropagation()}}_doubleClickHandler(i){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(!this.creating)return;const e=this._intersectScreen(i,Mt);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(i){this.creating?this._onCancelWhileCreating(i):this.grabbing||(this.selectedViewshed=null,i.stopPropagation())}_onCancelWhileCreating(i){const e=this.removeStaged();this._finishToolCreationIfValid(),e?(this._creationState="placing-observer",this.selectedViewshed=null,this._placementMode==="multiple"&&i.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(i){const e=this._stagedViewshed,t=this._stagedViewshedComputedData;if(e==null||t==null)return;const{heading:s,tilt:a,farDistance:r}=Ys(this.view,t,i);e.farDistance=r,e.tilt=a,e.heading=s}removeStaged(){const i=this._stagedViewshed;return i!=null&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(i),!0)}_intersectScreen(i,e){const t=ui(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const s=this._intersector.results.min,a=e.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=e.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),r==null?null:(e.feature=pi(s,this.view),e)}_createInteractionVisuals(){this.removeHandles(Ae);const i=this._settings.visualElements,e=new ys({view:this.view,attached:!1,style:{glowWidth:i.heightPlane.glowWidth,innerWidth:i.heightPlane.innerWidth},isDecoration:!0}),t=new Ms({view:this.view,extensionType:i.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:t},this.addHandles([M(()=>i.zVerticalLine,s=>s.apply(t),le),M(()=>i.heightPlane,s=>s.apply(e),le),vi(()=>{e.destroy(),t.destroy(),this._interactionVisualElements=null})],Ae)}updateInteractionVisualsVisibility(i=!1){const e=this.creating,t=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(v,w)=>{const f=this._interactionVisualElements;f!=null&&(f.verticalLine.attached=w,f.laserline.attached=v)};if(e)return void r(t,!1);if(s==null||a==null)return void r(!1,!1);const o=s.moveInteractionState,l=i?o.grabbing:o.dragging,c=s.scaleOrientInteractionState,u=i?c.grabbing:c.dragging,d=t&&(l||u);if(r(d,l),d){const v=l?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(v,l)}}_updateInteractionVisualsLocation(i,e){const t=this._interactionVisualElements;if(t==null)return;const{laserline:s,verticalLine:a}=t;s.heightManifoldTarget=i,s.intersectsWorldUpAtLocation=e?i:null,i!=null&&a.setStartEndFromWorldDownAtLocation(i)}_findSubTool(i){if(i==null)return null;const e=i instanceof De?t=>t.subTool.hasManipulator(i):t=>t.subTool.viewshed===i;return this.subToolHandles?.find(e)?.subTool}get test(){}};function Ys(i,e,t){const s=e.observerRenderSpace,a=P(Xs,t,s),r=ve(a)*e.metersPerUnit,o=i.renderCoordsHelper.basisMatrixAtPosition(s,ea),l=Y(Js,o[8],o[9],o[10]),c=Ct(s,l,ta),u=wi(c,t,Zs),d=P(u,u,s),v=(ve(d)<1e-4?90:ue(Ve(a,d)))*(pe(l,a)<0?-1:1)+90,w=Y(bt,o[4],o[5],o[6]),f=ue(Ve(w,d)),m=Y(bt,o[0],o[1],o[2]);return{heading:pe(d,m)<0?360-f:f,tilt:v,farDistance:r}}n([h({constructOnly:!0})],O.prototype,"view",void 0),n([h()],O.prototype,"analysisViewData",void 0),n([h()],O.prototype,"removeIncompleteOnCancel",void 0),n([h()],O.prototype,"automaticManipulatorSelection",void 0),n([h({constructOnly:!0})],O.prototype,"analysis",void 0),n([h()],O.prototype,"subToolHandles",void 0),n([h()],O.prototype,"_stagedViewshed",void 0),n([h()],O.prototype,"_stagedViewshedComputedData",void 0),n([h()],O.prototype,"_placementMode",void 0),n([h()],O.prototype,"_creationState",void 0),n([h()],O.prototype,"_valid",null),n([h({readOnly:!0})],O.prototype,"cursor",null),n([h()],O.prototype,"_selectedManipulator",void 0),n([h()],O.prototype,"_selectedSubTool",null),n([h()],O.prototype,"selectedViewshed",null),n([h()],O.prototype,"selectedViewshedComputedData",null),n([h()],O.prototype,"stagedViewshed",null),n([h()],O.prototype,"grabbing",null),n([h()],O.prototype,"creating",null),n([h()],O.prototype,"isPlacingTarget",null),O=n([ie("esri.views.3d.analysis.Viewshed.ViewshedTool")],O);const Xs=p(),Js=p(),Zs=p(),bt=p(),ea=S(),ta=Pt(),Mt={mapPoint:new Ee,scenePoint:p(),feature:null},yt="multiple";let ia=class extends us{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new jt({...J.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(e==null)return;const t=S(),s=e.farDistanceRenderSpace;Se(t,q(s,s,s)),Ke(e,de),W(t,de,t),me(de,this._viewshedComputedData.observerRenderSpace),W(t,de,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:s}=this;s==null||t==null||!s.valid||sa(t,s).forEach(a=>e.addGeometry(a))}};function sa(i,e){const{horizontalFieldOfView:t,verticalFieldOfView:s}=e,a=Y(aa,0,0,1),r=Y(Dt,0,1,0),o=Y(Ot,1,0,0);ee(a,a,y(s/2),r),ee(a,a,y(t/2),o);const l=b=>Math.ceil(Math.abs(b)/Nt)+1,c=y(t),u=N(ra,o),d=l(c),v=St(-c/(d-1)),w=Q(de,v,u),f=y(-s),m=l(f),T=St(f/(m-1)),D=N(Dt,r),R=Q(Tt,y(t)/2,o);G(D,D,R);const A=Tt,F=[],z=N(Ot,a);for(let b=0;b<d;b++){Q(A,T,D);for(let _=0;_<m;_++){const V=3*(_*d+b);F[V]=z[0],F[V+1]=z[1],F[V+2]=z[2],G(z,z,A)}G(D,D,w),G(a,a,w),N(z,a)}const I=d*m;F[3*I]=0,F[3*I+1]=0,F[3*I+2]=0;const B=[];for(let b=0;b<d-1;b++)for(let _=0;_<m-1;_++){const V=6*(_*(d-1)+b);B[V]=_*d+b,B[V+1]=(_+1)*d+b,B[V+2]=_*d+b+1,B[V+3]=_*d+b+1,B[V+4]=(_+1)*d+b,B[V+5]=(_+1)*d+b+1}const X=[B];if(t!==360&&s!==0){const b=[],_=[];for(let V=0;V<m-1;V++){const $=3*V;b[$]=I,b[$+1]=(V+1)*d,b[$+2]=V*d,_[$]=I,_[$+1]=V*d+d-1,_[$+2]=(V+1)*d+d-1}X.push(b,_)}if(s!==180&&t!==0){const b=[],_=[];for(let V=0;V<d-1;V++){const $=3*V;b[$]=I,b[$+1]=V,b[$+2]=V+1,_[$]=I,_[$+1]=V+(m-1)*d+1,_[$+2]=V+(m-1)*d}X.push(b,_)}return X.map(b=>{const _=[["position",new fi(F,b,3,!0)]];return new mi(i,_)})}function St(i){return isNaN(i)?1:i}const aa=p(),Dt=p(),Ot=p(),ra=p(),de=S(),Tt=S();let U=class extends Me{constructor(i){super(i),this.visible=!0,this._viewshedCorners={topLeft:p(),topRight:p(),bottomLeft:p(),bottomRight:p()},this._arcCenterPoints={top:p(),bottom:p(),left:p(),right:p()},this._parallelCenters={top:p(),bottom:p()}}initialize(){const i={view:this.view,isDecoration:!0},e={...i,color:this._color,renderOccluded:4},t={...e,stipplePattern:xs(2)};this._observerVisualElement=new $s({...i,...J.observerPointConfiguration}),this._shapeVisualElement=new ia({...i,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new se(e),this._leftArcVisualElement=new se(e),this._rightArcVisualElement=new se(e),this._topArcVisualElement=new se(e),this._bottomArcVisualElement=new se(e),this._centralLongitude=new se(t),this._centralLatitude=new se(t),this.addHandles([M(()=>{const s=this.viewshedComputedData;if(!s?.valid)return null;const a=this._viewshedCorners,r=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(a),s.arcCentersPoints(r),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:a,arcCenters:r,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{const a=s!=null;this._forEachVisualElement(r=>r.attached=a),a&&this._updateVisualElements(s)},{initial:!0,equals:gi}),M(()=>{const{viewshedComputedData:s}=this,{horizontalFieldOfView:a,verticalFieldOfView:r}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:a,verticalFieldOfView:r}},({viewshedComputedData:s})=>{const{_shapeVisualElement:a}=this;s!==a.viewshedComputedData&&(a.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},x),M(()=>{const{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:s,selected:a,staged:r,horFovNot360:o})=>{const l=a||r;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;const c=s&&(a||o);this._leftArcVisualElement.visible=c,this._rightArcVisualElement.visible=c,this._forEachLineVisualElement(u=>{u.width=l?J.frameWidthSelected:J.frameWidthNotSelected,u.renderOccluded=a?4:1}),[this._centralLatitude,this._centralLongitude].forEach(u=>{u.width=2*(l?J.frameWidthSelected:J.frameWidthNotSelected),u.visible=s&&a})},x),M(()=>{const{analysisViewData:{interactive:s,tool:a},_selected:r,visible:o}=this,l=this.view.activeTool,c=!a?.active&&l instanceof O&&l.creating;return{observerVisible:o&&!r&&(!s||(a?.creating??!1)||c),color:this._color}},({observerVisible:s,color:a})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(r=>r.color=a)},x)])}get _color(){const{viewshedComputedData:i,_selected:e,analysisViewData:t}=this;if(i==null)return te.toUnitRGBA(J.frameColor);const s=t.tool?.active||t.interactive,a=i.viewshed===t.tool?.stagedViewshed,r=s&&(e||a)?this.view.effectiveTheme.accentColor:J.frameColor;return te.toUnitRGBA(r)}get _selected(){const{viewshedComputedData:i,analysisViewData:{selectedViewshedComputedData:e}}=this;return i!=null&&i===e}get _staged(){const{analysisViewData:{tool:i},viewshedComputedData:e}=this;return i!=null&&i.creating&&i.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=C(this._observerVisualElement),this._shapeVisualElement=C(this._shapeVisualElement),this._frameLinesVisualElement=C(this._frameLinesVisualElement),this._leftArcVisualElement=C(this._leftArcVisualElement),this._rightArcVisualElement=C(this._rightArcVisualElement),this._topArcVisualElement=C(this._topArcVisualElement),this._bottomArcVisualElement=C(this._bottomArcVisualElement),this._centralLongitude=C(this._centralLongitude),this._centralLatitude=C(this._centralLatitude)}_forEachLineVisualElement(i){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(i)}_forEachVisualElement(i){this._forEachLineVisualElement(i),i(this._observerVisualElement),i(this._shapeVisualElement)}_updateVisualElements(i){const{viewshedComputedData:e,corners:t,arcCenters:s,parallelCenters:a}=i,r=zt(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(r,t),this._updateFrameArcs(e,t,a),this._updateCentralHelperArcs(e,s)}_updateFrameLines(i,e){this._frameLinesVisualElement.geometry=[[i,e.topLeft],[i,e.topRight],[i,e.bottomLeft],[i,e.bottomRight]]}_updateFrameArcs(i,e,t){const{observerRenderSpace:s,rightVector:a,horizontalFieldOfView:r,tiltedUpVector:o}=i,l=y(r),c=p(),u=S();Q(u,l/2,o),G(c,a,u),ne(this._leftArcVisualElement,s,e.bottomLeft,e.topLeft,"forward",c),Q(u,-l/2,o),Y(c,0,0,0),G(c,a,u),ne(this._rightArcVisualElement,s,e.bottomRight,e.topRight,"forward",c);const d=r>180?"backward":"forward";ne(this._topArcVisualElement,t.top,e.topRight,e.topLeft,d,o),ne(this._bottomArcVisualElement,t.bottom,e.bottomRight,e.bottomLeft,d,o)}_updateCentralHelperArcs(i,e){const t=i.observerRenderSpace,s=i.horizontalFieldOfView>=180?"backward":"forward";ne(this._centralLatitude,t,e.right,e.left,s,i.tiltedUpVector),ne(this._centralLongitude,t,e.top,e.bottom,"forward",i.leftVector)}get test(){}};function ne(i,e,t,s,a,r,o=Nt){const l=p();P(l,t,e);const c=ve(l),u=p();P(u,s,e),he(u,u),j(u,u,c);let d=Ve(l,u);const v=zt(r);a==="backward"&&(Ge(v,v),d=-(2*Math.PI-d));const w=[],f=Math.ceil(Math.abs(d)/o),m=S();Q(m,d/f,v);const T=p();N(T,l);const D=p();N(D,t);for(let R=0;R<f;R++){const A=p();N(A,D),G(T,T,m),K(D,e,T);const F=p();N(F,D),w.push([A,F])}i.geometry=w}n([h()],U.prototype,"view",void 0),n([h({constructOnly:!0})],U.prototype,"isDecoration",void 0),n([h()],U.prototype,"analysisViewData",void 0),n([h()],U.prototype,"viewshedComputedData",void 0),n([h()],U.prototype,"visible",void 0),n([h()],U.prototype,"_color",null),n([h()],U.prototype,"_selected",null),n([h()],U.prototype,"_staged",null),U=n([ie("esri.views.3d.analysis.Viewshed.ViewshedSubVisualization")],U);let ae=class extends Me{get visible(){return this.analysisViewData.visible}constructor(i){super(i)}initialize(){const i=this.analysisViewData,e=qe(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:t})=>{const s=new U({view:this.view,viewshedComputedData:t,analysisViewData:i,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._subVisualizations=e,this.addHandles([_i(e),M(()=>this.visible,t=>this._subVisualizations.forEach(({visualization:s})=>s.visible=t),x)])}get test(){}};n([h({constructOnly:!0})],ae.prototype,"analysisViewData",void 0),n([h({constructOnly:!0,nonNullable:!0})],ae.prototype,"view",void 0),n([h({constructOnly:!0})],ae.prototype,"isDecoration",void 0),n([h()],ae.prototype,"visible",null),ae=n([ie("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],ae);let Z=class extends Vi{constructor(){super(...arguments),this.sectionAngles=bi()}get sectionAnglesDeg(){return tt(this.sectionAngles.map(e=>ue(e)))}set sectionAnglesDeg(e){this.sectionAngles=tt(e.map(t=>y(t)))}get projectionMatrix(){return W(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],s=this.sectionAngles[2],a=this.sectionAngles[3];Le(e<=t),Le(s<=a);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),l=Math.tan(e),c=Math.tan(t),u=Math.tan(s),d=c-l,v=Math.tan(a)-u,w=r/d,f=o/v,m=-(l+d/2)/r*2,T=-(u+v/2)/o*2,D=S();me(D,[m,T,0]);const R=S();Se(R,[w,f,1]);const A=S();return W(A,R,D)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),s=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/s)}setViewport(e,t){const s=t*this._sectionRatioX;return this.viewport=[e[0],e[1],s,t],s}};n([h()],Z.prototype,"sectionAngles",void 0),n([h()],Z.prototype,"sectionAnglesDeg",null),n([h()],Z.prototype,"projectionMatrix",null),n([h()],Z.prototype,"sectionMatrix",null),n([h()],Z.prototype,"_sectionRatioX",null),Z=n([ie("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class oa{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const $t=["front","left","right","back","top","bottom"];function na(i){return!["top","bottom"].includes(i)}class la{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new oa,this._maxTextureSize=Math.min(Mi("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(it)}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const e=this.faces;return e.length===0?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach(s=>{e[s]&&(t+=1)}),t}get faces(){const e=this._faces,t=[];for(const s of $t){const a=e[s];a&&t.push(a)}return t}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,t,s,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:l,farDistanceRenderSpace:c,horizontalFieldOfView:u,verticalFieldOfView:d}=t,v=p();P(v,l,r);const w=p(),f=p(),m=(_,V)=>{const $=p(),Xe=S();return Q(Xe,_,V),G($,v,Xe),K($,r,$),$};let T,D=o;const R=Math.min(90,u),A=Math.min(90,Math.max(0,(u-90)/2));let F=-45,z=45,I=-45,B=45;if(na(e)){const _=V=>Be(V,-45,45);I=_(-d/2)-this.settings.toleranceBottomTop,B=_(+d/2)+this.settings.toleranceBottomTop}switch(e){case"front":T=l,F=-R/2,z=R/2;break;case"left":T=m(Math.PI/2,o),F=45-A;break;case"right":T=m(-Math.PI/2,o),z=-45+A;break;case"top":T=K(w,r,o),D=Ge(f,v);break;case"bottom":T=P(w,r,o),D=v;break;case"back":T=m(Math.PI,o)}const X=new Z({center:T,eye:r,up:D,far:c});X.sectionAnglesDeg=[F-this.settings.toleranceSides,z+this.settings.toleranceSides,I,B],X.fovY=Math.PI/2;const b=X.setViewport(s,a);return this._faces[e]=X,b}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:s,verticalFieldOfView:a}=e,r=-a/2,o=a/2;return s===0||a===0||(r<=45&&o>=-45&&t.add("front"),s>90&&(t.add("left"),t.add("right")),s>270&&t.add("back"),o>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize({pixelRatio:e,fullWidth:t,fullHeight:s},a,r,o){const l=a/e,c=this.settings.textureSizeModifier(r);return yi(Math.max(t,s)*l*c,this._maxTextureSize/o)}_ensureFBO(e){const t=this._width,s=this._height,a=this._handle?.fbo;a&&a.width===t&&a.height===s&&e===Si(a.depthStencilTexture?.descriptor?.internalFormat??Di.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){const{_width:t,_height:s}=this,a=e?13:12,r=this._fbos.acquire(t,s,"viewshed shadow map",a);return r.getTexture(it)?.setShadowFiltering(!1),r}clearFBO(e){const t=this._fbos.rctx;this._ensureFBO(e),t.bindFramebuffer(this._handle?.fbo),t.setClearColor(1,1,1,1),t.clear(16640)}dispose(){this._debugFBO||(this._handle=Oi(this._handle))}start(e,t,s,a,r=!1){this._faces={};const o=this._computeActiveFaces(t),l=o.size;if(l===0)return!1;const c=this._computeBaseTextureSize(e,a,s,l);let u=0,d=0,v=0;return $t.filter(w=>o.has(w)).forEach(w=>{const f=ha(w,l);f>d&&(v=Math.max(v,u),u=0),d=f;const m=f*c;u+=this._setupFaceCamera(w,t,[u,m],c)}),v=Math.max(v,u),this._width=this.settings.textureResizeModulo(v),this._height=ca(l)*c,this.clearFBO(r),!0}finish(){}get test(){}}function ha(i,e){if(e<4)return 0;const t=i==="front"||i==="left";return e===4?t?0:1:t||i==="right"?0:1}function ca(i){return i<4?1:2}class da extends Ti{constructor(){super(...arguments),this.localOrigin=$i()}}function ua(i){i.include(xi),i.fragment.uniforms.add(new Ri("inverseViewMatrix",(e,t)=>{const s=It(S(),t.camera.viewMatrix,e.localOrigin);return Lt(s,s)})).code.add(je`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let Ye=class extends da{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=st.flat(),this.viewMatrices=st.flat(),this.volumeOffset=0}};function qt(){const i=new Fi,e=i.fragment;return i.include(Ci),i.include(ua),e.include(Pi),e.include(Ai),e.uniforms.add(new Hi("depthTexture",t=>t.depth?.attachment),new at("inverseProjectionMatrix",t=>t.camera.inverseProjectionMatrix),new at("inverseViewNormalMatrix",({camera:t})=>Lt(pa,t.viewInverseTransposeMatrix)),new Oe("viewshedObserverOffset",t=>t.observerOffset),new Oe("viewshedTargetVector",t=>t.targetVector),new Oe("viewshedUpVector",t=>t.upVector),new Te("viewshedFOVs",t=>t.fovs),new Te("viewshedHeadingAndTilt",t=>t.headingAndTilt),new Te("viewshedNearFar",t=>t.shadowMap.nearFar??[1,100]),new Ei("viewshedVolumeOffset",t=>t.volumeOffset),new rt("viewshedShadowMap",t=>t.shadowMap.depthTexture),new ot("viewshedProjectionMatrices",t=>t.projectionMatrices,6),new ot("viewshedViewMatrices",t=>t.viewMatrices,6),new zi("viewshedNumFaces",t=>t.shadowMap.numActiveFaces),new Ii("viewshedAtlasRegions",t=>t.shadowMap.atlasRegions.flat(),24),new rt("normalMap",t=>t.normals)),e.constants.add("visibleColor","vec4",[0,1,0,.5]),e.constants.add("occludedColor","vec4",[1,0,0,.5]),e.code.add(je`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),e.main.add(je`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),i}const pa=S(),va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ye,build:qt},Symbol.toStringTag,{value:"Module"}));class xt extends Li{constructor(e,t){super(e,t,new Ui(va,()=>ki(()=>Promise.resolve().then(()=>Va),void 0)),ji)}initializePipeline(){return Ni({colorWrite:Bi,blending:Wi})}}let k=class extends Gi{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(i=>ma(this.view,i))}constructor(i){super(i),this.isDecoration=!1,this._passParameters=new Ye,this._viewsheds=new qi,this._shadowMap=null,this.consumes={required:[$e.VIEWSHED,"normals"]},this.produces=$e.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new la(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,i=>{const e=this._shadowMap;e&&(e.settings.textureSizeQuality=i)},x),we(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),M(()=>this._viewshedsInView.map(i=>[i.observerRenderSpace,i.heading,i.tilt,i.farDistance,i.horizontalFieldOfView,i.verticalFieldOfView]),()=>this.requestRender(1),Et)])}destroy(){this._shadowMap=Qi(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(xt);for(const i of this._viewshedsInView)if(this._shadowMap?.isActive(i))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(i){const e=this.bindParameters,t=this.renderingContext,s=i.find(({name:o})=>o===$e.VIEWSHED);if(!this.hasViewsheds||!e.depth||this.isDecoration&&!e.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=i.find(({name:o})=>o==="normals")?.getTexture();const a=this.techniques.get(xt);if(!a?.compiled)return this.requestRender(1),s;const r=this.view.stage.renderer.isFeatureEnabled(7);for(const o of this._viewshedsInView){if(!this._renderShadowCubeMap(e,o,r)||!this._shadowMap?.ready)continue;const l=this._setupViewshedParameters(o,e.camera);t.bindTechnique(a,e,l),t.bindFramebuffer(s.fbo),t.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(i){const e=this._viewsheds,{removes:t,adds:s}=i;if(t&&(Array.isArray(t)?e.removeMany(t):e.remove(t)),s)if(Array.isArray(s)){const a=s.filter(r=>!e.includes(r));e.addMany(a)}else e.includes(s)||e.add(s)}_renderShadowCubeMap(i,e,t){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(i.camera,e,t,this._contentPixelRatio,a);return r&&s.faces.forEach(o=>this.view.stage.renderer.renderViewshedShadowMap(o)),s.finish(),r}_setupViewshedParameters(i,e){const t=this._shadowMap;if(!t)return this._passParameters;const s=this._passParameters,a=i.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=P(_a,i.observerRenderSpace,i.effectiveObserverRenderSpace),s.fovs=[y(i.horizontalFieldOfView),y(i.verticalFieldOfView)],s.headingAndTilt=[y(i.heading),y(i.tiltParallelToSurface)],s.upVector=i.tiltedUpVector;const r=wa(i.targetRenderSpace,a);s.targetVector=r;const o=new Array,l=new Array;for(let c=0;c<t.numActiveFaces;c++)It(He,t.viewshedViewMatrices[c],a),o.push(...He),fa(t.viewshedProjectionMatrices[c],He,Rt),l.push(...Rt);return s.viewMatrices=o,s.projectionMatrices=l,s.volumeOffset=this.selectedViewshed?.()===i.viewshed?ga(i,this.view,e.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function wa(i,e){const t=p();return P(t,i,e)}function fa(i,e,t){const s=q(.5,.5,.5);return me(t,s),Yi(t,t,s),W(t,t,i),W(t,t,e),t}function ma(i,e){const t=Ki(e.observerRenderSpace,e.farDistanceRenderSpace);return!!i.ready&&i.frustum.intersectsSphere(t)}function ga(i,e,t){if(i==null)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=i,r=nt(t,s)>nt(t,a)?i.observer:i.target;return e.pixelSizeAt(r)}n([h()],k.prototype,"selectedViewshed",void 0),n([h()],k.prototype,"isDecoration",void 0),n([h()],k.prototype,"shadowMap",null),n([h()],k.prototype,"hasViewsheds",null),n([h()],k.prototype,"_contentPixelRatio",null),n([h()],k.prototype,"_viewshedsInView",null),n([h()],k.prototype,"consumes",void 0),n([h()],k.prototype,"produces",void 0),k=n([ie("esri.views.3d.webgl-engine.lib.Viewshed")],k);const _a=p(),He=S(),Rt=S();let H=class extends ls{constructor(i){super(i),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(i){super.visible=i}get interactive(){return super.interactive}set interactive(i){super.interactive=i}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(i){this._unselectOtherViewsheds(i),this._selectedViewshed=i}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const i=this.view;this._viewshedRenderNode=new k({view:i,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new Xi(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=qe(()=>this.analysis.viewsheds,e=>{const t=new g({renderCoordsHelper:i.renderCoordsHelper,viewshed:e}),s=Symbol();return this.addHandles([M(()=>({valid:t.valid,canProject:Zi(t.observer?.spatialReference,this.view.spatialReference)||es()}),({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(t):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(t),r||ps(this.analysis,t.observer.spatialReference,Ji.getLogger(this)))},x),...this._createFeatureReferenceHandles(t)],s),{viewshedComputedData:t,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(t),t.destroy()}}}),this._visualization=new ae({view:i,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([M(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles;if(t==null)return;e||(this.selectedViewshed=null);const s=t.map(a=>a.viewshedComputedData).filter(a=>a.valid).toArray();e?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),M(()=>i.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:t})=>t.renderCoordsHelper=e)}),Ds(this,O),we(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},le)])}destroy(){this.userOperation=ke(this.userOperation),Os(this),this._visualization=C(this._visualization);const i=this.viewshedComputedDataHandles;i!=null&&this._removeViewshedsFromRenderer(i.map(e=>e.viewshedComputedData).toArray())}_createFeatureReferenceHandles(i){const{view:e}=this;return[M(()=>[e.state.camera,e.slice.plane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(e,i)},x),this._createElevationUpdateHandle(i),we(()=>i.needUpdateByFeature,()=>{this._updateObserverFromFeature(e,i),i.needUpdateByFeature=!1})]}_createElevationUpdateHandle(i){const e=(t,s)=>{const{view:a}=this,{observer:r}=i;if(r==null)return;const o=is(r,a.spatialReference);if(o.pending!=null)return void o.pending.finally(()=>e(t,s));const l=o.geometry;l!=null&&(ss(t,s,Ft,a.spatialReference),rs(Ft,[l.x,l.y])&&(i.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:t,spatialReference:s})=>e(t,s))}async createViewsheds(i){await ht(this,{placementOptions:i,onToolActivated:e=>e.place("multiple")})}place(i){return ht(this,{placementOptions:i,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(i){this._viewshedRenderNode.updateViewsheds({adds:i})}_removeViewshedsFromRenderer(i){this._viewshedRenderNode.updateViewsheds({removes:i})}_updateObserverFromFeature(i,e){const t=e.observerRenderSpace,s=e.targetRenderSpace,a=N(p(),t),r={observer:t,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:os(e.feature),target:s,targetSurfaceNormal:null,targetAdjusted:N(p(),s),targetFeatureId:null};ns(i,this._intersector,r,o=>Math.min(o,.05*e.farDistanceRenderSpace)),e.observerRenderSpaceOverride=ts(a,t)?null:a}_unselectOtherViewsheds(i){if(i!=null)for(const e of this.view.tools.items)e!==this.tool&&e instanceof O&&(e.analysisViewData.selectedViewshed=null)}get test(){}};n([h({readOnly:!0})],H.prototype,"type",void 0),n([h({constructOnly:!0,nonNullable:!0})],H.prototype,"analysis",void 0),n([h()],H.prototype,"tool",void 0),n([h()],H.prototype,"_selectedViewshed",void 0),n([h()],H.prototype,"selectedViewshed",null),n([h()],H.prototype,"selectedViewshedComputedData",null),n([h()],H.prototype,"viewshedComputedDataHandles",void 0),n([h()],H.prototype,"userOperation",void 0),n([h()],H.prototype,"_visualization",void 0),n([h()],H.prototype,"_viewshedRenderNode",void 0),H=n([ie("esri.views.3d.analysis.ViewshedAnalysisView3D")],H);const ir=H,Ft=as(),Va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ye,build:qt},Symbol.toStringTag,{value:"Module"}));export{ir as default};
