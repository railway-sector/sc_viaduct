import{mK as be,cV as he,k as Z,sy as De,b3 as I,ad as _,d4 as V,sz as y,n as r,p as o,u as G,sA as Me,mf as Se,gO as Ce,d8 as k,d5 as z,pp as M,sB as u,sC as S,fJ as Ee,sD as Te,ii as T,sE as K,fG as E,pE as Q,eI as W,iU as c,ds as R,dr as Y,sF as ee,iw as j,is as H,dq as q,ix as A,sG as $e,sH as b,eH as te,mS as xe,i7 as ie,m$ as ke,aF as ae,io as He,iq as Le,dp as ue,sI as pe,kZ as ce,dn as ze,sJ as de,hc as se}from"./index-Ct1aZOha.js";import{e as Ge}from"./AnalysisView3D-DJOp8j1Z.js";import{c as L}from"./SlicePlane-DBHjMoIA.js";import{L as Oe,U as Ie,R as Re,w as ye,_ as Ae,j as _e,h as ve,r as ne,t as Be,n as Fe,a as Ue,x as f,s as J,c as Ke,u as je,d as qe,l as Je,e as we,f as ge,o as Ne,g as Xe}from"./SlicePlaneMaterial.glsl-DuEzxi7g.js";import{a as Ze,j as Qe}from"./ShadedColorMaterial.glsl-CrkvtOGL.js";import{l as We,n as Ye}from"./Factory-OpmYgie7.js";import{h as le,b as et}from"./RotateManipulator-DeCpqeNl.js";import{m as tt,M as Pe,r as B,t as F,p as it,f as at,h as st,j as nt}from"./sliceToolConfig-iYXU4Iix.js";import{P as $}from"./dragEventPipeline3D-Bk38oyUY.js";import{o as lt,m as rt,f as ot,d as ht,y as ut}from"./analysisViewUtils-QkpblsJE.js";import{p as x}from"./InteractiveToolBase-BQfBBoxH.js";import{o as pt}from"./ToolIntersector-B0-E3jhT.js";import{h as ct}from"./lineStippleUtils-CCavR4OV.js";import"./AnalysisView-DtabUPXw.js";import"./DefaultLayouts-BvEFGvp3.js";import"./TriangleMaterial-Bx7U5ASE.js";import"./ColorMaterial.glsl-BT4DF5Ng.js";import"./VisualElement-n_9jcDTA.js";import"./line-BlSZU7E7.js";import"./ImageMaterial.glsl-BhxwV8AH.js";import"./EditGeometryOperations-0avqYTq-.js";import"./geometry2dUtils-BTBTaDZn.js";import"./rotate-BKS3kKoo.js";import"./curveOperationUtils-CNmRsuEQ.js";function dt(i){switch(i.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"gaussian-splat":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:case"imagery":case"imagery-tile":return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return be(i.type),!1}}let g=class extends he{constructor(i){super(i),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",i=>{const e=i.item;e!=null&&(e instanceof Z||e instanceof De)?e instanceof Z&&dt(e)?(I.getLogger(this).error("excludedLayers",`Layer '${e.title}, id:${e.id}' of type '${e.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),i.preventDefault()):this.analysis.excludedLayers.includes(e)&&i.preventDefault():(I.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),i.preventDefault())})),vt(this.view,this),this.addHandles([_(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},V),_(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),V),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),_(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()},V),_(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([_(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},V),_(()=>this.analysis.origin?.type!=="web-scene",()=>this._updateViewSlicePlaneDecoration(),V)],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slice.plane=null,this._updateActiveController(),this._updateViewSlicePlane()),wt(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const i=this.view.allLayerViews.items;return i.concat(i.filter(Oe).flatMap(({sublayerViews:e})=>e.items))}_updateBoundedPlaneFromSlicePlane(){const i=this.analysis.shape,e=this._currentSlicePlane;if(e==null&&i==null||e!=null&&i!=null&&i.equals(e))return;let t=null,a=null;if(i?.position!=null){const s=i.position.spatialReference,n=Ie(i,this.view);n==null&&Ze(this.analysis,s,I.getLogger(this)),t=Re(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},y()),t!=null&&(a=new L({heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}))}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=t,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const i=this.analysisViewData.plane,e=ye(i,this.view,this.view.spatialReference,new L);let t=null;e!=null&&(t=new L({heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})),this._currentSlicePlane=t,this._internalChange=!0,this.analysis.shape=e,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(U)return;const i=X(this.view);if(i)if(this.analysisViewData.active)i.activeController!=null&&i.activeController!==this?(U=!0,i.activeController.analysisViewData.active=!1,U=!1):i.activeController!=null&&i.activeController,this._updateLayerViews(),i.activeController=this;else{if(i.activeController!=null&&i.activeController!==this)return;i.activeController!=null&&i.activeController===this&&(i.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){yt(this.view)}_updateViewSlicePlaneDecoration(){_t(this.view)}_updateLayerViews(){const i=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,e=[],t=a=>{"layers"in a?a.layers.forEach(t):e.push(a)};this.analysis.excludedLayers.forEach(t),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=i&&!e.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=i&&!e.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=i&&!this.analysis.excludeGroundSurface)}};r([o()],g.prototype,"view",void 0),r([o()],g.prototype,"analysis",void 0),r([o()],g.prototype,"analysisViewData",void 0),r([o()],g.prototype,"_allLayerAndSubLayerViews",null),g=r([G("esri.views.3d.analysis.Slice.SliceController")],g);const P=new Map;let U=!1;function yt(i){const e=X(i),t=e?.activeController;t?.analysisViewData.plane!=null&&t.analysisViewData.visible?i.slice.plane=t.analysisViewData.plane:i.slice.plane=null}function _t(i){const e=X(i),t=e?.activeController;i.slice.isDecoration=t?.analysis.origin?.type!=="web-scene"}function vt(i,e){P.has(i)||P.set(i,{all:[],activeController:null}),P.get(i)?.all.push(e)}function X(i){return P.get(i)}function wt(i,e){if(!P.has(i))throw new Error("view expected in global slice register");const t=P.get(i),a=t?.all.lastIndexOf(e)??-1;if(!t||a===-1)throw new Error("controller expected in global slice register");t.all.splice(a,1),t.all.length===0&&P.delete(i)}var N,m;let h=(m=class extends lt{constructor(e){super(e),this._clock=Me,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._mode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=tt,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=y(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Se(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=pt(e.view.state.viewingMode)}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const e=l=>{this._updateManipulatorsInteractive(l),l.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},t=new Ae(this.view,1);this.shiftManipulator=t,this.manipulators.add(t),this.addHandles([this._createShiftDragPipeline(t),t.events.on("grab-changed",l=>{this._onShiftGrab(l),e(t)})]);const a=!this.view.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result,s=new le(this.view,(l,d)=>We(this.view.stage.textures,{accentColor:l,contrastColor:d,preMultiplyAlpha:a}));this.rotateHeadingManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateHeadingDragPipeline(s),s.events.on("grab-changed",l=>{this._onRotateHeadingGrab(l),e(s)})]);const n=new le(this.view,(l,d)=>Ye(this.view.stage.textures,{accentColor:l,contrastColor:d,preMultiplyAlpha:a}));this.rotateTiltManipulator=n,this.manipulators.add(n),this.addHandles([this._createRotateTiltDragPipeline(n),n.events.on("grab-changed",l=>{this._onRotateTiltGrab(l),e(n)})]),this.resizeManipulators=this._resizeHandles.map((l,d)=>{const v=new et(this.view,l);return this.addHandles([this._createResizeDragPipeline(v),v.events.on("grab-changed",D=>{this._onResizeGrab(D,d),e(v)})]),v}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=_e(this.view),this._previewPlaneOutlineVisualElement=ve(this.view),this._previewPlaneOutlineVisualElement.width=Pe,this.addHandles(_(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),V)),this.addHandles([Ce(()=>this.state==="sliced",()=>{this.finishToolCreation(),this.stop()},k),_(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=z(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=z(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this.active?this._placingSlicePlane||this.mode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null:null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",e)}get mode(){return this._mode}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=e!=null&&e.type==="resize",this._updateMaterials()}get _placingSlicePlane(){return this.active&&!this.inputState&&this._mode==="place"}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}start(e){this._finishToolCreationIfValid(),this._mode=e,this.active||(this.view.activeTool=this)}stop(){this.active&&(this.view.activeTool=null)}onActivate(){this._finishToolCreationIfValid(),this._mode==="none"&&this.analysisViewData.plane==null&&(this._mode="place")}onDeactivate(){this._mode="none",this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!oe(e))return;this._placingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!oe(e))return;this._mode==="exclude"?e.defer(async()=>{await this._onClickExcludeLayer(e)&&e.stopPropagation()}):this._onClickPlacePlane(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&t!=null&&t.type==="shift"){const a=M(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:a,screenPoint:a}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(M(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const t=M(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(!this._placingSlicePlane)return!1;const t=M(e),a=y();if(this._pickPlane(t,!1,this._activeKeyModifiers,a)){if(e.type==="pointer-drag"){const s=S(this.view.state.camera,t,C);this.inputState=re(s,e.pointerId,a.origin,a)}return u(a,this._startPlane),this.analysis.shape=ye(a,this.view,this.view.spatialReference,new L),e.type!=="pointer-drag"&&this.stop(),!0}return!1}async _onClickExcludeLayer(e){if(this.mode!=="exclude")return!1;const t=await this.view.hitTest(M(e)),a=t.results.at(0);if(a){const s=a.type==="graphic"&&a.graphic;if(s){const n=Te(s.origin)??s.sourceLayer??s.layer;n&&n.type!=="subtype-sublayer"&&this.analysis.excludedLayers.push(n)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0;return this.stop(),!0}_onKeyDown(e){return(e.key===B||e.key===F)&&(this._activeKeyModifiers[e.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==B&&e.key!==F||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=S(this.view.state.camera,e.screenPoint,C);u(this.analysisViewData.plane,this._startPlane),this.inputState=re(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return x(e,(t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="shift")return;const l=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,y()):null;a.next($(this.view,n.shiftPlane)).next(this._shiftDragAdjustSensitivity(n)).next(this._shiftDragUpdatePlane(n)),s.next(()=>{l!=null&&this._updateBoundedPlane(l)})})}_shiftDragAdjustSensitivity(e){return t=>{if(this.analysisViewData.plane==null)return null;const a=.001,s=Math.min((1-Math.abs(T(K(this.analysisViewData.plane),t.ray.direction)/E(t.ray.direction)))/a,1),n=-Q(this._startPlane.plane,t.renderEnd),l=-Q(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-s)+n*s-l,t}}_shiftDragUpdatePlane(e){return()=>{if(this.analysisViewData.plane==null)return;const t=W(c.get(),this._startPlane.origin),a=W(c.get(),K(this._startPlane));R(a,a,-e.depth),Y(a,a,t);const s=ee(a,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,y());this._updateBoundedPlane(s)}}_onRotateHeadingGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ne(this.analysisViewData.plane,this.view.renderCoordsHelper,1,j()),a=S(this.view.state.camera,e.screenPoint,C),s=q();H(t,a,s)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:s})}_createRotateHeadingDragPipeline(e){return x(e,(t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="rotate")return;const l=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,y()):null;a.next($(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdatePlaneFromRotate()),s.next(()=>{l!=null&&this._updateBoundedPlane(l)})})}_onRotateTiltGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ne(this.analysisViewData.plane,this.view.renderCoordsHelper,2,j()),a=S(this.view.state.camera,e.screenPoint,C),s=q();H(t,a,s)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:s})}_createRotateTiltDragPipeline(e){return x(e,(t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="rotate")return;const l=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,y()):null;a.next($(this.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdatePlaneFromRotate()),s.next(()=>{l!=null&&this._updateBoundedPlane(l)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(this.analysisViewData.plane==null)return null;const a=A(e.rotatePlane),s=Qe(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,a);return{...t,rotateAxis:a,rotateAngle:s}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(this.analysisViewData.plane==null)return;const t=$e(b.get(),e.rotateAngle,e.rotateAxis);if(t==null)return;const a=te(c.get(),this._startPlane.basis1,t),s=te(c.get(),this._startPlane.basis2,t),n=ee(this.analysisViewData.plane.origin,a,s,y());this._updateBoundedPlane(n)}}_onResizeGrab(e,t){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const a=S(this.view.state.camera,e.screenPoint,C),s=c.get();H(this.analysisViewData.plane.plane,a,s)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:xe(s)})}_createResizeDragPipeline(e){return x(e,(t,a,s)=>{const n=this.inputState;if(n==null||n.type!=="resize"||this.analysisViewData.plane==null)return;const l=u(this.analysisViewData.plane,y());a.next($(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(n)),s.next(()=>{this._updateBoundedPlane(l)})})}_resizeDragUpdatePlane(e){return t=>{if(this.analysisViewData.plane==null)return;const a=this._resizeHandles[e.activeHandleIdx],s=Be(a,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(s)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(t==null)throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){if(this.mode==="exclude")return;let a=this._previewPlane;if(this._previewPlane=null,e==null)return this._removeFrameTask(),void this._updateManipulators();if(this.active){const s=a??y();if(a=a!=null?u(a,gt):null,this._pickPlane(e,!0,t,s)){const n=at;let l=!1;a!=null&&(l=T(A(a.plane),A(s.plane))<n||T(ie(c.get(),a.basis1),ie(c.get(),s.basis1))<n),l&&(this._previewPlaneOpacity=0),this._previewPlane=s}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=ke({update:({deltaTime:s})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+s/(1e3*it),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=ae(this._frameTask)}_pickMinResult(e){const t=He(e,Le.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,a,s){const n=this._pickMinResult(e),l=c.get();if(!n.getIntersectionPoint(l))return!1;const d=n.getTransformedNormal(c.get()),v=this.view.state.camera;T(d,v.viewForward)>0&&R(d,d,-1);const D=Fe(l,v),me=(t?1:-1)*D*st,O=R(c.get(),d,me);Y(O,O,l);const fe=this.analysis.tiltEnabled?3:0,Ve=a[B]?2:a[F]?1:fe;return Ue(O,d,D,D,v,Ve,this.view.renderCoordsHelper,s),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=ae(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=f,this.rotateHeadingManipulator.state|=f,this.rotateTiltManipulator.state|=f,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~f,this.rotateHeadingManipulator.state&=~f,this.rotateTiltManipulator.state&=~f},this._pointerMoveTimerMs)}_updateManipulators(){if(N.disableEngineLayers)return;let e,t,a=!1;if(this.analysisViewData.plane!=null)e=this.analysisViewData.plane,t=this._previewPlane??e,a=!1;else{if(this._previewPlane==null)return this._setManipulatorVisibility(!1),void this._setPreviewPlaneVisibility(!1);t=e=this._previewPlane,a=!0}if(this._setManipulatorVisibility(!a),!a){const s=J(e,b.get());Ke(this.shiftManipulator,s,e,this.view.state.camera),je(this.rotateHeadingManipulator,s,e,this.view.renderCoordsHelper),qe(this.rotateTiltManipulator,s,e),this.resizeManipulators.forEach((n,l)=>Je(n,this._resizeHandles[l],s,e))}this._setPreviewPlaneVisibility(!this._creatingPointerId&&(a||this._mode==="place")),this._updatePreviewPlaneTransform(t),this._updateMaterials()}_setManipulatorVisibility(e){this.shiftManipulator.available=e,this.rotateHeadingManipulator.available=e,this.rotateTiltManipulator.available=e&&this.analysis.tiltEnabled,this.resizeManipulators.forEach(t=>t.available=e)}_updatePreviewPlaneTransform(e){const t=J(e,b.get()),a=ue(c.get(),E(e.basis1),E(e.basis2),1),s=pe(b.get(),a),n=ce(s,t,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n}_setPreviewPlaneVisibility(e){const t=this._previewPlaneOutlineVisualElement,a=this._previewPlaneGridVisualElement;e&&(t.attached=!0,a.attached=!0),t.visible=e,a.visible=e}_updateMaterials(){const e=we(this.view.effectiveTheme);e[3]*=this._previewPlaneOpacity;const t=ze(ge);t[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=e,this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=de}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}_finishToolCreationIfValid(){this.analysis.valid&&this.finishToolCreation()}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}},N=m,m.disableEngineLayers=!1,m);function re(i,e,t,a){const s=Ne(t,K(a),i.direction,j()),n=q();return H(s,i,n)?{type:"shift",creatingPointerId:e,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function oe(i){return i.pointerType!=="mouse"||i.button===0}r([o()],h.prototype,"_clock",void 0),r([o({constructOnly:!0})],h.prototype,"view",void 0),r([o()],h.prototype,"analysisViewData",void 0),r([o({readOnly:!0})],h.prototype,"state",null),r([o({readOnly:!0})],h.prototype,"cursor",null),r([o()],h.prototype,"analysis",null),r([o()],h.prototype,"removeIncompleteOnCancel",void 0),r([o()],h.prototype,"_mode",void 0),r([o()],h.prototype,"mode",null),r([o({value:null})],h.prototype,"inputState",null),r([o()],h.prototype,"_placingSlicePlane",null),r([o()],h.prototype,"_creatingPointerId",null),h=N=r([G("esri.views.3d.analysis.Slice.SliceTool")],h);const gt=y(),C=Ee();let w=class extends he{constructor(i){super(i),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const i=this.analysisViewData;if(i==null)throw new Error("expected internal object to be valid");this._gridVisualElement=_e(this.view),this._outlineVisualElement=ve(this.view),this.addHandles([_(()=>{const e=i.plane!=null&&this.analysisViewData.visible,{active:t}=this.analysisViewData,{preview:a,showGrid:s,view:n}=this,{effectiveTheme:l}=n;return{visible:e,active:t,preview:a,showGrid:s,gridColor:Xe(l),outlineColor:we(l)}},e=>this._updateMaterials(e),k),_(()=>i.plane,e=>this._updatePlane(e),k),se(this._gridVisualElement),se(this._outlineVisualElement),_(()=>this.analysis?.origin?.type!=="web-scene",e=>{this._gridVisualElement.isDecoration=e,this._outlineVisualElement.isDecoration=e},k)])}destroy(){this.set("view",null)}_updatePlane(i){if(i==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const e=ue(c.get(),E(i.basis1),E(i.basis2),1),t=pe(b.get(),e),a=J(i,b.get()),s=ce(t,a,t);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:i,active:e,preview:t,showGrid:a,gridColor:s,outlineColor:n}){this._outlineVisualElement.color=n,this._outlineVisualElement.width=t?Pe:nt,this._outlineVisualElement.stipplePattern=e?null:ct(5),this._gridVisualElement.backgroundColor=ge,this._gridVisualElement.gridColor=a?s:de,this._gridVisualElement.visible=i,this._outlineVisualElement.visible=i}};r([o()],w.prototype,"view",void 0),r([o()],w.prototype,"analysis",void 0),r([o()],w.prototype,"analysisViewData",void 0),r([o()],w.prototype,"showGrid",void 0),r([o()],w.prototype,"preview",void 0),w=r([G("esri.views.3d.analysis.Slice.SliceVisualization")],w);let p=class extends Ge{constructor(i){super(i),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.plane=null,this.active=!0,this.userOperation=null,this._analysisVisualization=null,this._analysisController=null}initialize(){this._analysisVisualization=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this._analysisController=new g({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(rt(this,h))}destroy(){ot(this),this._analysisVisualization=z(this._analysisVisualization),this._analysisController=z(this._analysisController)}get visible(){return super.visible}set visible(i){super.visible=i}get interactive(){return super.interactive}set interactive(i){super.interactive=i}get editable(){return!this._analysisVisualization.preview}set editable(i){this._analysisVisualization.preview=!i}get showGrid(){return this._analysisVisualization?.showGrid??!1}set showGrid(i){this._analysisVisualization&&(this._analysisVisualization.showGrid=i)}get testData(){}place(i){return this.active=!0,ht(this,{placementOptions:i,onToolActivated:e=>e.start("place")})}async pickLayerToExclude(i){return this.active=!0,ut(this,{abortOptions:i,onToolActivated:e=>e.start("exclude")})}};r([o({readOnly:!0})],p.prototype,"type",void 0),r([o({constructOnly:!0,nonNullable:!0})],p.prototype,"analysis",void 0),r([o()],p.prototype,"tool",void 0),r([o()],p.prototype,"plane",void 0),r([o()],p.prototype,"active",void 0),r([o()],p.prototype,"editable",null),r([o()],p.prototype,"showGrid",null),r([o()],p.prototype,"userOperation",void 0),r([o()],p.prototype,"_analysisVisualization",void 0),r([o()],p.prototype,"_analysisController",void 0),p=r([G("esri.views.3d.analysis.SliceAnalysisView3D")],p);const Ut=p;export{Ut as default};
