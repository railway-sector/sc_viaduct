const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/intersectsOperator-4jJxzAUe.js","assets/ProjectionTransformation-DJw8vIrE.js","assets/Envelope2D-B1YlPmej.js","assets/Point2D-Du6jZy4Y.js","assets/Transformation2D-C7RgHm9s.js","assets/SimpleGeometryCursor-B92kdZ15.js","assets/index-Dqeu25xh.js","assets/index-CyDNYl1c.css","assets/OperatorDefinitions-DP7_WWTp.js","assets/jsonConverter-DjhxjbyB.js","assets/OperatorIntersects-CxGCOonV.js","assets/apiConverter-Bbx8mRGv.js","assets/simplifyOperator-CaPnIHvQ.js","assets/operatorSimplify-BGY4sFeK.js","assets/unionOperator-ECZyWP_l.js","assets/operatorUnion-BfMdyiGX.js"])))=>i.map(i=>d[i]);
import{bl as k,sl as M,sm as U,sn as D,lQ as $,hZ as z,n as g,p as h,u as L,cS as C,aQ as H,cT as Q,b3 as O,cV as q,lX as G,lZ as J,gp as Z,N as W,bc as X,he as N,f as R,_ as A,qD as S,k2 as Y,k3 as B,hJ as K}from"./index-Dqeu25xh.js";import{a as ee,n as te,b as re}from"./TemporalSceneLayerView-JH-gD5S_.js";import{d as ne}from"./LayerView-ipM9LArx.js";const ie={setAttribute(){},rollback(){},commit(){}};function ye(e,r){const t=r.attributes[e.objectIdField];if(t==null)return ie;const n=e.sessions.get(t);if(n)return n;const l=k(r.attributes),a=new Set,d=e.i3sOverrides.createInteractiveEditSession(t),c=new Map,f=(i,u)=>{const p=c.get(i);if(p==null){const y=u.indexOf(t);return c.set(i,y),y}return p};let s=0;const o={setAttribute(i,u){if(s!==0)return;const p=e.fieldsIndex.get(i);if(!p)return;const y=e.attributeStorageInfo.findIndex(b=>b.name===p.name);if(y<0)return;if(!(i in l))throw new Error(`Attribute "${i}" is not an attribute of the edited feature.`);d.setAttribute(y,u);const F=e.attributeStorageInfo[y];let _=!1;a.add(i),e.forEachNode((b,I)=>{const E=f(b,I);if(E===-1)return;const x=e.getAttributeData(b.index);if(x){const v=x[F.name];v&&(v[E]=u,e.setAttributeData(b.index,x,r),_=!0)}}),_&&e.clearMemCache()},rollback(){if(s===0){for(const i of a)this.setAttribute(i,l[i]);d.remove(),s=1,e.sessions.delete(t)}},commit(){s===0&&(d.remove(),s=2,e.sessions.delete(t))}};return e.sessions.set(t,o),o}function oe(e,r,t){const{gidToFeatureInfo:n,oidToFeatureInfo:l,fieldsIndex:a,objectIdField:d,globalIdField:c,featureOrIdentifierList:f}=t;if(!t.featuresResolved&&f!=null){for(const s of f){const o={feature:null,oid:-1,gid:null};if("attributes"in s){o.feature=s;const i=s.attributes;if(i!=null)for(const u in i){if(o.oid!==-1&&o.gid!=null)break;const p=a.normalizeFieldName(u);p===d&&(o.oid=i[u]??-1),p===c&&(o.gid=i[u])}}else o.oid=s.objectId??-1,o.gid=s.globalId;o.gid!=null&&n.set(o.gid,o),o.oid!==-1&&l.set(o.oid,o)}t.featuresResolved=!0}return(e!==-1?l.get(e):null)??(r!=null?n.get(r):null)}function j(e,r,t,n,l=null,a=!0){const d=[],c={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:t==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:t};for(const f of r){if(f.error!=null)continue;const s=f.objectId??-1,o=f.globalId,i=(s===-1||a?oe(s,o,c):null)??{feature:null,oid:s,gid:o},u={oid:s===-1?i.oid:s,gid:o??i.gid,feature:i.feature,result:f};d.push(u);const p=u.gid?M(u.gid):null;if(u.oid===-1&&p!=null&&l!=null&&(u.oid=l.get(p)??-1),u.oid===-1&&p!=null){let y=n.get(p);y==null&&(y={gid:u.gid,edits:[]},n.set(p,y)),y.edits.push(u)}}return d}async function he(e,r){const t=new Map,n=j(e,r.addedFeatures,r.edits?.addFeatures,t),l=j(e,r.updatedFeatures,r.edits?.updateFeatures,t),a=j(e,r.deletedFeatures,r.edits?.deleteFeatures,t,r.globalIdToObjectId,!1);return t.size>0&&await se(e,t),{adds:n.filter(d=>d.oid!==-1),updates:l.filter(d=>d.oid!==-1),deletes:a.filter(d=>d.oid!==-1)}}async function se(e,r){const t=e.i3sOverrides.layer.associatedLayer;if(t?.globalIdField==null)return;const n=t.createQuery(),{objectIdField:l,globalIdField:a}=t;n.where=Array.from(r.values()).map(({gid:f})=>`${a}='${f}'`).join(" OR "),n.returnGeometry=!1,n.outFields=[l,a],n.cacheHint=!1;const d=await U(D(t,n));if(!d.ok)return;const c=d.value.features;for(const f of c){const s=f.attributes[a],o=f.attributes[l];if(s==null||o==null||o===-1)continue;const i=r.get(M(s));if(i!=null)for(const u of i.edits)u.oid=o}}function me(e,r){const t=new Map,n=l=>{for(const{oid:a,feature:d}of l){const c=d?.geometry;c?.type==="mesh"&&t.set(a,c)}};n(r.adds),n(r.updates);for(const l of r.deletes)t.set(l.oid,null);for(const[l,a]of t)e.i3sOverrides.updateGeometry(l,a)}function be(e,r){const t=ae(e,r),n=le(e,r);if(t.size===0&&n.size===0)return;const l=new Map;for(let u=0;u<e.attributeStorageInfo.length;u++)l.set(e.attributeStorageInfo[u].name,u);let a=!1;t.forEach((u,p)=>{const y=e.getAttributeData(p);let F=!1;u.forEach((_,b)=>{const I=y!=null?y[b]:null,E=l.get(b);for(const{featureIndex:x,value:v,featureId:V}of _)I&&(I[x]=v,F=!0,a=!0),e.i3sOverrides.updateAttributeValue(V,E,v)}),F&&e.setAttributeData(p,y,null)}),a&&e.clearMemCache();const{fieldsIndex:d,i3sOverrides:c,objectIdField:f,globalIdField:s}=e,o=c.layer.associatedLayer?.infoFor3D,i=new Set(o?[...Object.values(o.assetMapFieldRoles),...Object.values(o.transformFieldRoles)]:[]);for(const[u,p]of n){c.featureAdded(u);const{attributes:y}=p;for(const F in y){if(F!==f&&F!==s&&i.has(F))continue;const _=d.normalizeFieldName(F),b=_!=null?l.get(_):null;if(b==null)continue;const I=y[F];c.updateAttributeValue(u,b,I)}}}function le(e,r){const t=new Map,n=r.adds;if(!n||n.length===0||e.globalIdField==null)return t;for(const l of n){const a=l.oid,d=l.feature;d?.geometry?.type==="mesh"&&t.set(a,d)}return t}function ae(e,r){const t=r.updates;if(!t||t.length===0)return new P;const n=new P,l=new Map;for(let a=0;a<e.attributeStorageInfo.length;a++)l.set(e.attributeStorageInfo[a].name,a);return e.forEachNode((a,d)=>{for(const c of t){if(c.feature==null)continue;const f=c.feature,s=c.oid,o=d.indexOf(s);for(const i in f.attributes){const u=e.fieldsIndex.normalizeFieldName(i),p=de(n,a.index,u),y=f.attributes[i];p.push({featureIndex:o,featureId:s,value:y})}}}),n}function de(e,r,t){const n=ue(e,r),l=t!=null&&n.get(t);if(l)return l;const a=new Array;return n.set(t,a),a}function ue(e,r){const t=e.get(r);if(t)return t;const n=new ce;return e.set(r,n),n}const ce=Map,P=Map;function Fe(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:t}=this;return e.outFields?$(r,[...z(r,e.outFields),...t]):$(r,t)}}}}const T=e=>{const r=e;let t=class extends r{constructor(){super(...arguments),this._updatingHandles=new C,this._numUpdating=0}get updating(){return this._numUpdating>0||this._updatingHandles.updating}destroy(){this._updatingHandles.destroy()}autoUpdateAsync(n,l){const a=H(async d=>{++this._numUpdating;try{const c=await d;this.destroyed||this._set(n,c)}catch{O.getLogger(this).warn(`Async update of "${String(n)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating});return this._updatingHandles.add(l,a,Q)}};return g([h()],t.prototype,"_updatingHandles",void 0),g([h({readOnly:!0})],t.prototype,"updating",null),g([h()],t.prototype,"_numUpdating",void 0),t=g([L("esri.core.AsyncUpdate")],t),t};T(q);let w=class extends T(q){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:t,labelingFields:n,viewFilterFields:l}=this;return $(e,[...r??[],...t??[],...n??[],...l??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:r}=this.layer;return r?this._getFieldsAsync(t=>r.collectRequiredFields(t,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(r=>G(r,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,mergedFilter:r}=this.layerView;return this._getFieldsAsync(t=>J(t,e,r))})])}async _getFieldsAsync(e){const r=new Set;try{return await e(r),Array.from(r).sort()}catch(t){return O.getLogger(this).error(t),null}}};g([h()],w.prototype,"layerView",void 0),g([h()],w.prototype,"layer",null),g([h()],w.prototype,"requiredFields",null),g([h()],w.prototype,"rendererFields",void 0),g([h()],w.prototype,"labelingFields",void 0),g([h()],w.prototype,"viewFilterFields",void 0),w=g([L("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],w);let m=class extends ne{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryOperators=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return ee(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(e==null||e.geometries.length<1)return null;if(!this._geometryOperators||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return te;const[r,t,n]=this._geometryOperators,l=e.geometries.at(0).spatialReference,a=e.geometries.toArray().map(s=>{let o;try{o=t.execute(s)}catch{return O.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(!o)return null;if(o.spatialReference.equals(l))return o;try{return Z(o,l)}catch{return O.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(W).sort((s,o)=>s.extent.xmin-o.extent.xmin),d=new Set,c=new Array,f=new Array;for(let s of a){const o=s.extent.xmin;if(c.length=0,d.forEach(i=>{if(o>=i.extent.xmax)return f.push(i),void d.delete(i);s.extent.ymin<=i.extent.ymax&&s.extent.ymax>=i.extent.ymin&&r.execute(s,i)&&c.push(i)}),c.length>0){let i;c.push(s);try{i=n.executeMany(c)}catch{O.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}c.pop(),i&&(c.forEach(u=>d.delete(u)),s=i)}d.add(s)}return d.forEach(s=>f.push(s)),f.length>0?{spatialRelationship:e.spatialRelationship,geometries:f}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const r=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:t})=>!t.equals(r)&&!X(t,r))}get layerFilterUpdating(){return re(this._layerFilter)}initialize(){const{signal:e}=this._abortController;N(()=>this.destroyed||!this._geometryOperators&&this.layer?.filter?.geometries?.length,e).then(async()=>{R(e),this._geometryOperators=await Promise.all([A(()=>import("./intersectsOperator-4jJxzAUe.js").then(r=>r.i),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])),A(()=>import("./simplifyOperator-CaPnIHvQ.js").then(r=>r.s),__vite__mapDeps([12,3,1,2,4,5,6,7,8,9,13,11])),A(()=>import("./unionOperator-ECZyWP_l.js").then(r=>r.u),__vite__mapDeps([14,3,1,2,4,5,6,7,8,9,15,11]))])}).catch(S),this._projectionEngineLoaded=Y(),N(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{R(e),await B(),this._projectionEngineLoaded=!0}).catch(S)}destroy(){this._abortController=K(this._abortController)}highlight(e,r){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}};g([h()],m.prototype,"layer",void 0),g([h()],m.prototype,"availableFields",null),g([h()],m.prototype,"maximumNumberOfFeatures",null),g([h({readOnly:!0})],m.prototype,"maximumNumberOfFeaturesExceeded",null),g([h()],m.prototype,"filter",void 0),g([h({readOnly:!0})],m.prototype,"layerFilter",null),g([h({readOnly:!0})],m.prototype,"_layerFilter",null),g([h()],m.prototype,"_geometryOperators",void 0),g([h()],m.prototype,"_projectionEngineLoaded",void 0),g([h()],m.prototype,"_filterNeedsProjectionEngine",null),g([h()],m.prototype,"layerFilterUpdating",null),m=g([L("esri.views.layers.SceneLayerView")],m);export{w as a,be as b,Fe as c,me as d,m as f,ye as i,he as u};
