import{F9 as K,aD as Ae,vM as Q,Hh as be,Fk as G,Hm as $e,Fj as Pe,Fh as E,Fl as X,Fm as Y,_ as ee,Ho as Fe,Fn as te,Fs as se,Hp as re,Hq as v,ad as A,Ha as oe,n as u,p as h,u as R,oK as Ee,FQ as Re,FP as xe,v$ as Ce,km as S,t6 as Oe,HJ as ie,HK as U,HL as Se,la as L,sZ as Te,l8 as Me,cV as ae,cT as F,d5 as I,cH as W,dy as Ve,bo as ke,hO as qe,dh as De,G as He,dE as Ne,hB as je,jM as ze,dq as Ge,gp as Ue,jN as Le,nC as Ie,kR as We,dv as Be,bJ as B,l2 as Ze,b3 as Je,e as Ke}from"./index-BYdCJpuA.js";import{e as Qe}from"./earcut-D9gy186-.js";import{t as Xe}from"./operatorDensify-DgQAvVy3.js";import{e as Ye}from"./operatorSimplify-CFQ9V4ft.js";import{fromSpatialReference as et,fromPolygon as tt,toPolygon as st}from"./apiConverter-DurhOsEr.js";import{r as rt,X as ot}from"./Graphics3DExtrudeSymbolLayer-MuPVmIAT.js";import{R as it}from"./OutlineVisualElement-Bn2KNiT4.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./ProjectionTransformation-BjCEbUuM.js";import"./Envelope2D-B1YlPmej.js";import"./Point2D-Du6jZy4Y.js";import"./Transformation2D-C7RgHm9s.js";import"./OperatorDefinitions-DP7_WWTp.js";import"./jsonConverter-C6lgsHRd.js";import"./SnappingCandidate-DGkpYqI6.js";import"./renderingInfoUtils-ZZ1du2Dd.js";import"./triangulationUtils-Cxsdfi_d.js";import"./deduplicate-06K1UwGq.js";import"./EngineVisualElement-Dh49M2c3.js";import"./VisualElement-9yf4w6LO.js";import"./LaserlinePath.glsl-BiZDqwsz.js";import"./line-C4DvaXHe.js";import"./line-BXL18cLM.js";class T extends K{constructor(){super(...arguments),this.effect=0,this.fadeFactor=Ae(1)}}function ne(){const e=new Q;return e.include(be),e.outputs.add("fragColor","vec4",0),e.fragment.uniforms.add(new G("colorTexture",t=>t.color),new G("focusArea",t=>t.focusArea),new $e("focusAreaEffectMode",t=>t.effect),new Pe("fadeFactor",t=>t.fadeFactor.value)).main.add(E`
      float mask = texture( focusArea, uv, 0.0 ).r;
      vec4 color = texture( colorTexture, uv, 0.0 );
      vec4 colorDeSaturate = vec4(color.r * 0.25 + color.g * 0.5 + color.b * 0.25);
      if (focusAreaEffectMode == ${E.int(0)}) {
        fragColor = mask > 0.0 ? color : mix(color, 0.55 * colorDeSaturate + 0.45, fadeFactor);
      } else {
        fragColor = mask > 0.0 ? color : mix(color, 0.33 * color, fadeFactor);
      }
  `),e}const at=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:T,build:ne},Symbol.toStringTag,{value:"Module"}));let Z=class extends X{constructor(t,r){super(t,r,new Y(at,()=>ee(()=>Promise.resolve().then(()=>mt),void 0)),Fe)}initializePipeline(){return te({colorWrite:se})}},_=class extends re{constructor(t){super({...t,view:t.focusAreasView.view}),this.consumes={required:[v.FOCUSAREA_COLOR,v.FOCUSAREA]},this.produces=v.FOCUSAREA_COLOR,this._fadeDirection=0,this._passParameters=new T}precompile(){this.techniques.precompile(Z)}fadeOut(t){this.removeAllHandles(),this._startTime=null,this._fadeDirection=1,this.addHandles(A(()=>this._passParameters.fadeFactor.value,r=>{r===0&&(this.removeAllHandles(),t())})),this.requestRender(2)}render(t){const r=this.techniques.get(Z),l=t.find(({name:w})=>w===this.produces);if(!r.compiled)return this.requestRender(1),l;const n=this.focusAreasView.style,a=this.bindParameters,i=a.camera,s=i.fullViewport[2],o=i.fullViewport[3];this._startTime??=this.view.stage?.renderer.renderContext.time;const f=this.view.qualitySettings.fadeDuration,c=f>0?Math.min(f,this.view.stage?.renderer.renderContext.time-this._startTime)/f:1,d=t.find(({name:w})=>w===v.FOCUSAREA),m=this.fboCache.acquire(s,o,this.produces),p=this.renderingContext;return p.bindFramebuffer(m.fbo),this._passParameters.color=l.getTexture(),this._passParameters.focusArea=d.getTexture(),this._passParameters.effect=nt[n],this._passParameters.fadeFactor.value=this._fadeDirection===0?c:1-c,p.bindTechnique(r,a,this._passParameters),p.screen.draw(),m.attachDepth(l.getAttachment(oe)),c<1&&this.requestRender(2),m}};u([h()],_.prototype,"consumes",void 0),u([h()],_.prototype,"produces",void 0),u([h({constructOnly:!0})],_.prototype,"focusAreasView",void 0),_=u([R("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],_);const nt={bright:0,dark:1};let M=class extends K{constructor(){super(...arguments),this.origin=Ee}};function le(){const e=new Q;return e.attributes.add("position","vec3"),e.outputs.add("fragColor","vec4",0),e.vertex.uniforms.add(new Re("proj",t=>t.camera.projectionMatrix),new xe("view",(t,r)=>Ce(lt,r.camera.viewMatrix,t.origin))).main.add(E`gl_Position = proj * view * vec4(position, 1.0);
gl_Position.z = min(gl_Position.z, gl_Position.w);`),e.fragment.main.add(E`fragColor = vec4(1., 0., 0., 0.);`),e}const lt=S(),ct=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:M,build:le},Symbol.toStringTag,{value:"Module"}));class J extends X{constructor(t,r){super(t,r,new Y(ct,()=>ee(()=>Promise.resolve().then(()=>pt),void 0)),Oe(ie))}initializePipeline(){return te({colorWrite:se,depthTest:{func:515}})}}let g=class extends re{constructor(e){super({...e,view:e.focusAreasView.view}),this.consumes={required:[U.TRANSPARENT]},this.produces=v.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new M}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(J)}render(e){const t=this.techniques.get(J),r=this.bindParameters,l=r.camera,n=l.fullViewport[2],a=l.fullViewport[3];if(!t.compiled||!this._vaos)return void this.requestRender(1);const i=e.find(({name:c})=>c===U.TRANSPARENT),s=this.renderingContext,o=this.fboCache.acquire(n,a,v.FOCUSAREA,2);this.view.stage.renderer.occludedRequiresStencil?(o.acquireDepth(13),s.blitFramebuffer(i.fbo,o.fbo,256)):o.attachDepth(i.getAttachment(oe)),s.bindFramebuffer(o.fbo),s.setClearColor(0,0,0,1),s.clear(17408),s.setViewport(0,0,n,a);const f=s.bindTechnique(t,r);s.setFaceCullingEnabled(!1),s.setStencilTestEnabled(!0),s.setStencilOpSeparate(1028,7680,34055,7680),s.setStencilOpSeparate(1029,7680,34056,7680),s.setDepthWriteEnabled(!1);for(let c=0;c<this._vaos.length;c++){const d=this._vaos[c],m=this._counts[c];this._maskParameters.origin=this._origins[c],f.bindDraw(r,Se,this._maskParameters),s.bindVAO(d),s.setDepthTestEnabled(!0),s.setStencilWriteMask(255),s.setStencilFunction(519,0,255),s.setColorMask(!1,!1,!1,!1),s.drawArrays(L.TRIANGLES,0,m),s.setDepthTestEnabled(!1),s.setStencilWriteMask(0),s.setStencilFunction(517,0,255),s.setColorMask(!0,!0,!0,!0),s.drawArrays(L.TRIANGLES,0,m)}return o}updateGeometries(){this.view.stage&&(this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0,this.focusAreasView.volumes.forEach(e=>{const t=new Array;let r=0,l=0;e.geometryVolumes.forEach(a=>{const i=a.indicesBottom;r+=i.length;for(let o=0;o<i.length;o++)t.push(a.positions[3*(i[o]-1)]),t.push(a.positions[3*(i[o]-1)+1]),t.push(a.positions[3*(i[o]-1)+2]);const s=a.indicesExtruded;l+=s.length;for(let o=0;o<s.length;o++)t.push(a.positions[3*s[o]]),t.push(a.positions[3*s[o]+1]),t.push(a.positions[3*s[o]+2])});const n=new Te(this.renderingContext,new Me(this.renderingContext,ie,new Float32Array(t)));this._vaos.push(n),this._counts.push(r+l),this._origins.push(e.origin)}),this.requestRender(1))}};u([h()],g.prototype,"consumes",void 0),u([h()],g.prototype,"produces",void 0),u([h({constructOnly:!0})],g.prototype,"focusAreasView",void 0),g=u([R("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],g);let y=class extends ae{constructor(e){super(e)}initialize(){this.addHandles([A(()=>this.area.enabled,()=>this._ensureElement(),F),A(()=>this.area.outline?.color,e=>this._updateColor(e),F),A(()=>this.area.geometries,e=>this._updateGeometries(e),F)])}destroy(){this.removeAllHandles(),this._outlineElement=I(this._outlineElement)}_ensureElement(){this.area.enabled&&this.area.outline?.color?this._outlineElement??=new it({view:this.view,geometry:this._mergePolygons(this.area.geometries),isDraped:!0,attached:!0,isDecoration:!1,color:W.toUnitRGBA(this.area.outline?.color),renderOccluded:4,width:3}):this._outlineElement=I(this._outlineElement)}_updateGeometries(e){this._ensureElement(),this._outlineElement&&(this._outlineElement.geometry=this._mergePolygons(e))}_updateColor(e){this._ensureElement(),this._outlineElement&&e&&(this._outlineElement.color=W.toUnitRGBA(e))}_mergePolygons(e){if(!e||e.length===0)return null;const t=e.at(0).clone();return t.rings.length=0,e.forEach(r=>t.rings.push(...r.rings)),t}};u([h({constructOnly:!0})],y.prototype,"view",void 0),u([h({constructOnly:!0})],y.prototype,"area",void 0),y=u([R("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaOutlineItem")],y);const ut=2e4;let P=class extends ae{constructor(e){super(e),this._volumes=new Map,this._elevationContext=new Ve,this._outlineMap=new ke}initialize(){this.addHandles([A(()=>({polygons:this.polygons,ready:this.view.basemapTerrain?.ready}),({polygons:e,ready:t})=>{t&&this._updateVolumes(e)},F)]),this._outlineMap=qe(()=>this.areas?.areas,e=>new y({area:e,view:this.view}),{recycleItems:!0})}destroy(){this.removeAllHandles(),this._outlineMap.destroy()}get areas(){return this.view.map?.focusAreas}get enabledAreas(){return this.areas?.areas.toArray().filter(({enabled:e})=>e)??[]}get style(){return this.areas?.style??"bright"}get polygons(){return this.enabledAreas.reduce((e,t)=>e.concat(t.geometries.toArray()),new Array)}containsGeometry(e){if(this.polygons.length===0)return!0;const t=new De(e);return this.polygons.some(r=>r.contains(t))}_updateVolumes(e){this._extrude(e),this._ensureRenderNodes()}_extrude(e){if(!this.view.renderCoordsHelper||He(Array.from(this._volumes.keys()),e))return;const t=this.view.renderCoordsHelper,r=Ge(),l=t.viewingMode===1,n=S(),a=S(),i=this.view.spatialReference,s=et(i),o=Ne(i).radius/je.radius,f=ze(5e5*o,"meters",i,!0);l||t.worldUpAtPosition([0,0,0],r);const c=new Map;for(const d of e){const m=this._volumes.get(d);if(m)c.set(d,m);else try{const p=i.equals(d.spatialReference)?d:Ue(d,i),w=Math.max(p.extent.width,p.extent.height),ce=Le(w,i,"meters",!0),x=Math.max(5*ce,ut*o),ue=l?o/10:o,V=this._reduceGeometryHeight(p,x,ue),C=Ie(V);if(C==null)continue;const k=tt(V),de=Ye(k,s,!1)??k,he=Xe(de,f,0,0),q=st(he,i);if(q==null)continue;We(i,[C.x,C.y,0],n,t.spatialReference),a[12]=-n[12],a[13]=-n[13],a[14]=-n[14];const me=rt(q,this.view.elevationProvider,t,this._elevationContext),{polygons:pe,mapPositions:fe,position:_e}=me,D=new Array,ge=new dt(D,[n[12],n[13],n[14]]);for(const b of pe){const ve=b.count,O=Qe(b.mapPositions,b.holeIndices,3);if(O.length===0)continue;const H=O.length,N=6*ve,we=N+H,$=Be(3*N),j=B(we),z=B(H);ot(_e,fe,O,b,$,null,null,null,j,z,x,r,l),Ze($,$,a);const ye=new ht($,z,j,x);D.push(ye)}c.set(d,ge)}catch(p){Je.getLogger(this).error(new Ke("focusareasview:projection-failed","Failed to project focus area geometry to view spatial reference",{geometry:d,error:p}))}}this._volumes=c,this.volumes.size!==0&&this._maskRenderNode?.updateGeometries()}_ensureRenderNodes(){if(this.view.stage)if(this.volumes.size===0){const{_maskRenderNode:e,_colorRenderNode:t}=this;this._maskRenderNode=this._colorRenderNode=null,t?.fadeOut(()=>{e?.destroy(),t?.destroy()})}else this._maskRenderNode??=new g({focusAreasView:this}),this._colorRenderNode??=new _({focusAreasView:this}),this.view.stage.renderView.requestRender()}_reduceGeometryHeight(e,t,r){const l=-12e5*r,n=Math.max(-t/2,l),a=e.rings.map(s=>s.map(o=>[o[0],o[1],n])),i=e.clone();return i.rings=a,i.hasZ=!0,i}get volumes(){return this._volumes}};u([h()],P.prototype,"_volumes",void 0),u([h({constructOnly:!0})],P.prototype,"view",void 0),P=u([R("esri.views.3d.FocusAreasView")],P);class dt{constructor(t,r){this.geometryVolumes=t,this.origin=r}}class ht{constructor(t,r,l,n){this.positions=t,this.indicesBottom=r,this.indicesExtruded=l,this.height=n}}const mt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaColorPassParameters:T,build:ne},Symbol.toStringTag,{value:"Module"})),pt=Object.freeze(Object.defineProperty({__proto__:null,FocusAreaMaskDrawParameters:M,build:le},Symbol.toStringTag,{value:"Module"}));export{P as FocusAreasView};
