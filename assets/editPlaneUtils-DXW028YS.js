import{cV as Nt,bo as _t,cS as jt,he as wt,n as s,p as r,u as $,eZ as xt,kC as pt,dp as Bt,dq as we,xv as xe,vA as Oe,hF as et,eG as be,eI as $e,dr as X,j2 as Te,di as ut,an as qt,y9 as ke,v3 as it,j0 as Pe,ya as Ve,xQ as Wt,uV as Yt,uY as B,kg as S,iA as Se,bH as Me,A$ as Ce,dh as Kt,hI as Ie,ad as C,B0 as Ot,d8 as Q,d4 as De,d5 as E,bg as Ee,d7 as W,dj as Re,gI as Ue,i8 as Ge,ks as bt,B1 as He,gg as ze,d3 as Ze,gN as $t,bl as Tt,mf as Qt,iC as Jt,il as Ae,xw as Xt,ik as Le,sv as Fe,lp as z,iq as Z,h3 as kt,B2 as Ne,B3 as je,g_ as Be,h1 as qe,h5 as Pt,B4 as nt,eF as We,kk as Vt,oK as St,ds as Mt,zR as Ct}from"./index-DxtJ83V_.js";import{r as M,V as Ye,R as Ke,E as Qe,c as Je,H as Xe}from"./SketchTooltipInfo-Dqw8HNFl.js";import{n as ti}from"./GraphicsLayer-DRyMrADs.js";import{a as J,i as at}from"./dehydratedFeatureComparison-DU5Wbj9R.js";import{W as ei,k as It,v as ii,b as Dt,U as ni,T as oi,j as Et,R as si}from"./createUtils-1ZpJ5zaE.js";import{h as q,M as ri,j as ai,I as te,w as ee,Q as li,U as ci}from"./TooltipInfoWithCoordinates-BMbJj7Lc.js";import{R,j as ie,U as pi,x as ui}from"./angularMeasurementUtils-BnLV1BP3.js";import{f as U,L as dt,M as di,N as ne,K as hi,P as oe,Q as gi,D as mi,U as yi,g as fi,R as vi,w as _i,S as wi,C as xi}from"./euclideanLengthMeasurementUtils-BfBxW_4V.js";import{r as Oi,p as lt,U as bi}from"./InteractiveToolBase-KJX1Zv1L.js";import{l as se,c as re}from"./SketchOptions-ByYjNE_g.js";import{w as $i,g as Ti,a as ki,V as Pi,t as Vi,b as Si,o as Mi,l as Ci}from"./EditGeometryOperations-FiCEjtqd.js";import{e as Rt}from"./SnappingContext-AT5RUCVl.js";import{f as Ii}from"./SnappingDragPipelineStep-mvOVHWr7.js";import{p as Di}from"./SnappingOperation-DX1cZ44V.js";const ht={UndoRedoUpdating:"Cannot perform operation whilst undo redo is updating",UndoInvalidError:"There are no items to Undo",RedoInvalidError:"There are no items to Redo"};class A extends Error{constructor(){super(ht.UndoRedoUpdating),this.type="undo-redo-updating-error"}}let Ei=class extends Error{constructor(){super(ht.UndoInvalidError),this.type="undo-redo-undo-error"}};class Ut extends Error{constructor(){super(ht.RedoInvalidError),this.type="undo-redo-redo-error"}}let T=class extends Nt{constructor(){super(...arguments),this._stack=new _t,this._stackPosition=-1,this._updatingHandles=new jt}get updating(){return this._updatingHandles.updating}get canUndo(){return this.hasUndo&&!this.updating}get hasUndo(){return this._stackPosition>=0}get canRedo(){return this.hasRedo&&!this.updating}get hasRedo(){return this._stackPosition<this._stack.length-1}_truncateForwardStack(){this._stack.splice(this._stackPosition+1,this._stack.length-this._stackPosition).forEach(t=>t.destroy())}_drainStack(){this._stack.drain(t=>t.destroy()),this._stackPosition=-1}async undo(){if(!this.hasUndo)throw new Ei;if(this.updating)throw new A;const t=this._stack.getItemAt(this._stackPosition);t&&await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(1),--this._stackPosition,t.canRedo||this._truncateForwardStack()})())}async redo(){if(!this.hasRedo)throw new Ut;if(this.updating)throw new A;const t=this._stack.getItemAt(this._stackPosition+1);if(!t)throw new Ut;await this._updatingHandles.addPromise((async()=>{await t.executeUndoRedoOperation(2),++this._stackPosition})())}peekUndo(){if(this.canUndo)return this._stack.getItemAt(this._stackPosition)}peekRedo(){if(this.canRedo)return this._stack.getItemAt(this._stackPosition+1)}async inject(t){if(this.updating)throw new A;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),t.canUndo?(this._stack.splice(this._stackPosition+1,0,t),this._stackPosition++):this._stackPosition>-1&&(this._stack.splice(0,this._stackPosition+1).forEach(i=>i.destroy()),this._stackPosition=-1)})())}async add(t){if(this.updating)throw new A;await this._updatingHandles.addPromise((async()=>{t.status===0&&await t.executeUndoRedoOperation(0),this._stackPosition>=-1&&this._truncateForwardStack(),t.canUndo?(this._stack.push(t),this._stackPosition=this._stack.length-1):this._drainStack()})())}async removeTagged(t,i=!1){if(this.updating&&!i)return;await wt(()=>!this.updating);const n=new _t;for(let o=0;o<this._stack.length;o++){const a=this._stack.getItemAt(o);a&&(a.tag===t?(a.destroy(),o===this._stackPosition&&(this._stackPosition=n.length-1)):n.push(a))}this._stack=n,this._stackPosition>n.length-1&&(this._stackPosition=n.length-1)}async clear(t=!1){if(this.updating&&!t)throw new A;await wt(()=>!this.updating),this._drainStack()}};s([r()],T.prototype,"_stack",void 0),s([r()],T.prototype,"_stackPosition",void 0),s([r()],T.prototype,"updating",null),s([r({readOnly:!0})],T.prototype,"canUndo",null),s([r({readOnly:!0})],T.prototype,"hasUndo",null),s([r({readOnly:!0})],T.prototype,"canRedo",null),s([r({readOnly:!0})],T.prototype,"hasRedo",null),T=s([$("esri.UndoRedo")],T);let Ri=class{constructor(){this.committedVertices=null,this.cursorVertex=null,this.full=null,this.outline=null,this.cursorEdge=null,this.circle=null,this.rectangle=null}};function G(e,t,i){if(e==null)return"noTool";switch(e){case"point":return Ui();case"multipoint":return"multipoint";case"polyline":return Gi(t,i);case"polygon":return Hi(t,i);case"rectangle":case"circle":return zi(t,i);default:return}}function Ui(e){return"point"}function Gi(e,t){const i=e!=null&&e.type==="polyline"&&e.paths.length?e.paths[0].length:0;return t==="freehand"?i<2?"freehandStart":"freehandEnd":i<2?"polylineZeroVertices":"polylineOneVertex"}function Hi(e,t){const i=e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0;if(i<3)switch(t){case"freehand":return"freehandStart";case"hybrid":return"polygonZeroVerticesHybrid";default:return"polygonZeroVertices"}else if(i<4)return t==="freehand"?"freehandEnd":"polygonOneVertex";return"polygonTwoVertices"}function zi(e,t){if((e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0)<3)switch(t){case"freehand":return"freehandStart";case"click":return"shapeStartClick";default:return"shapeStartHybrid"}switch(t){case"freehand":return"freehandEnd";case"click":return"shapeEndClick";default:return"shapeEndHybrid"}}function Zi(e,t){const i=e?.geometry;if(!e||i?.type!=="mesh"||!t)return;const{renderCoordsHelper:n,elevationProvider:o}=t,{camera:a}=t.state,{extent:p}=i,{center:l,spatialReference:c}=p,u=xt(c),h=pt(c),y=xt(n.spatialReference),_=p.width*u,f=p.height*h,g=(p.zmax??0)*h,x=g-(p.zmin??0)*h,O=Math.max(_,f,x)/y,{x:v,y:P}=l,ft=l.z??0;Bt(Y,v,P,ft),n.toRenderCoords(Y,c,Y);const vt=O/a.computeScreenPixelSizeAt(Y);if(vt>Math.min(a.width,a.height)/a.pixelRatio*Li)return"meshTooClose";if(vt<Ai)return"meshTooFar";const ve=xe(e),{absoluteZ:_e}=Oe(v,P,g,c,t,ve);return _e<(o.getElevation(v,P,ft,c,"ground")??0)*h+x*Fi?"meshUnderground":"mesh"}const Ai=20,Li=1,Fi=.1,Y=we();function Ni(e,t,i,n,o,a){let p="geodesic",l=Te(i);const c=U();return dt(e,t,n,c),c[2]=0,l&&et(c,i,c,l)||(p="euclidean",l=i),{mode:p,view:t,elevationInfo:n,hasZ:o,directionMode:a,spatialReference:e.spatialReference,measurementSR:l,origin:c}}function ji(e,t,i){if(t==null||e==null)return;const n=ke(i.measurementSR);if(n==null)return;const o=ot(e,i);if(o==null)return;const a=it(t,n);return new hi(o,a)}function Bi(e,t,i,n){if(i==null||e==null)return;const o=ot(e,n);if(o==null)return;const a=R(i),p=10,l=u=>{if(u==null)return;const h=U(),y=Pe(u,"degrees","geographic");return pi(h,o,n.measurementSR,p,y,n.mode)?new mi(o,h):void 0},c=()=>{if(t!=null&&e!=null)return R(ie(t,e))};switch(n.directionMode){case"absolute":return l(a);case"relative":{const u=c();return u==null?void 0:l(u+a)}case"relative-bilateral":{const u=c();return u==null?void 0:oe([l(u+a),l(u-a)])}}}function ae(e,t){const i=st(e,t);return i!=null?new gi(i):void 0}function le(e,t,i){const{context:n,longitude:o,latitude:a,direction:p,distance:l,elevation:c}=i;if(o!=null||a!=null||l!=null||c!=null||p!=null){if(o!=null||a!=null){const u=R(o),h=R(a),y=st(c,n);return new ne(u,h,y)}return qi(e,t,i)}}function qi(e,t,{context:i,direction:n,distance:o,elevation:a}){if(t==null)return ae(a,i);const{view:p,elevationInfo:l,measurementSR:c}=i,u=dt(t,p,l);if(!c||!et(u,t.spatialReference,Gt,c))return;const[h,y]=Gt,_=o!=null?it(o,"meters"):void 0,f=R(n),g=st(a,i),x=v=>{const P=new yi([h,y],c,_,g,v);return _==null||v==null||g==null&&i.hasZ?P:new fi(P.closestTo(u))};if(f==null)return x(void 0);const O=()=>{if(e!=null&&t!=null)return R(ie(e,t))};switch(i.directionMode){case"absolute":return x(f);case"relative":{const v=O();return v==null?void 0:x(v+f)}case"relative-bilateral":{const v=O();return v==null?void 0:oe([x(v+f),x(v-f)])}}}function Wi(e){return e.context.mode==="geodesic"?le(null,null,e):ce(e)}function Yi(e,t,i){const{context:n,x:o,y:a,distance:p,direction:l,elevation:c}=i;return n.mode==="geodesic"?le(t,e,i):o!=null||a!=null?ce(i):Ki([ji(e,p,n),Bi(e,t,l,n),ae(c,n)])}function ce({x:e,y:t,elevation:i,context:n}){K.x=e?.value??0,K.y=t?.value??0,K.spatialReference=n.spatialReference;const o=ot(K,n,Xi);return new ne(e!=null&&o!=null?o[0]:void 0,t!=null&&o!=null?o[1]:void 0,st(i,n))}function Ki(e){let t;for(const i of e)i&&(t=t?.intersect(i)??i);return t}function ot(e,t,i=U()){const{view:n,elevationInfo:o,measurementSR:a,origin:p,mode:l}=t;if(dt(e,n,o,i),et(i,e.spatialReference,i,a))return l!=="geodesic"&&be(i,i,p),i}function Qi(e,t,i,n){const{view:o,measurementSR:a,spatialReference:p,origin:l,mode:c}=i;if(c==="geodesic"?$e(L,e):X(L,e,l),et(L,a,L,p))return di(L,o,t,i,n)}function st(e,t){return Ji(e,t)?.value??void 0}function Ji(e,{view:t,origin:i,elevationInfo:n,hasZ:o,measurementSR:a}){if(e==null||!o)return;const p=Ve(a);if(p==null)return;const[l,c]=i,u=it(e,p),h=t?.type==="3d"?Wt(t,l,c,u,a,n):u;return h!=null?Yt(h,p):void 0}const Gt=U(),Xi=U(),L=U(),K=ut(0,0,0,qt.WGS84);let k=class extends M{constructor(e){super(e),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=B}get allFields(){return[]}};s([r()],k.prototype,"type",void 0),s([r()],k.prototype,"radius",void 0),s([r()],k.prototype,"xSize",void 0),s([r()],k.prototype,"ySize",void 0),s([r()],k.prototype,"area",void 0),s([r()],k.prototype,"helpMessage",void 0),s([r()],k.prototype,"allFields",null),k=s([$("esri.views.interactive.tooltip.infos.DrawCircleTooltipInfo")],k);let F=class extends q(M){constructor(t){super(t),this.type="draw-mesh",this.orientation=ri({lockable:!1}),this.scale=ai({lockable:!1})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};s([r()],F.prototype,"helpMessage",void 0),s([r()],F.prototype,"allFields",null),F=s([$("esri.views.interactive.tooltip.infos.DrawMeshTooltipInfo")],F);let N=class extends q(M){constructor(t){super(t),this.type="draw-multipoint"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};s([r()],N.prototype,"helpMessage",void 0),s([r()],N.prototype,"allFields",null),N=s([$("esri.views.interactive.tooltip.infos.DrawMultipointTooltipInfo")],N);let j=class extends q(M){constructor(t){super(t),this.type="draw-point"}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};s([r()],j.prototype,"helpMessage",void 0),s([r()],j.prototype,"allFields",null),j=s([$("esri.views.interactive.tooltip.infos.DrawPointTooltipInfo")],j);let I=class extends q(M){constructor(t){super(t),this.type="draw-polygon",this.direction=te(),this.distance=ee(),this.area=li(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.area]}};s([r()],I.prototype,"xyMode",void 0),s([r()],I.prototype,"helpMessage",void 0),s([r()],I.prototype,"allFields",null),I=s([$("esri.views.interactive.tooltip.infos.DrawPolygonTooltipInfo")],I);let D=class extends q(M){constructor(t){super(t),this.type="draw-polyline",this.direction=te(),this.distance=ee(),this.totalLength=ci(),this.xyMode="direction-distance"}get allFields(){return[this.direction,this.distance,this.longitude,this.latitude,this.x,this.y,this.elevation,this.totalLength]}};s([r()],D.prototype,"helpMessage",void 0),s([r()],D.prototype,"xyMode",void 0),s([r()],D.prototype,"allFields",null),D=s([$("esri.views.interactive.tooltip.infos.DrawPolylineTooltipInfo")],D);let V=class extends M{constructor(e){super(e),this.type="draw-rectangle",this.xSize=S,this.ySize=S,this.area=B}get allFields(){return[]}};s([r()],V.prototype,"type",void 0),s([r()],V.prototype,"xSize",void 0),s([r()],V.prototype,"ySize",void 0),s([r()],V.prototype,"area",void 0),s([r()],V.prototype,"helpMessage",void 0),s([r()],V.prototype,"allFields",null),V=s([$("esri.views.interactive.tooltip.infos.DrawRectangleTooltipInfo")],V);function tn(e,t){return{point:new j({sketchOptions:t,viewType:e}),multipoint:new N({sketchOptions:t,viewType:e}),polyline:new D({sketchOptions:t,viewType:e}),polygon:new I({sketchOptions:t,viewType:e}),mesh:new F({sketchOptions:t,viewType:e}),rectangle:new V({sketchOptions:t}),circle:new k({sketchOptions:t})}}function Ht(e){const{directionOptions:t,geometryType:i,sketchOptions:n,tooltipInfos:o}=e,a=l=>{const c=rt(e).mode,u=o[l].elevation;c==="relative-to-ground"||c==="relative-to-scene"||c==="on-the-ground"?u.lock(yt(e)):u.unlock()},p=l=>{if(t){const c=o[l].direction;c.committed=t.angle,c.unlockOnVertexPlacement=!1,n.values.directionMode=t.mode}};switch(i){case"polygon":case"polyline":a(i),p(i);break;case"point":case"mesh":a(i)}}function en(e,t){const{drawOperation:i,view:n}=t,o=gt(t),a=rt(t);if(n.type==="2d"||!e||a.mode!=="absolute-height"||i?.numCommittedVertices!==1||!o||o.type!=="draw-polyline"&&o.type!=="draw-polygon"||o.elevation.locked)return;const[p,l,c]=e,u=mn(p,l,c,a,t);u!=null&&o.elevation.lock(u)}function zt(e){gt(e)?.allFields.forEach(t=>{t.unlockOnVertexPlacement&&t.unlock()})}function gt({geometryType:e,graphic:t,tooltipInfos:i}){return t?.geometry?.type!==nn[e]?e==="circle"||e==="rectangle"?i[e]:null:i[e]}const nn={point:"point",multipoint:"multipoint",mesh:"mesh",polyline:"polyline",polygon:"polygon",circle:"polygon",rectangle:"polygon",freehandPolygon:"polygon",freehandPolyline:"polyline",text:"point"};function on(e,t){switch(e?.type){case"draw-point":sn(e,t);break;case"draw-multipoint":rn(e,t);break;case"draw-polyline":ln(e,t);break;case"draw-polygon":cn(e,t);break;case"draw-rectangle":un(e,t);break;case"draw-circle":dn(e,t);break;case"draw-mesh":an(e,t)}}function sn(e,t){const i=t.graphic?.geometry;i?.type==="point"&&(mt(e,i,t),e.helpMessage=G("point",i,t.drawOperation.drawingMode))}function rn(e,t){const i=t.graphic?.geometry;i?.type==="multipoint"&&(mt(e,i,t),e.helpMessage=G("multipoint",i,t.drawOperation.drawingMode))}function an(e,t){const{graphic:i,view:n}=t,o=i?.geometry;n.type!=="3d"||o&&o.type!=="mesh"||(mt(e,o?.origin,t),o&&Ye(e,o),e.helpMessage=Zi(i,n))}function mt(e,t,i){const{drawOperation:n,view:o,sketchOptions:a}=i,{cursorVertex:p}=n;e.sketchOptions=a,e.viewType=o.type;const l=t?.type==="multipoint"?t.getPoint(t.points.length-1):t;if(e.setLocationFromPoint(l,H(i)),ue(e.elevation,i),!p)return void(n.constraints=void 0);const c=p;n.constraints={context:me(c,i),x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed,distance:null,direction:null}}function ln(e,t){const{createOperationGeometry:i,drawOperation:n,automaticLengthMeasurementUtils:o}=t,a=i!=null?i.full:null;a&&a.type!=="polyline"||(pe(e,t),e.totalLength.actual=n.lastVertex?(a?o.autoLength2D(a):null)??S:null,e.helpMessage=G("polyline",a,t.drawOperation.drawingMode))}function cn(e,t){const{createOperationGeometry:i,drawOperation:n}=t,o=i!=null?i.full:null;o&&o.type!=="polygon"||(pe(e,t),e.area.actual=n.lastVertex?(o?t.automaticAreaMeasurementUtils.autoArea2D(o):null)??B:null,e.helpMessage=G("polygon",o,t.drawOperation.drawingMode))}const Zt=Me(Kt);function pe(e,t){const{drawOperation:i,sketchOptions:n,view:o,automaticLengthMeasurementUtils:a}=t,{cursorVertex:p,lastVertex:l,secondToLastVertex:c}=i,u=n.values.effectiveDirectionMode;e.sketchOptions=n,e.viewType=o.type;const h=l&&p?a.autoDistanceBetweenPoints2D(Zt(l),Zt(p))??S:null;if(e.distance.actual=h,e.distance.readOnly=l==null,e.direction.actual=null,e.direction.readOnly=!0,l&&p&&(u==="absolute"||c)){const f=ui(c,l,p,u);e.direction.actual=f??Ce,e.direction.readOnly=!1}e.setLocationFromPoint(p,H(t)),ue(e.elevation,t);const y=pn(l,t);e.xyMode=y,e.direction.visible=y==="direction-distance",e.distance.visible=y==="direction-distance",e.effectiveX.visible=y==="coordinates",e.effectiveY.visible=y==="coordinates";const _=p??l;i.constraints=_?{context:me(_,t),x:e.x.committed,y:e.y.committed,longitude:e.longitude.committed,latitude:e.latitude.committed,elevation:e.elevation.committed,distance:e.distance.committed,direction:e.direction.committed}:void 0}function pn(e,{sketchOptions:t}){const i=t.tooltips.xyMode;return i==="auto"?e?"direction-distance":"coordinates":i}function un(e,t){e.sketchOptions=t.sketchOptions,e.xSize=he(t),e.ySize=ge(t),e.area=de(t),e.helpMessage=G("rectangle",t.graphic?.geometry,t.drawOperation.drawingMode)}function dn(e,t){const{forceUniformSize:i,sketchOptions:n}=t;e.sketchOptions=n,e.radius=i?hn(t):null,e.xSize=i?null:he(t),e.ySize=i?null:ge(t),e.area=de(t),e.helpMessage=G("circle",t.graphic?.geometry,t.drawOperation.drawingMode)}function ue(e,t){const{drawOperation:i}=t,n=i?.cursorVertex??i?.lastVertex;e.actual=_i(n)??yt(t),e.visible=i.hasZ,e.readOnly=!1,e.showAsZ=!0}function de(e){const t=e.createOperationGeometry?.full;return t?.type!=="polygon"?B:e.automaticAreaMeasurementUtils.autoArea2D(t)??B}function he({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){const i=e?.rectangle?.midpoints;return(i!=null?t.autoDistanceBetweenPoints2D(i.left,i.right):null)??S}function ge({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){const i=e?.rectangle?.midpoints;return(i!=null?t.autoDistanceBetweenPoints2D(i.top,i.bottom):null)??S}function hn({createOperationGeometry:e,automaticLengthMeasurementUtils:t}){return(e?.circle?.center!=null&&e.circle.edge!=null?t.autoDistanceBetweenPoints2D(e.circle.center,e.circle.edge):null)??S}function gn(e){const{geometryType:t,tooltipInfos:i}=e;switch(t){case"point":case"multipoint":case"mesh":case"polyline":case"polygon":{const n=i[t].elevation.committed;return n?it(n,"meters")/pt(H(e)):void 0}default:return}}function mn(e,t,i,n,o){const{view:a,drawOperation:p}=o;if(a.type!=="3d"||!p)return;i??=0;const l=H(o),c=rt(o),u=Wt(a,e,t,i,l,c,n);return vi(u,l)??yt(o)}function rt(e){return e.drawOperation.elevationInfo??Se}function H(e){return e.drawOperation.coordinateHelper.spatialReference}function yt(e){const t=pt(H(e));return Yt(e.defaultZ*t,"meters")}function me(e,t){return Ni(e,t.view,H(t),rt(t),t.drawOperation.coordinateHelper.hasZ(),t.sketchOptions.values.effectiveDirectionMode)}let m=class extends Oi{constructor(t){super(t),this._graphic=null,this._coordinateFormatterLoadTask=null,this._createOperationGeometry=null,this.defaultZ=0,this.directionOptions=null,this.elevationLockOnVertexAddDisabled=!1,this.geometryType=null,this.hasZ=!0,this.geometryToPlace=null,this.snappingManager=null,this.snapToScene=!1,this.sketchOptions=new se}initialize(){const{view:t}=this;this.internalGraphicsLayer=new ti({listMode:"hide",internal:!0,title:"DrawGraphicTool layer"}),this.view.map.layers.add(this.internalGraphicsLayer);const i=this.drawOperation=this.makeDrawOperation();this.tooltipInfos=tn(t.type,this.sketchOptions);const n=Ke(()=>({view:t,options:this.sketchOptions.tooltips}));this.tooltip=n,Ht(this._tooltipsContext),this._coordinateFormatterLoadTask=Ie(()=>Qe()),this.addHandles([i.on("vertex-add",o=>this.onVertexAdd(o)),i.on("vertex-remove",o=>this.onVertexRemove(o)),i.on("vertex-update",o=>this.onVertexUpdate(o)),i.on("cursor-update",o=>this.onCursorUpdate(o)),i.on("cursor-remove",()=>this._updateGraphic()),i.on("complete",o=>this.onComplete(o)),this._coordinateFormatterLoadTask,n.on("paste",o=>Je(o,this.activeTooltipInfo)),C(()=>this.cursor,o=>{i.cursor=o},Q),Ot(()=>{const{activeTooltipInfo:o,sketchOptions:a}=this;on(o,this._tooltipsContext),n.info=a.tooltips.effectiveEnabled?o:null}),Ot(()=>{i.constraintZ=gn(this._tooltipsContext)},De)]),this.finishToolCreation(),i.initializePointer()}destroy(){this.drawOperation=E(this.drawOperation),this.tooltip=E(this.tooltip),this._destroyAllVisualizations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=E(this.internalGraphicsLayer),this._set("view",null)}get _drawSpatialReference(){return this.drawOperation.coordinateHelper.spatialReference}get _tooltipsContext(){const{defaultZ:t,directionOptions:i,drawOperation:n,forceUniformSize:o,geometryType:a,graphic:p,sketchOptions:l,tooltipInfos:c,view:u,automaticAreaMeasurementUtils:h,automaticLengthMeasurementUtils:y}=this;return{createOperationGeometry:this._createOperationGeometry,defaultZ:t,directionOptions:i,drawOperation:n,forceUniformSize:o,geometryType:a,graphic:p,sketchOptions:l,tooltipInfos:c,view:u,automaticAreaMeasurementUtils:h,automaticLengthMeasurementUtils:y}}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(t){this._set("cursor",t)}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}set mode(t){const i=this.drawOperation;i&&(i.drawingMode=t),this._set("mode",t)}get updating(){return this.drawOperation?.updating??!1}get undoRedo(){const{view:{type:t,map:i}}=this;return t==="2d"&&i&&"undoRedo"in i&&i.undoRedo instanceof T?i.undoRedo:null}set undoRedo(t){this._override("undoRedo",t)}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||Xe(t,this.tooltip)||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo(),this.drawOperation.numCommittedVertices===0&&Ht(this._tooltipsContext)}_destroyAllVisualizations(){this.removeHandles(b.outline),this.removeHandles(b.regularVertices),this.removeHandles(b.activeVertex),this.removeHandles(b.activeEdge),this.removeHandles(ct)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this.updateGraphicGeometry(t),this._graphic;const i=new Ee({...this.graphicProperties,symbol:this.graphicSymbol});return this._graphic=i,this.updateGraphicGeometry(t),this.internalGraphicsLayer.add(i),this.addHandles(this.initializeGraphic(i)),this.notifyChange("graphic"),this.addHandles(W(()=>{this.internalGraphicsLayer.remove(i),this._graphic===i&&(this._graphic=null)}),ct),i}updateGraphicGeometry(t){this._graphic.geometry=t}_getCreateOperationGeometry(t={operationComplete:!1}){if(this.drawOperation==null)return;const{coordinateHelper:i,view:n,visualizationCursorVertex:o,lastVertex:a,committedVertices:p,geometryIncludingUncommittedVertices:l,numCommittedVertices:c}=this.drawOperation;if(!(c>0||o!=null))return;const u=t.operationComplete?p:l,h=u.length,y=o!=null?i.pointToArray(o):null,_=this._drawSpatialReference,f=n.type==="3d"&&n.viewingMode==="global",g=new Ri;g.committedVertices=p,g.cursorVertex=y;const{geometryType:x}=this;switch(x){case"point":case"mesh":g.full=i.arrayToPoint(u[0]);break;case"multipoint":g.full=h>0?si(u,_):null;break;case"polyline":case"polygon":h>0&&(g.full=x==="polygon"?oi([u],_,f,!0):Et([u],_,f),g.cursorEdge=y!=null&&a&&!J(o,a)?Et([[y,i.pointToArray(a)]],_,f):null,g.outline=h>1?g.full:null);break;case"circle":case"rectangle":{if(g.committedVertices=g.cursorVertex=null,!h)break;const O=ei(n,u[0]),v=u[0],P=O.makeMapPoint(v[0]+yn*n.resolution,v[1]);x==="circle"?h===1&&t.operationComplete?g.circle=It([v,P],O,!0):h===2&&(this.forceUniformSize?g.circle=It(u,O,this.centered):g.rectangle=ii(u,O,this.centered)):h===1&&t.operationComplete?g.rectangle=Dt([v,P],O,!0):h===2&&(g.rectangle=this.forceUniformSize?Dt(u,O,this.centered):ni(u,O,this.centered)),g.full=g.circle!=null?g.circle.geometry:g.rectangle?.geometry,g.outline=g.full?.type==="polygon"?g.full:null;break}default:return null}return g}initializeGraphic(t){return W()}onComplete(t){if(!this.drawOperation)return;this._updateGraphic();let i=null;if(this.drawOperation.isCompleted){const n=this._getCreateOperationGeometry({operationComplete:!0});n!=null&&(i=this._createOrUpdateGraphic(n.full))}this._createOperationGeometry=null,this.emit("complete",{graphic:i,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){const{drawOperation:t}=this;t&&(t.isCompleted||t.cancel())}onOutlineChanged(t){return W()}onCursorEdgeChanged(t){return W()}onVertexAdd(t){zt(this._tooltipsContext),this._updateGraphic(),this.elevationLockOnVertexAddDisabled||en(t.vertices.at(0)?.coordinates,this._tooltipsContext),this.emit("vertex-add",t)}onVertexRemove(t){zt(this._tooltipsContext),this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.cursorEdge!=null?this.addHandles(this.onCursorEdgeChanged(t.cursorEdge),b.activeEdge):this.removeHandles(b.activeEdge),t.outline!=null?this.addHandles(this.onOutlineChanged(t.outline),b.outline):this.removeHandles(b.outline),t.committedVertices!=null?this.addHandles(this.onRegularVerticesChanged(t.committedVertices),b.regularVertices):this.removeHandles(b.regularVertices),t.cursorVertex!=null?this.addHandles(this.onActiveVertexChanged(t.cursorVertex),b.activeVertex):this.removeHandles(b.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.removeHandles(ct)):this._destroyAllVisualizations()}get activeTooltipInfo(){return this._coordinateFormatterLoadTask?.finished?gt(this._tooltipsContext):null}};s([r()],m.prototype,"_coordinateFormatterLoadTask",void 0),s([r()],m.prototype,"_createOperationGeometry",void 0),s([r()],m.prototype,"_tooltipsContext",null),s([r({value:!0})],m.prototype,"centered",null),s([r()],m.prototype,"cursor",null),s([r({nonNullable:!0})],m.prototype,"defaultZ",void 0),s([r({constructOnly:!0})],m.prototype,"directionOptions",void 0),s([r()],m.prototype,"drawOperation",void 0),s([r()],m.prototype,"elevationLockOnVertexAddDisabled",void 0),s([r({value:!0})],m.prototype,"enabled",null),s([r({value:!0})],m.prototype,"forceUniformSize",null),s([r({constructOnly:!0})],m.prototype,"geometryType",void 0),s([r()],m.prototype,"graphic",null),s([r({constructOnly:!0})],m.prototype,"graphicProperties",void 0),s([r()],m.prototype,"graphicSymbol",null),s([r({constructOnly:!0})],m.prototype,"hasZ",void 0),s([r({constructOnly:!0})],m.prototype,"geometryToPlace",void 0),s([r()],m.prototype,"mode",null),s([r()],m.prototype,"snappingManager",void 0),s([r()],m.prototype,"snapToScene",void 0),s([r()],m.prototype,"tooltip",void 0),s([r()],m.prototype,"tooltipInfos",void 0),s([r({constructOnly:!0,type:se})],m.prototype,"sketchOptions",void 0),s([r()],m.prototype,"updating",null),s([r({constructOnly:!0,nonNullable:!0})],m.prototype,"view",void 0),s([r({constructOnly:!0})],m.prototype,"automaticAreaMeasurementUtils",void 0),s([r({constructOnly:!0})],m.prototype,"automaticLengthMeasurementUtils",void 0),s([r({constructOnly:!0})],m.prototype,"undoRedo",null),s([r()],m.prototype,"activeTooltipInfo",null),m=s([$("esri.views.draw.DrawGraphicTool")],m);const ct=Symbol("create-operation-graphic"),b={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};function Bn(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const yn=48,ye="click";let w=class extends Nt{constructor(e){super(e),this.events=new Re,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0}intersectionDistance(e,t){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};s([r()],w.prototype,"interactive",void 0),s([r()],w.prototype,"selectable",void 0),s([r()],w.prototype,"cursor",void 0),s([r()],w.prototype,"grabbing",void 0),s([r()],w.prototype,"grabbable",void 0),s([r()],w.prototype,"consumesClicks",void 0),s([r()],w.prototype,"grabbableForEvent",void 0),s([r()],w.prototype,"dragging",void 0),s([r()],w.prototype,"hovering",void 0),s([r()],w.prototype,"selected",void 0),w=s([$("esri.views.draw.LegacyDrawManipulator")],w);const fn="crosshair",vn="progress",At=Symbol(),Lt=Symbol();let d=class extends Ue{constructor(e){super(e),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new Ge,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new jt,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=bt(Wi),this._getPolylineOrPolygonConstraint=bt(Yi),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new re,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,e.elevationInfo==null&&(this.elevationInfo=He(!!e.hasZ))}initializePointer(){const e=this.view.inputManager?.latestPointerInfo;e!=null&&this._updatePointer(e.location,e.id,e.type)}initialize(){const{geometryType:e,view:t}=this,i=t.spatialReference,n="viewingMode"in t.state?t.state.viewingMode:2,o=e==="segment"||e==="multipoint"?"polyline":e;this.coordinateHelper=$i(this.hasZ,this.hasM,i),this._editGeometryOperations=new Ti(new ki(o,this.coordinateHelper),n),this._snappingOperation=new Di({view:t}),this.addHandles([C(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:l,constraint:c},u)=>{const{snappingOptions:h}=this;if(h&&(h.forceDisabled=c!=null&&wi(c)),u!=null&&l===u.stagedPoint&&c!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(l??this._screenToMap(this._stagedScreenPoint))},{equals:(l,c)=>l.stagedPoint===c.stagedPoint&&ze(l.constraint,c.constraint)}),C(()=>this.view.viewpoint,(l,c)=>{l&&c&&Ze(l,c)&&this._onKeyboardBasedChange()})]),this._activePart=new Pi(i,n),this._editGeometryOperations.data.parts.push(this._activePart);const a=this.segmentLabels;a!=null&&(a.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},this.addHandles(C(()=>this.labelOptions.enabled,l=>{a.visible=l},Q))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],l=>{const c=l.vertices.map(f=>({componentIndex:0,vertexIndex:f.index,coordinates:this.coordinateHelper.vectorToArray(f.pos)})),u=c.map(f=>f.coordinates),h=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getFirstVertex()?.pos)??null;J(h,this.firstVertex)||(this.firstVertex=h);const y=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getLastVertex()?.pos)??null;J(y,this.lastVertex)||(this.lastVertex=y);const _=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.segments.at(-1)?.leftVertex?.pos)??null;switch(J(_,this.secondToLastVertex)||(this.secondToLastVertex=_),this._processCursor(this.cursorVertex),l.type){case"vertex-add":this.emit(l.type,{...l,added:u,vertices:c});break;case"vertex-update":this.emit(l.type,{...l,updated:u,vertices:c});break;case"vertex-remove":this.emit(l.type,{...l,removed:u,vertices:c})}}));const p=this._manipulator=new w({consumesClicks:!1,grabbableForEvent:l=>this.drawingMode!=="click"||l.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(p),p.grabbable=e!=="point"&&e!=="multipoint",this.addHandles([p.events.on("immediate-click",l=>this._onImmediateClick(l)),p.events.on("immediate-double-click",l=>this._onImmediateDoubleClick(l)),C(()=>this.drawingMode,()=>{this.removeHandles(At),this.addHandles(this._createManipulatorDragPipeline(p),At)},Q),C(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:l})=>{p.cursor=l},Q)]),xi(this,()=>{const l=this.view.inputManager.latestPointerInfo?.type??"mouse",c=this._getSnappingContext(l);if(this.snappingManager!=null){const u=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,c);this._updatingHandles.addPromise($t(u))}})}destroy(){E(this.segmentLabels),E(this._snappingOperation),this._editGeometryOperations=E(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:e,_manipulator:t}=this;return e!=null&&this._pointerDownStates.has(e)||t.grabbing||!t.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activePart.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}get _constraint(){const{constraints:e,constraintsEnabled:t}=this;if(e&&t)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(e);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,e)}}set drawingMode(e){this._set("drawingMode",e??ye)}get effectiveCursor(){return this.loading?vn:this._hideDefaultCursor?null:this.cursor||fn}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activePart.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:e,lastVertex:t,firstVertex:i,geometryType:n}=this;return n==="polygon"&&at(e,i)||at(e,t)?null:e}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:e,committableVertex:t,coordinateHelper:i}=this,n=e.slice();return t!=null&&n.push(i.pointToArray(t)),n}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:e}=this;e!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e),this._activePart)}complete(e){const t=e?.aborted||!1;this._snappingOperation.abort(),this.snappingManager?.doneSnapping();const{geometryType:i,numCommittedVertices:n}=this,o=i==="multipoint"&&n===0||i==="polyline"&&n<2||i==="polygon"&&n<3;i!=="segment"&&i!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!o,(this.isCompleted||t)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((a,p)=>({componentIndex:0,vertexIndex:p,coordinates:a})),aborted:t,type:"complete"}))}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(e){const t=Tt(this.cursorVertex),i=Tt(e),n=i&&(this._updateAndGetEffectiveDrawSurface()?.constrainZ(i)??i),o=this._snapToClosingVertex(n),a=this._applyConstraints(o);at(t,a)||(this._set("cursorVertex",a),this.segmentLabels?.set("stagedVertex",a!=null?this.coordinateHelper.pointToVector(a):null),a==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activePart.vertices.length,coordinates:this.coordinateHelper.pointToArray(a)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(e){if(e==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return e;const t=this._mapToScreen(e);if(!t)return e;const i=this._activePart;return this._vertexWithinPointerDistance(i.vertices[0].pos,t)?this.firstVertex:this._vertexWithinPointerDistance(i.vertices.at(-1).pos,t)?this.lastVertex:e}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return lt(e,(t,i,n,o)=>{const a=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!a)return;const{snappingStep:p,cancelSnapping:l}=Ii({predicate:()=>a,snappingManager:this.snappingManager,snappingContext:new Rt({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:o,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});n=n.next(c=>(a&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),c)).next(l),i.next(this._screenToMapDragEventStep()).next(c=>(c.action==="start"&&(this._processCursor(c.mapStart),(this.geometryType==="segment"||a&&!this.numCommittedVertices)&&this.commitStagedVertex()),c)).next(bi(this.view,this.elevationInfo)).next(...p).next(c=>(a&&(this._processCursor(c.mapEnd),c.action==="end"&&this.commitStagedVertex()),c)).next(c=>(c.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),c))})}_createManipulatorDragPipelineFreehand(e){return lt(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(n.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return n})})}_createManipulatorDragPipelineHybrid(e){return lt(e,(t,i)=>{this.isCompleted||i.next(this._screenToMapDragEventStep()).next(n=>(n.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),Lt),this._processCursor(n.mapStart),this.commitStagedVertex()),n)).next(n=>{switch(n.action){case"start":case"update":this._processCursor(n.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(Lt),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return n})})}get _drawAtFixedElevation(){const{constraintsEnabled:e,constraintZ:t,geometryType:i,numCommittedVertices:n}=this;return e?t!=null||i==="segment"&&n>0:(i==="segment"||i==="polygon")&&n>0}_updateAndGetEffectiveDrawSurface(){const{constraintsEnabled:e,coordinateHelper:t,drawSurface:i,elevationDrawSurface:n,snapToSceneEnabled:o}=this;if(n==null)return i;if(!this.hasZ)return n.defaultZ=null,n;const a=this.elevationInfo?.mode;let p=this.defaultZ,l=e||a==="absolute-height";return o!=null&&(l=o),a==="on-the-ground"&&(l=!1),this._drawAtFixedElevation&&(p=(e?this.constraintZ:null)??t.getZ(this._activePart.vertices[0].pos),l=!1),l?i:(n.defaultZ=p,n)}_mapToScreen(e){return this._updateAndGetEffectiveDrawSurface()?.mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(!(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging))try{const{drawingMode:t,geometryType:i}=this;this._stagedPointerType=e.pointerType,this._stagedScreenPoint=e.screenPoint;const n=this._screenToMap(e.screenPoint);if(n==null||n==null||t==="freehand"&&i!=="point"&&i!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(n),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),e.pointerType!=="mouse"&&this._processCursor(null),(t==="freehand"&&this.geometryType!=="multipoint"||i==="point"||i==="segment"&&this.numCommittedVertices===2||i==="segment"&&t==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{e.stopPropagation()}}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=Qt(e.x,e.y);this._updatePointer(t,e.pointerId,e.pointerType)&&e.stopPropagation()}_updatePointer(e,t,i){return this._stagedScreenPoint=e,this._stagedPointerType=i,this._stagedPointerId=t,this._isDragging?(this._snappingOperation.abort(),!1):(this._processCursorMovementRelativeToSurface(e,i),!0)}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(e,t){const i=this._snappingOperation,n=this._screenToMap(e),o=this._requiresScenePoint?this.drawSurface?.screenToMap(e):null;if(n==null)return this._hideDefaultCursor=!0,this._processCursor(null),void i.abort();this._hideDefaultCursor=!1;const a=this.snappingManager;if(a==null)return this._processCursor(n),void i.abort();const p=this._getSnappingContext(t);this._updatingHandles.addPromise($t(i.snap({point:n,scenePoint:o},a,p)))}_applyConstraints(e){const{_constraint:t,constraints:i}=this;if(!e||!i||!t)return e;const{context:n}=i,o=ot(e,n),a=o?t.closestTo(o):void 0;if(!a)return e;const p=Qi(a,e,n),l=this.view.type==="2d"||n.elevationInfo.mode!=="absolute-height";return p!=null&&l&&this.constraintZ!=null&&this.hasZ&&(p.z=this.constraintZ),p}_screenToMap(e){return e?this._updateAndGetEffectiveDrawSurface()?.screenToMap(e):null}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),e==null)return null;const i=this._screenToMap(t.screenEnd);return i!=null?{...t,mapStart:e,mapEnd:i}:null}}_vertexWithinPointerDistance(e,t){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return n!=null&&_n(n,t,25)}_getSnappingContext(e){const t=this._drawAtFixedElevation?this.elevationDrawSurface?.defaultZ:null;return new Rt({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:t!=null?{value:t,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function _n(e,t,i){const n=e.x-t.x,o=e.y-t.y;return n*n+o*o<=i}s([r()],d.prototype,"_hideDefaultCursor",void 0),s([r()],d.prototype,"_stagedPointerId",void 0),s([r()],d.prototype,"_isDragging",null),s([r()],d.prototype,"_snappingOperation",void 0),s([r()],d.prototype,"_snappingEnabled",null),s([r({constructOnly:!0})],d.prototype,"graphic",void 0),s([r()],d.prototype,"constraintsEnabled",void 0),s([r()],d.prototype,"constraints",void 0),s([r()],d.prototype,"_constraint",null),s([r()],d.prototype,"constraintZ",void 0),s([r()],d.prototype,"defaultZ",void 0),s([r()],d.prototype,"isDraped",void 0),s([r({constructOnly:!0})],d.prototype,"automaticLengthMeasurementUtils",void 0),s([r({value:ye})],d.prototype,"drawingMode",null),s([r({constructOnly:!0})],d.prototype,"elevationDrawSurface",void 0),s([r({constructOnly:!0})],d.prototype,"elevationInfo",void 0),s([r({constructOnly:!0,type:re})],d.prototype,"labelOptions",void 0),s([r({constructOnly:!0})],d.prototype,"geometryType",void 0),s([r({constructOnly:!0})],d.prototype,"hasM",void 0),s([r({constructOnly:!0})],d.prototype,"hasZ",void 0),s([r()],d.prototype,"cursor",void 0),s([r()],d.prototype,"effectiveCursor",null),s([r()],d.prototype,"loading",void 0),s([r({constructOnly:!0})],d.prototype,"manipulators",void 0),s([r({constructOnly:!0})],d.prototype,"drawSurface",void 0),s([r({constructOnly:!0})],d.prototype,"segmentLabels",void 0),s([r({constructOnly:!0})],d.prototype,"snappingManager",void 0),s([r({constructOnly:!0})],d.prototype,"snappingVisualizer",void 0),s([r()],d.prototype,"snapToSceneEnabled",void 0),s([r({readOnly:!0})],d.prototype,"cursorVertex",null),s([r({readOnly:!0})],d.prototype,"visualizationCursorVertex",null),s([r()],d.prototype,"committableVertex",null),s([r()],d.prototype,"firstVertex",void 0),s([r()],d.prototype,"lastVertex",void 0),s([r()],d.prototype,"secondToLastVertex",void 0),s([r()],d.prototype,"updating",null),s([r({constructOnly:!0})],d.prototype,"view",void 0),d=s([$("esri.views.draw.DrawOperation")],d);class qn{constructor(t,i,n,o=null){this._elevationInfo=t,this.defaultZ=i,this._view=n,this._excludeGraphics=o}screenToMap(t){const{defaultZ:i,_view:n}=this,o=n.sceneIntersectionHelper.intersectElevationFromScreen(Ae(t.x,t.y),this._elevationInfo,i??0,this._excludeGraphics);return i==null&&o!=null&&(o.z=void 0),o}mapToScreen(t){const i=ut(t.x,t.y,Xt(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(i)}constrainZ(t){const{defaultZ:i}=this;return i!=null&&t.z!==i&&((t=Jt(t)).z=i),t}}class Wn{constructor(t,i,n=[]){this.view=t,this.elevationInfo=i,this.exclude=n}screenToMap(t){const i=this.view.toMap(t,{exclude:this.exclude,excludeLabels:!0});return i!=null&&(i.z=Le(i,this.view,this.elevationInfo)),i}mapToScreen(t){let i=t;return this.elevationInfo!=null&&(i=ut(t.x,t.y,Xt(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(i)}constrainZ(t){return t}}let Yn=class{constructor(t,i=!1,n=0){this.view=t,this.hasZ=i,this.defaultZ=n,this.mapToScreen=o=>t.toScreen(o),this.screenToMap=i?o=>{const a=t.toMap(o);return a.z=n,a}:o=>t.toMap(o)}constrainZ(t){const{defaultZ:i}=this;return this.hasZ&&t.z!==i&&((t=Jt(t)).z=i),t}};const tt=class tt{screenToMap(t){const{x:i,y:n}=t;return new Kt({x:i,y:n,spatialReference:tt.spatialReference})}mapToScreen(t){return Qt(t.x,t.y)}constrainZ(t){return t}};tt.spatialReference=new qt;let Ft=tt;function Qn(e,t){return fe(e,t,!1)}function Jn(e,t){return fe(e,t,!0)}function fe(e,t,i){if(e instanceof Vi){if(e.operation instanceof Si)return wn(e.operation,t,i),!0;if(e.operation instanceof Mi)return xn(e.operation,t,i),!0;if(e.operation instanceof Ci)return On(e.operation,t,i),!0}return!1}function wn(e,t,i=!1){const n=i?-1:1,o=We(n*e.dx,n*e.dy,n*e.dz);X(t.origin,t.origin,o),nt(t)}function xn(e,t,i=!1){const n=i?-e.angle:e.angle;Vt(t.basis1,t.basis1,St,n),Vt(t.basis2,t.basis2,St,n),nt(t)}function On(e,t,i=!1){const n=i?1/e.factor1:e.factor1,o=i?1/e.factor2:e.factor2;Mt(t.basis1,t.basis1,n),Mt(t.basis2,t.basis2,o),Ct(t.origin,t.origin,e.origin,e.axis1,n),Ct(t.origin,t.origin,e.origin,e.axis2,o),nt(t)}function Xn(e,t,i,n,o=!1){n||(n=Fe());const a=z(Z.get(),e[1],-e[0]),p=z(Z.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),l=z(Z.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),c=Z.get(),u=t.allVerticesUnordered;u.forEach(({pos:f})=>{z(c,kt(e,f),kt(a,f)),Ne(p,p,c),je(l,l,c)});const h=1e-6,y=z(Z.get(),l[0]-p[0]<h?i/2:0,l[1]-p[1]<h?i/2:0);Be(p,p,y),qe(l,l,y);const _=o?u.reduce((f,g)=>f+(g.pos[2]??0),0)/u.length:0;return Pt(n.basis1,e,(l[0]-p[0])/2),Pt(n.basis2,a,(l[1]-p[1])/2),Bt(n.origin,p[0]*e[0]+p[1]*a[0],p[0]*e[1]+p[1]*a[1],_),X(n.origin,n.origin,n.basis1),X(n.origin,n.origin,n.basis2),nt(n),n}export{m as A,Bn as M,Xn as S,Jn as T,Qn as V,d as a,qn as c,Yn as h,Wn as l};
