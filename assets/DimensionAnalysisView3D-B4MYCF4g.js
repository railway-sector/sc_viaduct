import{uV as Qe,yi as Ze,dq as P,eI as $,bH as $t,yj as Ot,yk as Dt,ml as fe,fH as ae,iU as g,sG as Ae,eY as He,km as Pe,eH as ze,eM as R,i6 as L,ii as H,i7 as Tt,xn as et,oK as F,dh as G,iC as q,di as xt,yl as ke,cV as Q,hO as ce,hc as Z,ym as Rt,ad as v,d8 as O,i$ as At,b3 as tt,n as u,p as c,u as I,cH as V,iX as Ht,iW as zt,mD as kt,iE as J,eF as se,ds as ee,sT as Gt,cT as X,iD as it,yn as Et,fG as nt,kW as at,dp as st,ax as D,eG as ot,iy as ve,iw as _e,pE as Ge,dt as j,yo as Lt,ix as Vt,gh as ye,lk as Ut,ll as Ee,eE as It,m9 as rt,cS as jt,ks as Ft,d4 as Se,gN as Le,d as Bt,d5 as be,gO as oe,yp as Me,gM as Nt,d7 as qt,tE as Ve,yq as Wt,aF as Jt,sA as Xt,v6 as Yt,o_ as Kt,yr as Qt,ys as Zt,sJ as B,yt as ei,yu as ti,hJ as ii}from"./index-BYdCJpuA.js";import{e as ni}from"./AnalysisView3D-B1vZZ9IB.js";import{m as U,f as ai}from"./Segment-DkBzAXMX.js";import{E as si,F as oi,C as ri}from"./euclideanLengthMeasurementUtils-Bkd_HvDT.js";import{t as li,u as di}from"./LengthDimension-DD7mCG7F.js";import{Y as pe,g as ui,t as T,h as lt,w as Ce,f as ie,j as ci,p as E,o as pi,r as mi,a as hi}from"./ShadedColorMaterial.glsl-kQeil2vK.js";import{G as $e,O as gi,P as dt}from"./dragEventPipeline3D-C9X1BjCZ.js";import{p as te,h as Oe,D as fi}from"./InteractiveToolBase-Drk82nnI.js";import{l as Ue}from"./Factory-5Of4CnQ4.js";import{w as vi}from"./SnappingVisualizer3D-VmZAyFXz.js";import{h as _i}from"./VerticesVisualElement-OV2D_J2K.js";import{g as yi}from"./ImageMaterial.glsl-Y8FVlYCq.js";import{h as re}from"./lineStippleUtils-CCavR4OV.js";import{g as Si,a as Mi,w as wi}from"./EditGeometryOperations-DOa3yWYe.js";import{e as Pi}from"./SnappingContext-vdDqlkdx.js";import{f as bi}from"./SnappingDragPipelineStep-DlND-eVn.js";import{a as Ci}from"./SnappingManagerPool-BvF3zNc1.js";import{p as $i}from"./SnappingOperation-BSndjDA0.js";import{o as Oi,m as Di,f as Ti,d as Ie}from"./analysisViewUtils-qFe3dgt5.js";import{o as xi}from"./ToolIntersector-C24jmLnz.js";import{S as Ri,f as Ai}from"./line-C4DvaXHe.js";import{g as ut}from"./LineMarker.glsl-CUB5wcHp.js";import{c as Hi}from"./automaticLengthMeasurementUtils-C8raCRg0.js";import"./AnalysisView-DcmCC6-z.js";import"./SnappingManager-Ci6ywXqM.js";import"./geodeticLengthOperator-lTciKgI6.js";import"./geodeticCurveType-CirnHLSB.js";import"./VisualElement-9yf4w6LO.js";import"./TextOverlayItem-CwbJGhVH.js";import"./geometry2dUtils-Bqw6ZSmK.js";import"./ColorMaterial.glsl-C-Do2Y4H.js";import"./TriangleMaterial-DJj6FYvY.js";import"./ExtendedLineVisualElement-CyuOH4Ia.js";import"./EngineVisualElement-Dh49M2c3.js";import"./LaserlinePath.glsl-BiZDqwsz.js";import"./PointVisualElement-d4r-QpOS.js";import"./DefaultLayouts-BuyclURa.js";import"./rotate-99gmhIhB.js";import"./curveOperationUtils-Bbuy0P7k.js";import"./PointSnappingHint-Dqf9UDMB.js";import"./dehydratedFeatureComparison-DX6---EM.js";import"./allLayerSnapping-DdTLmxKb.js";class zi{constructor(t,i,n,a,s,o){this.elevationAlignedStartPoint=t,this.elevationAlignedEndPoint=i,this.directSegment=n,this.dimensionSegment=a,this.primaryOffsetAxis=s,this.spatialReference=o}}const je=$t(G);function ki(e,t,i,n){if(e==null)return null;let a;if(t==="horizontal")a=n.autoDistanceBetweenPoints2D(je(e.elevationAlignedStartPoint),je(e.elevationAlignedEndPoint));else{const{startRenderSpace:o,endRenderSpace:l}=e.dimensionSegment;a=oi(o,l,e.spatialReference)}if(a==null)return null;const s=t==="vertical"?Ot(a.value,a.unit,i):Dt(a.value,a.unit,i);return Qe(a,s)}function le(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:a,orientation:s}}=e;return{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i,offset:n,measureType:a,orientation:s}}function de({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:n,orientation:a},s,o=null){if(e==null||t==null)return null;const l=pt(o?.directSegment??new U,{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t},s),r=o?.primaryOffsetAxis??P();me(r,{measureType:n,elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,directSegment:l,orientation:a,renderCoordsHelper:s});const d=o?.dimensionSegment??new U;return De({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t})&&n==="vertical"?($(d.startRenderSpace,l.startRenderSpace),$(d.endRenderSpace,l.endRenderSpace)):mt(d,r,i,l,s),new zi(e,t,l,d,r,s.spatialReference)}function Fe(e,t,i,n){return t===0?($(e.startRenderSpace,i.startRenderSpace),$(e.endRenderSpace,n.startRenderSpace)):($(e.startRenderSpace,i.endRenderSpace),$(e.endRenderSpace,n.endRenderSpace)),e}function Gi(e,t,i,n){ae(e.startRenderSpace,t.startRenderSpace,i,n),ae(e.endRenderSpace,t.endRenderSpace,i,n)}function ct(e,t,i,n){switch(t){case"direct":return pt(e,i,n);case"horizontal":case"vertical":{const{elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,dimension:o,geometry:l}=i;let r;o.measureType==="direct"?(r=Ei(l,n)===a.z>s.z,t==="horizontal"&&(r=!r)):r=!Li(l);const[d,p]=r?[a,s]:[s,a],h=q(p,Vi);return t==="horizontal"?h.z=d.z:(h.x=d.x,h.y=d.y),n.toRenderCoords(d,e.startRenderSpace),n.toRenderCoords(h,e.endRenderSpace),e}}}function pt(e,t,i){return i.toRenderCoords(t.elevationAlignedStartPoint,e.startRenderSpace),i.toRenderCoords(t.elevationAlignedEndPoint,e.endRenderSpace),e}function Ei(e,t){const i=e.directSegment.eval(.5,g.get()),n=t.worldUpAtPosition(i,g.get()),a=e.dimensionSegment.eval(.5,g.get()),s=R(g.get(),a,i);return!et(s,F)&&H(s,n)>0}function Li(e){const{startRenderSpace:t,endRenderSpace:i}=e.dimensionSegment,{startRenderSpace:n,endRenderSpace:a}=e.directSegment;return ke(n,t)<ke(a,i)}const Vi=xt(0,0,0,null);function Ui(e,t,i,n){const{directSegment:a}=i,s=me(g.get(),{measureType:t,directSegment:a,renderCoordsHelper:n}),o=mt(Ii,s,0,a,n).eval(.5,g.get()),l=R(g.get(),e,o);return H(l,s)*n.unitInMeters}const Ii=new U;function me(e,t){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:a,directSegment:{startRenderSpace:s,endRenderSpace:o},directSegment:l,renderCoordsHelper:r}=t,d=l.eval(.5,g.get()),p=r.worldUpAtPosition(d,g.get()),h=r.worldBasisAtPosition(d,1,g.get());switch(i){case"horizontal":$(e,p);break;case"vertical":H(s,p)<H(o,p)?R(e,o,s):R(e,s,o),L(e,e,p),L(e,e,p);break;case"direct":{const m=t.orientation??0;if(De({elevationAlignedStartPoint:n,elevationAlignedEndPoint:a}))Ae(ne,-He(m),p),ze(e,h,ne);else{const f=R(g.get(),o,s),_=L(g.get(),f,p);L(_,_,f),Ae(ne,He(m),f),ze(e,_,ne)}break}}return et(e,F)?$(e,h):Tt(e,e)}const ne=Pe();function De({elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}){return e!=null&&t!=null&&e.x===t.x&&e.y===t.y}function mt(e,t,i,n,a){const{startRenderSpace:s,endRenderSpace:o}=n,l=i/a.unitInMeters,[r,d]=ji(s,o,t,l);return ae(e.startRenderSpace,n.startRenderSpace,t,r),ae(e.endRenderSpace,n.endRenderSpace,t,d),e}function ji(e,t,i,n=0){const a=H(t,i),s=H(e,i),o=Math.abs(a-s)+n;return a>s?[o,n]:[n,o]}function he(e,t,i){const n=t.directSegment.eval(.5,g.get());return i.worldUpAtPosition(n,e)}function Te(e,t){const{startRenderSpace:i,endRenderSpace:n}=t.directSegment;return R(e,n,i)}function xe(e,t,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:a}=t.dimensionSegment;return i.invert?R(e,n,a):R(e,a,n)}function we(e,t){const i=e.directSegment.eval(.5,g.get());return t.headingAtPosition(i,e.primaryOffsetAxis)}function Fi(e,t){return fe(xe(Bi,e))/t**2}const Bi=P();function ht(e){const{elevationAlignedStartPoint:t,elevationAlignedEndPoint:i}=e;if(t==null||i==null)return!1;const n=si(t,i);return n!=null&&Qe(n,"meters").value>Ze}function Y(e){return e.geometry!=null}let k=class extends Q{constructor(t){super(t)}initialize(){const t=ce(()=>this.analysisViewData.computations,({computation:i})=>this._watchComputation(i));this.addHandles(Z(t))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Rt(this.view)}_watchComputation(t){return v(()=>le(t),i=>{const{measureType:n}=i;if(ht(i)&&n!=="direct"){const s=Math.round(At(Ze,"meters","kilometers"));return tt.getLogger(this).warnOnce(`A ${n} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const a=de(i,this.view.renderCoordsHelper,t.geometry);t.geometry=a,t.result.length=ki(a,n,this._defaultUnit,this.automaticLengthMeasurementUtils)},O)}};u([c({constructOnly:!0})],k.prototype,"analysisViewData",void 0),u([c({constructOnly:!0})],k.prototype,"view",void 0),u([c({constructOnly:!0})],k.prototype,"automaticLengthMeasurementUtils",void 0),u([c()],k.prototype,"analysis",null),u([c()],k.prototype,"_defaultUnit",null),k=u([I("esri.views.3d.analysis.Dimension.DimensionController")],k);function K(e){return Ht(e.accentColor,.5)}function Be(e){return zt(e.accentColor)}const gt=5,Ni=new V([127,127,127,.5]),ft=.8,qi=4,Wi=6,Ji=.1,vt=.5,Xi=18,Yi=2,Ki=.3,Qi=2,Zi=.25,en=20,tn=5,Ne=5,qe=10,nn=2500,an=50,sn=2;class on{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&t===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const i of li)t(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(t){switch(t){case"direct":return this.direct;case"horizontal":return this.horizontal;case"vertical":return this.vertical}}}class rn extends pe{constructor(t,i){const n=ui(V.toUnitRGBA(K(t.effectiveTheme))),a=[new T(kt(n,1,32,32),A)];super({view:t,renderObjects:a,metadata:i.metadata,available:!1,grabCursor:"crosshair",radius:gt,collisionPriority:1}),this._themeHandle=v(()=>({color:V.toUnitRGBA(K(t.effectiveTheme))}),s=>n.setParameters(s))}destroy(){this._themeHandle.remove(),super.destroy()}}function ln(e,t){const i=[se(-.5,0,0),se(.5,0,0)],n=J(t.unfocusedMaterial,i.map(s=>ee(P(),s,vt))),a=n.instantiate({material:t.focusedMaterial});return new pe({view:e,renderObjects:[new T(n,9|A),new T(a,2|A)],collisionType:{type:"line",paths:[i]},radius:Re(t.lineSizePt)/2,metadata:t.metadata,available:!1,...lt})}class We extends pe{constructor(t,{lineSizePt:i,material:n,metadata:a}){super({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:Gt(),lineSizePt:i,material:n},this._themeHandle=v(()=>V.toUnitRGBA(K(t.effectiveTheme)),s=>{this._options.calloutColor=s,Xe(this,Je({...this._options,metadata:this.metadata}))},X)}update({lineSizePt:t,material:i}){this._options.lineSizePt=t,this._options.material=i,Xe(this,Je({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Je({calloutColor:e,lineSizePt:t,material:i,metadata:n}){return{calloutLength:.25*Lt*ft*D(t)+Xi,calloutColor:e,calloutWidth:Yi,customStateMask:A,discScale:Ki,focusMultiplier:Qi,material:i,metadata:n}}function dn(e,t){const i=[se(-.5,0,0),se(.5,0,0)],n=J(t.thinOffsetManipulatorMaterial,i),a=J(t.unfocusedMaterial,i.map(o=>ee(P(),o,vt))),s=a.instantiate({material:t.focusedMaterial});return new pe({view:e,renderObjects:[new T(a,1|A),new T(s,2|A),new T(n,A)],collisionType:{type:"line",paths:[i]},radius:Re(t.lineSizePt)/2,available:!1,metadata:t.metadata,...lt})}function un(e,{isStart:t,createSnappingPipelineStep:i,dimension:n,onUpdate:a,view:s}){const o=t?"startPoint":"endPoint";return[te(e,(r,d,p,h)=>{const m=$e(r),{snappingStep:f,cancelSnapping:_}=i(h);p=p.next(m).next(Oe(n,[o,"measureType","orientation"])).next(_),d.next(m).next(gi(s)).next(...f).next(M=>{const y=q(M.mapEnd,new G);a(o==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function cn(e,{computation:t,view:i}){return[te(e,(n,a,s)=>{if(!Y(t)||!n.selected)return;const{geometry:o,dimension:l}=t,r=$e(n);a.next(r).next(yt(i,l,o.dimensionSegment,o.primaryOffsetAxis)),s.next(r).next(Oe(l,["offset"]))})]}function pn(e,{computation:t,view:i}){return[te(e,(n,a,s)=>{_t({cancel:s,computation:t,settingHeading:!0,steps:a,view:i})})]}function mn(e,{computation:t,view:i}){return[te(e,(n,a,s)=>{_t({cancel:s,computation:t,settingHeading:!1,steps:a,view:i})}),e.events.on("immediate-click",n=>{hn(n,t,i)})]}function hn(e,t,i){const{dimension:n,geometry:a}=t;if(n.orientation===90||n.orientation===270)return n.orientation=0,void e.stopPropagation();if(a==null)return;const{renderCoordsHelper:s}=i,o=de({...le(t),orientation:90},s),l=de({...le(t),orientation:270},s);if(o==null||l==null)return;const r=we(o,s),d=we(l,s),p=St(a,i),h=ye.shortestSignedDiff(p,r),m=ye.shortestSignedDiff(p,d);n.orientation=Math.abs(h)<Math.abs(m)?90:270,e.stopPropagation()}function _t(e){const{cancel:t,computation:i,settingHeading:n,steps:a,view:s}=e;if(!Y(i))return;const{renderCoordsHelper:o}=s,{dimension:l,geometry:r}=i,d=P(),p=wt(P(),r,r.directSegment,o),h=Pt(g.get(),{forHeading:n,geometry:r,renderCoordsHelper:o}),m=ve(p,h,_e()),f=n?l.orientation??we(r,s.renderCoordsHelper):l.orientation??0;a.next(dt(s,m)).next(_=>{_.action==="start"&&$(d,_.renderStart);const M=Vt(m),y=ci(d,_.renderEnd,p,M);let z=f-It(y);n||(z=gn(z)),l.orientation=z}),t.next(Oe(l,["orientation"]))}function gn(e){const t=ye.normalize(e)%90;return t<Ne?e-t:90-t<Ne?e+(90-t):e}function fn(e,{computation:t,manipulatorMeasureType:i,view:n}){let a="direct",s=0,o=0;return[e.events.on("grab-changed",l=>{if(l.action!=="start"||!Y(t))return;const{dimension:r,geometry:d}=t;a=r.measureType,s=r.offset,o=r.orientation;const p=$(g.get(),e.renderLocation);r.measureType=i,r.offset=Ui(p,i,d,n.renderCoordsHelper),r.orientation=0}),te(e,(l,r,d)=>{if(!Y(t))return;const{geometry:p,dimension:h}=t,{renderCoordsHelper:m}=n,f=ct(bt,i,t,m),_=me(g.get(),{measureType:i,directSegment:p.directSegment,renderCoordsHelper:m}),M=$e(l);r.next(M).next(yt(n,h,f,_)),d.next(M).next(y=>(h.measureType=a,h.offset=s,h.orientation=o,y))})]}function yt(e,t,i,n){const a=ot(g.get(),i.endRenderSpace,i.startRenderSpace);L(a,a,n);const s=ve(i.startRenderSpace,a,_e()),o=ve(i.startRenderSpace,n,_e()),l=t.offset;let r,d=0;const p=new fi;return p.next(dt(e,s)).next(h=>{h.action==="start"&&(d=Ge(o,h.renderStart));const m=(Ge(o,h.renderEnd)-d)*e.renderCoordsHelper.unitInMeters;t.offset=l+m,r=h}),h=>(p.execute(h),r)}function St(e,t){const{directSegment:i}=e,{renderCoordsHelper:n}=t,a=he(g.get(),e,n),s=Te(g.get(),e),o=L(g.get(),s,a),{viewForward:l}=t.state.camera;H(o,l)>0&&ee(o,o,-1);const r=i.eval(.5,g.get());return n.headingAtPosition(r,o)}function vn(e,t,i){const{dimensionSegment:n,primaryOffsetAxis:a}=t,s=xe(W,t),o=it(s,F)?Et(ue):Ce(s,a,F,ue),l=Math.max(nt(s),Ji/i.unitInMeters);at(o,o,st(W,l,l,l)),e.modelTransform=o,e.renderLocation=n.eval(.5,W)}function _n(e,t,i){Mt(e,t,i,{forHeading:!0})}function yn(e,t,i){Mt(e,t,i,{forHeading:!1})}function Mt(e,t,i,{forHeading:n}){const{dimension:a,geometry:s}=t,{primaryOffsetAxis:o}=s,l=ee(Sn,o,a.offset>=0?1:-1),r=Pt(Mn,{forHeading:n,geometry:s,renderCoordsHelper:i});L(r,r,l);const d=Ce(l,r,F,ue);e.modelTransform=d,e.renderLocation=wt(W,s,s.dimensionSegment,i)}const Sn=P(),Mn=P();function wn(e,t,i,n){const{geometry:a}=t,s=ct(bt,i,t,n),o=me(W,{measureType:i,directSegment:a.directSegment,renderCoordsHelper:n}),l=R(ge,s.endRenderSpace,s.startRenderSpace),r=Ce(l,o,F,ue),d=nt(l);at(r,r,st(ge,d,d,d)),e.modelTransform=r,e.renderLocation=s.eval(.5,ge)}function wt(e,t,i,n){const{startRenderSpace:a,endRenderSpace:s}=i,o=Pn(t,n)?a:s;return $(e,o)}function Pt(e,{forHeading:t,geometry:i,renderCoordsHelper:n}){return t?he(e,i,n):xe(e,i,{invert:!0})}function Pn(e,t){const i=Te(bn,e),n=he(Cn,e,t);return H(i,n)>0}const bn=P(),Cn=P();function $n(e){return D(e)+qi}function Re(e){return D(e)+Wi}function Xe(e,t){const i=t.material,n=t.focusMultiplier??ie.focusMultiplier,a=t.calloutLength??ie.calloutLength,s=ie.discRadius*(t.discScale??1),o=s*n,l=(f,_)=>{const M=[0,1,2,2,3,0];return new Ut(_,[["position",new Ee([a-f,-f,0,a+f,-f,0,a+f,f,0,a-f,f,0],M,3,!0)],["uv0",new Ee([0,0,1,0,1,1,0,1],M,2,!0)]])},r=t.calloutWidth??ie.calloutWidth,d=new j({width:r,color:t.calloutColor,renderOccluded:4,isDecoration:!0},e.view.state.isGlobal),p=J(d,[[0,0,0],[a-s,0,0]]),h=J(d,[[0,0,0],[a-o,0,0]]),m=t.customStateMask??0;e.collisionType={type:"disc",direction:[0,0,1],offset:[a,0,0]},e.focusMultiplier=n,e.metadata=t.metadata,e.radius=s,e.renderObjects=[new T(l(s,i),1|m),new T(p,1|m),new T(l(o,i),2|m),new T(h,2|m)]}const A=16,W=P(),ge=P(),ue=Pe(),bt=new U;function On(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function Dn(e,t){if(ht(e))return 2;if(!e.enabled)return null;const{geometry:i}=e;if(i==null||it(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:n}=t.state,a=he(g.get(),i,t.renderCoordsHelper),s=Te(g.get(),i),o=ee(g.get(),a,H(s,a)),l=ot(g.get(),s,o),r=fe(l),d=fe(o),{startRenderSpace:p,endRenderSpace:h}=i.directSegment,m=Math.max(n.computeScreenPixelSizeAt(p)*qe,n.computeScreenPixelSizeAt(h)*qe)**2;return r<m?1:d<m?0:null}function Tn(e,t,{constraint:i,view:n}){const{unconstrainedGeometry:a}=e;if(a==null)return;const{renderCoordsHelper:s,spatialReference:o}=n,{startRenderSpace:l,endRenderSpace:r}=a.directSegment,d=s.fromRenderCoords(l,new G({spatialReference:o})),p=s.fromRenderCoords(r,new G({spatialReference:o}));let h;h=t==="start"?{startPoint:d}:{endPoint:p},Ct(e,h,{constraint:i,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:a,view:n})}function Ct(e,t,i){const{constraint:n,elevationAlignedStartPoint:a,elevationAlignedEndPoint:s,unconstrainedGeometry:o,view:l}=i,{dimension:r,previousConstraint:d,preConstraintProperties:p}=e;if(a==null||s==null)return;const h=()=>{"startPoint"in t?r.startPoint=t.startPoint:"endPoint"in t&&(r.endPoint=t.endPoint)};if(n==null)h(),d!=null&&p!=null&&(r.measureType=p.measureType,r.orientation=p.orientation);else switch(r.measureType="direct",n){case 0:if(n!==d&&(r.orientation=0),"startPoint"in t){const m=t.startPoint;m!=null&&(m.z=s.z),r.startPoint=m}else if("endPoint"in t){const m=t.endPoint;m!=null&&(m.z=a.z),r.endPoint=m}break;case 1:if(n!==d&&(r.orientation=St(o,l)),"startPoint"in t){const m=t.startPoint;m!=null&&(m.x=s.x,m.y=s.y),r.startPoint=m}else if("endPoint"in t){const m=t.endPoint;m!=null&&(m.x=a.x,m.y=a.y),r.endPoint=m}break;case 2:n!==d&&p!=null&&(r.orientation=p.orientation),h()}e.previousConstraint=n,e.unconstrainedGeometry=o}let S=class extends Q{constructor(e){super(e),this._stagedDimension=null,this._snappingManagerResult=null,this._computationManipulators=new Map,this._computationHandles=new rt,this._updatingHandles=new jt,this._getSnappingContext=Ft(n=>new Pi({elevationInfo:{mode:"absolute-height",offset:0},pointer:n,editGeometryOperations:new Si(new Mi("point",wi(!0,!1,this.view.spatialReference)),this.view.state.viewingMode),visualizer:new vi}));const{view:t}=e;this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(t),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(t),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(t),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:re(2)}),this._constraintSnappingIndicator=new E({view:t,attached:!0,width:1,renderOccluded:4,stipplePattern:re(5),isDecoration:!0});const i=V.toUnitRGBA(Ni);this._stagedStartIndicator=new _i({view:t,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:e.view.renderCoordsHelper.spatialReference,color:i,size:2*gt,outlineSize:0,renderOccluded:4,isDecoration:!0})}initialize(){const{view:e}=this;this._snappingOperation=new $i({view:e});const t=K(e.effectiveTheme),i=Be(e.effectiveTheme),n=!e.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._textureHandle=Ue(e.stage.textures,{accentColor:t,contrastColor:i,preMultiplyAlpha:n}),this._orientationManipulatorMaterial=new yi({draped:!1,texture:this._textureHandle.texture,writeDepth:!1,renderOccluded:16,isDecoration:!0});const a=ce(()=>this.analysisViewData.computations,({computation:s})=>this._createManipulators(s));this.addHandles([v(()=>({accentColor:K(e.effectiveTheme),contrastColor:Be(e.effectiveTheme)}),({accentColor:s,contrastColor:o})=>{const l=this._textureHandle;this._textureHandle=Ue(e.stage.textures,{accentColor:s,contrastColor:o,preMultiplyAlpha:n}),this._orientationManipulatorMaterial.setParameters({texture:this._textureHandle.texture}),l?.release();const r=V.toUnitRGBA(s);this._unfocusedOffsetManipulatorMaterial.setParameters({color:r}),this._focusedOffsetManipulatorMaterial.setParameters({color:r}),this._thinOffsetManipulatorMaterial.setParameters({color:r}),this._constraintSnappingIndicator.color=r},X),Z(a),v(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:s,stagedComputation:o})=>{if(o==null||s==null)return;const l=q(s,new G);this._applyPointUpdate(o,{endPoint:l})},Se),v(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(s,o)=>{const{stagedDimension:l,selectedComputation:r,firstGrabbedManipulator:d}=s;if(l===o?.stagedDimension&&d===o?.firstGrabbedManipulator){for(const p of[r,o?.selectedComputation])if(p!=null){const h=this._computationManipulators.get(p);h!=null&&this._updateManipulators(p,h,s)}}else for(const[p,h]of this._computationManipulators)this._updateManipulators(p,h,s)},O),v(()=>this.analysis.style.lineSize,s=>this._updateManipulatorStyle(s),X),v(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),v(()=>{const s=this._stagedComputation;if(!s)return null;const o=s.elevationAlignedStartPoint,l=P();return o!=null&&this.view.renderCoordsHelper.toRenderCoords(o,l)?l:null},s=>{s!=null?(this._stagedStartIndicator.vertices=[s],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),ri(this,()=>{const s=this._activeComputation,o=this._stagedComputation;if(s==null||o!=null){const l=this.view.inputManager.latestPointerInfo?.type??"mouse",r=this._getSnappingContext(l);this._updatingHandles.addPromise(Le(this._snappingOperation.snapAgainNearPreviousMapPoint(this._ensureSnappingManager(),r)))}if(s!=null){const{start:l,end:r}=this._computationManipulators.get(s);if(l.grabbing||r.grabbing){const d=l.grabbing?"start":"end",p=this._computeConstraint(s);Tn(s,d,{constraint:p,view:this.view})}}})}destroy(){this._textureHandle=Bt(this._textureHandle),this._snappingOperation=be(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose()}get updating(){return this._updatingHandles.updating||!!this._snappingManager?.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager?.options}get _snappingManager(){return this._snappingManagerResult?.snappingManager}_ensureSnappingManager(){return this._snappingManagerResult||(this._snappingManagerResult=Ci(this.view),this.addHandles(this._snappingManagerResult)),this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:e}=this.analysisViewData;return this.hasGrabbedManipulators&&e!=null?e:null}get _stagedComputation(){const e=this._stagedDimension,t=this.analysisViewData.computations.at(-1)?.computation;return e==null||t==null||t.dimension!==e?null:t}get _constraintHandles(){return[oe(()=>this.analysisViewData.selectedComputation,e=>{e.previousConstraint=this._computeConstraint(e)},{...O,equals:Me}),v(()=>{const e=this._activeComputation;if(e==null)return null;const{measureType:t,orientation:i}=e.dimension;return{measureType:t,orientation:i,computation:e}},(e,t)=>{if(e!=null&&t==null){const{measureType:i,orientation:n,computation:a}=e;switch(a.previousConstraint){case 0:a.preConstraintProperties={measureType:"horizontal",orientation:0};break;case 1:a.preConstraintProperties={measureType:"vertical",orientation:0};break;case 2:a.preConstraintProperties={measureType:"direct",orientation:n};break;default:a.preConstraintProperties={measureType:i,orientation:n}}}e==null&&t!=null&&(t.computation.preConstraintProperties=null)},Se)]}get _snappingIndicatorHandles(){const e="snapping-indicator-event-handles";return[v(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:t,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(e),i!=null)if(i===t)n.attached=!0;else{const{start:a,end:s}=this._computationManipulators.get(i),o=()=>{n.attached=a.grabbing||s.grabbing};o(),this.addHandles([a.events.on("grab-changed",o),s.events.on("grab-changed",o)],e)}else n.attached=!1}),v(()=>{const t=this._activeComputation;return t!=null?{geometry:t.geometry,constraint:t.previousConstraint}:{}},({geometry:t,constraint:i})=>{const n=this._constraintSnappingIndicator;t!=null&&i!=null&&i!==2?(n.visible=!0,n.setGeometryFromSegment(t.directSegment)):n.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(e){const{_stagedDimension:t}=this;if(t==null){const i=this._onUnstagedClick(e);return this.analysis.dimensions.add(i),null}return this._onStagedClick(e),t}onPointerMove({mapPoint:e,pointerType:t}){if(t==="touch")return;const i=this._getSnappingContext(t);this._updatingHandles.addPromise(Le(this._snappingOperation.snap({point:e},this._ensureSnappingManager(),i)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:e,pointerType:t}){let i=e;if(t==="mouse"){const a=this._getSnappingContext(t);i=this._ensureSnappingManager().update({point:e,context:a})}const n=new di({startPoint:q(i,new G),endPoint:null,measureType:"horizontal"});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:e,pointerType:t}){const i=this._stagedComputation;if(i==null)return;let n=e;if(t==="mouse"){const s=this._getSnappingContext(t);n=this._ensureSnappingManager().update({point:e,context:s})}const a=q(n,new G);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._ensureSnappingManager().doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(e){const t=this._setupPointManipulator(e,{isStart:!0}),i=this._setupPointManipulator(e,{isStart:!1}),n=this._setupOffsetManipulator(e),a=this._setupHeadingManipulator(e),s=this._setupRotationManipulator(e),o=this._setupMeasureTypeManipulator(e,"direct"),l=this._setupMeasureTypeManipulator(e,"horizontal"),r=this._setupMeasureTypeManipulator(e,"vertical"),d=new on({start:t,end:i,offset:n,heading:a,rotation:s,direct:o,horizontal:l,vertical:r});this._setupComputationToManipulatorsSync(e,d),this._computationManipulators.set(e,d),this.manipulators.addMany(d.values());const p=Nt(d.values().map(h=>h.events.on("focus-changed",()=>{d.values().some(m=>m.focused)&&this._resetSnappingState()})));return{manipulators:d,remove:()=>{p.remove(),this._computationHandles.remove(e),this._computationManipulators.delete(e);for(const h of d.values())this.manipulators.remove(h)}}}_setupComputationToManipulatorsSync(e,t){this._computationHandles.add([v(()=>e.geometry,()=>this._updateManipulators(e,t),{...O,equals:Me})],e)}_setupPointManipulator(e,t){const{view:i}=this,{dimension:n}=e,a=new rn(i,{metadata:n}),s=un(a,{isStart:t.isStart,createSnappingPipelineStep:o=>bi({snappingContext:this._getSnappingContext(o),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:n,onUpdate:o=>this._applyPointUpdate(e,o),view:i});return this._computationHandles.add(s,e),a}_setupOffsetManipulator(e){const{view:t}=this,i=ln(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:e.dimension}),n=cn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupHeadingManipulator(e){const{view:t}=this,i=new We(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=pn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupRotationManipulator(e){const{view:t}=this,i=new We(t,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:e.dimension}),n=mn(i,{computation:e,view:t});return this._computationHandles.add(n,e),i}_setupMeasureTypeManipulator(e,t){const{view:i}=this,n=dn(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:e.dimension}),a=fn(n,{computation:e,manipulatorMeasureType:t,view:i});return this._computationHandles.add(a,e),n}_updateManipulators(e,t,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:a,firstGrabbedManipulator:s}=i,{start:o,end:l,offset:r,heading:d,rotation:p}=t,h=a===e,m=Y(e),{dimension:f}=e;for(const y of t.values()){const z=m&&n==null&&(s==null||y===s);y===r?(y.available=z,y.selected=h):y.available=z&&h}if(!m)return;this._computeConstraint(e)!=null?t.forEachMeasureTypeManipulator(y=>y.available=!1):t.manipulatorForMeasureType(f.measureType).available=!1;for(const y of[d,p])f.measureType==="direct"&&f.offset!==0||(y.available=!1);De(e)?p.available=!1:d.available=!1;const{geometry:_}=e;o.renderLocation=_.directSegment.startRenderSpace,l.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;vn(r,_,M),d.available&&_n(d,e,M),p.available&&yn(p,e,M),t.forEachMeasureTypeManipulator((y,z)=>{y.available&&wn(y,e,z,M)})}_updateManipulatorStyle(e){const t=$n(e),i=Re(e),n={lineSizePt:e,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:s,rotation:o}of this._computationManipulators.values())a.radius=i/2,s.update(n),o.update(n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:t}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(e,t){const{view:i}=this,n=le(e);"startPoint"in t&&(n.elevationAlignedStartPoint=t.startPoint),"endPoint"in t&&(n.elevationAlignedEndPoint=t.endPoint);const a=de(n,i.renderCoordsHelper);if(a==null)return;const s=this._computeConstraint({...n,geometry:a});Ct(e,t,{...n,constraint:s,unconstrainedGeometry:a,view:i}),e===this._stagedComputation&&this._updateStagedDimensionOffset(e)}_updateStagedDimensionOffset(e){if(e.geometry==null)return;e.geometry.directSegment.eval(.5,Ye);const{state:t,renderCoordsHelper:i}=this.view,n=t.camera.computeScreenPixelSizeAt(Ye);e.dimension.offset=an*n*i.unitInMeters}_computeConstraint(e){return Dn(On(e,this._ensureSnappingManager().options),this.view)}_createOffsetManipulatorMaterial(e){return new j({width:1,renderOccluded:4,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0},e.state.isGlobal)}get test(){}};u([c({constructOnly:!0})],S.prototype,"analysis",void 0),u([c({constructOnly:!0})],S.prototype,"analysisViewData",void 0),u([c({constructOnly:!0})],S.prototype,"manipulators",void 0),u([c({constructOnly:!0})],S.prototype,"parentTool",void 0),u([c({constructOnly:!0,nonNullable:!0})],S.prototype,"view",void 0),u([c({readOnly:!0})],S.prototype,"updating",null),u([c()],S.prototype,"firstGrabbedManipulator",null),u([c()],S.prototype,"hasGrabbedManipulators",null),u([c()],S.prototype,"snappingOptions",null),u([c()],S.prototype,"_stagedDimension",void 0),u([c()],S.prototype,"_snappingManager",null),u([c()],S.prototype,"_activeComputation",null),u([c()],S.prototype,"_stagedComputation",null),u([c()],S.prototype,"_snappingManagerResult",void 0),S=u([I("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],S);const Ye=P();let b=class extends Oi{constructor(e){super(e),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._placementMode=Ke,this._pointerMoveTimerMs=nn,this._prevPointerMoveTimeout=null}initialize(){this._intersector=xi(this.view.state.viewingMode),this._lengthDimensionSubTool=new S({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Z(this._lengthDimensionSubTool),qt(()=>this._clearPointerMoveTimeout()),oe(()=>this.state==="created",()=>this.finishToolCreation(),O),oe(()=>this.firstGrabbedManipulator,e=>{this.selectedDimension=e.metadata},O),v(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),O)])}get state(){return this.analysis.dimensions.some(e=>e.type==="length")?this._activeSubTool!=null?"creating":"created":"ready"}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(e){this.analysisViewData.selectedDimension=e}place(e){this.selectedDimension=null,this._placementMode=e}onInputEvent(e){switch(e.type){case"immediate-click":this._clickHandler(e);break;case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":this._keyDownHandler(e)}}onActivate(){this._placementMode=Ke,this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool?.onDeactivate(),this._activeSubTool=null}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(e){if(this.hasFocusedManipulators)return void e.stopPropagation();if(this._activeSubTool==null)return;const t=this._intersectScreen(e);t!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:t,pointerType:e.pointerType}),this.selectedDimension&&this._placementMode==="single"&&(this.view.activeTool=null),e.stopPropagation())}_doubleClickHandler(e){this.active&&(this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const t=this._intersectScreen(e);t!=null&&this._activeSubTool.onPointerMove({mapPoint:t,pointerType:e.pointerType})}_keyDownHandler(e){Ve.cancel===e.key?(this._activeSubTool?.removeStaged()&&this._placementMode==="multiple"&&e.stopPropagation(),this.active||(this.selectedDimension=null)):Ve.delete.includes(e.key)&&(this._activeSubTool?.removeStaged(),this._removeSelected())}_intersectScreen(e){const t=Wt(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector);const i=this._intersector.results.min,n=g.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,new G({spatialReference:this.view.spatialReference})):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Jt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(e=>e.manipulator.state|=A),this._prevPointerMoveTimeout=Xt.setTimeout(()=>{this.manipulators.forEach(e=>e.manipulator.state&=~A)},this._pointerMoveTimerMs)}get test(){}};u([c({constructOnly:!0})],b.prototype,"view",void 0),u([c({constructOnly:!0})],b.prototype,"analysis",void 0),u([c({readOnly:!0})],b.prototype,"state",null),u([c({readOnly:!0})],b.prototype,"updating",null),u([c({readOnly:!0})],b.prototype,"cursor",null),u([c({constructOnly:!0})],b.prototype,"analysisViewData",void 0),u([c()],b.prototype,"selectedDimension",null),u([c()],b.prototype,"automaticManipulatorSelection",void 0),u([c()],b.prototype,"_activeSubTool",void 0),u([c()],b.prototype,"_lengthDimensionSubTool",void 0),u([c()],b.prototype,"_placementMode",void 0),b=u([I("esri.views.3d.analysis.Dimension.DimensionTool")],b);const Ke="multiple";class xn extends pi{constructor(t,i){super(t),this._hasExternalMaterial=!1,this._renderOccluded=4,this._width=1,this._color=Yt(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=i,this._hasExternalMaterial=i!=null,this.applyProperties(t)}setGeometryFromSegment(t,i){const n=t.endRenderSpace;this.transform=Kt(Rn,n),this._normal=i;const{points:a}=t.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[a]}get renderOccluded(){return this._material?.parameters.renderOccluded??this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,this._material?.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return this._material?.parameters.width??this._width}set width(t){this._width=t,this._material?.setParameters({width:t})}get color(){return this._material?.parameters.color??this._color}set color(t){this._color=Qt(t),this._material?.setParameters({color:this._color})}get placement(){return this._material?.parameters.placement??this._placement}set placement(t){this._placement=t,this._material?.setParameters({placement:this._placement})}get markerPrimitive(){return this._material?.parameters.markerPrimitive??this._markerPrimitive}set markerPrimitive(t){this._markerPrimitive=t,this._material?.setParameters({markerPrimitive:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new ut({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration},this.view.state.isGlobal))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const i of Ri(this.geometry,this.normal)){const n=Ai(this._material,i);t.addGeometry(n)}}forEachMaterial(t){this._hasExternalMaterial||t(this._material)}}const Rn=Pe();let An=class{set visible(t){for(const i of this._visualElements.values())i.attached=t}constructor(t){this.destroyed=!1,this._handles=new rt,this._messages=null,this._labelSegment=new U;const{analysis:i,computation:n,view:a,messages:s,isDecoration:o}=t;this.analysis=i,this.computation=n,this.view=a,this._messages=s;const l=t.visible,r={view:a,attached:l,isDecoration:o},{fontSize:d,textColor:p,textBackgroundColor:h}=i.style;this._visualElements=new En({marker:new xn(r,t.markerMaterial),dimension:new E(r,t.dimensionLineMaterial),startOffset:new E(r,t.offsetLineMaterial),endOffset:new E(r,t.offsetLineMaterial),dimensionSmall:new E(r,t.smallDimensionLineMaterial),startOffsetSmall:new E(r,t.smallOffsetLineMaterial),endOffsetSmall:new E(r,t.smallOffsetLineMaterial),label:new ai({view:a,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:D(d),textColor:p.clone(),backgroundColor:h.clone(),isDecoration:o})}),this._handles.add([v(()=>n.geometry,m=>{this.updateCameraDependentElements(a.state.camera,m,i.style),n.geometry!=null&&this._updateLines(n.geometry)},{...X,equals:Me}),v(()=>n.length,m=>this._updateLabelContent(m),X)])}destroy(){this.destroyed=!0,this._handles=be(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){}_updateLines(t){const i=Fe(zn,0,t.directSegment,t.dimensionSegment),n=Fe(kn,1,t.directSegment,t.dimensionSegment),a=this._visualElements;a.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),a.dimension.setGeometryFromSegment(t.dimensionSegment),a.startOffset.setGeometryFromSegment(i),a.endOffset.setGeometryFromSegment(n),a.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),a.startOffsetSmall.setGeometryFromSegment(i),a.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(t,i,n){const a=this._visualElements;if(i==null){for(const M of a.values())M.visible=!1;return}const s=t.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Gn)),o=Fi(i,s),l=o<(D(n.lineSize)*sn)**2,r=!l;a.marker.visible=r,a.dimension.visible=r,a.startOffset.visible=r,a.endOffset.visible=r,a.dimensionSmall.visible=l,a.startOffsetSmall.visible=l,a.endOffsetSmall.visible=l;const d=D(n.fontSize)*tn,{label:p}=a;if(p.visible=o>=d**2,!p.visible)return;const{dimensionSegment:h,primaryOffsetAxis:m}=i,{offset:f}=this.computation.dimension,_=(Math.sign(f)>=0?1:-1)*Hn(n)*s;Gi(this._labelSegment,h,m,_),p.updateLabelPosition()}updateLabelStyle(t){const{label:i}=this._visualElements;i.fontSize=D(t.fontSize),i.textColor=t.textColor,i.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(t){const{label:i}=this._visualElements;t!=null&&this._messages!=null?i.text=Zt(this._messages,t,t.unit):i.text=""}};function Hn(e){return 1.5*D(e.fontSize)+en+D(e.lineSize/2)}const zn=new U,kn=new U,Gn=P();class En{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let x=class extends Q{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null}initialize(){const e=this.isDecoration;this._markerMaterial=new ut({width:1,anchor:1,color:B,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:4,markerPrimitive:"triangle",isDecoration:e},this.view.state.isGlobal),this._dimensionLineMaterial=new j({width:1,color:B,renderOccluded:4,markerParameters:this._markerMaterial.parameters,isDecoration:e},this.view.state.isGlobal),this._offsetLineMaterial=new j({width:1,color:B,renderOccluded:4,stipplePattern:re(5),isDecoration:e},this.view.state.isGlobal),this._smallDimensionLineMaterial=new j({width:1,color:B,renderOccluded:4,isDecoration:e},this.view.state.isGlobal),this._smallOffsetLineMaterial=new j({width:1,color:B,renderOccluded:4,stipplePattern:re(5),isDecoration:e},this.view.state.isGlobal);const t=ce(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=t,this.addHandles([Z(t),v(()=>V.toUnitRGBA(this.analysis.style.color),i=>{for(const n of this._lineMaterials())n.setParameters({color:i})},O),v(()=>this.analysis.style.lineSize,i=>{const n=D(i);this._markerMaterial.setParameters({width:n*ft}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const a=Math.max(n*Zi,1);this._offsetLineMaterial.setParameters({width:a})},O),v(()=>({camera:this.view.state.camera,style:Ln(this.analysis)}),({camera:i,style:n})=>{for(const{visualization:a}of this._dimensionVisualizations)a.updateCameraDependentElements(i,a.computation.geometry,n),a.updateLabelStyle(n)}),v(()=>this.visible,i=>{for(const{visualization:n}of this._dimensionVisualizations)n.visible=i})]),this.addHandles([ei(()=>this._updateMessageBundle()),oe(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},Se)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(e){const t=new An({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:t,remove:()=>t.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await ti("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Ln(e){const{fontSize:t,lineSize:i,textColor:n,textBackgroundColor:a}=e.style;return{fontSize:t,lineSize:i,textBackgroundColor:a.clone(),textColor:n.clone()}}u([c({constructOnly:!0})],x.prototype,"analysisViewData",void 0),u([c({constructOnly:!0,nonNullable:!0})],x.prototype,"view",void 0),u([c({constructOnly:!0})],x.prototype,"isDecoration",void 0),u([c()],x.prototype,"analysis",null),u([c()],x.prototype,"visible",null),u([c()],x.prototype,"loadingMessages",void 0),x=u([I("esri.views.3d.analysis.Dimension.DimensionVisualization")],x);let N=class extends Q{constructor(e){super(e),this.dimension=null,this.length=null}};u([c({constructOnly:!0,nonNullable:!0})],N.prototype,"dimension",void 0),u([c()],N.prototype,"length",void 0),N=u([I("esri.views.analysis.LengthDimensionResult")],N);let C=class extends Q{constructor(e){super(e),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(e){const{dimension:t,...i}=e;return{result:new N({dimension:t}),...i}}initialize(){this.addHandles([v(()=>this.dimension.startPoint,e=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(e),O),v(()=>this.dimension.endPoint,e=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(e),O)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};u([c({constructOnly:!0,nonNullable:!0})],C.prototype,"result",void 0),u([c({constructOnly:!0,nonNullable:!0})],C.prototype,"projectAndAlignPoint",void 0),u([c()],C.prototype,"dimension",null),u([c()],C.prototype,"length",null),u([c()],C.prototype,"geometry",void 0),u([c()],C.prototype,"unconstrainedGeometry",void 0),u([c()],C.prototype,"elevationAlignedStartPoint",void 0),u([c()],C.prototype,"elevationAlignedEndPoint",void 0),u([c()],C.prototype,"preConstraintProperties",void 0),u([c()],C.prototype,"previousConstraint",void 0),C=u([I("esri.views.3d.analysis.Dimension.LengthDimensionComputation")],C);let w=class extends ni{constructor(e){super(e),this.type="dimension-view-3d",this.analysis=null,this.tool=null,this.selectedDimension=null,this.userOperation=null,this._dimensionsToComputations=new Map,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(t==null)return null;const{spatialReference:i,elevationProvider:n}=this.view,a=mi(t,i,n);return a==null&&hi(this.analysis,t.spatialReference,tt.getLogger(this)),a};const e=ce(()=>this.analysis.dimensions,t=>this._createComputation(t));this.computations=e,this.addHandles([Di(this,b),Z(e)]),this._analysisVisualization=new x({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this.addResolvingPromise(Hi().then(t=>{this._analysisController=new k({analysisViewData:this,view:this.view,automaticLengthMeasurementUtils:t})}))}destroy(){this.userOperation=ii(this.userOperation),Ti(this),this._analysisVisualization=be(this._analysisVisualization)}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map(e=>this._dimensionsToComputations.get(e).result)}get selectedComputation(){const{selectedDimension:e}=this;return e==null?null:this._dimensionsToComputations.get(e)}get testInfo(){}async createLengthDimensions(e){this.selectedDimension=null,await Ie(this,{placementOptions:e,onToolActivated:t=>t.place("multiple")})}place(e){return this.selectedDimension=null,Ie(this,{placementOptions:e,onToolActivated:t=>t.place("single")})}_createComputation(e){const{_dimensionsToComputations:t}=this,i=new C({dimension:e,projectAndAlignPoint:this._projectAndAlignPoint});return t.set(e,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(e){const{dimension:t}=e;t===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(t),e.destroy()}};u([c({readOnly:!0})],w.prototype,"type",void 0),u([c({constructOnly:!0,nonNullable:!0})],w.prototype,"analysis",void 0),u([c()],w.prototype,"tool",void 0),u([c()],w.prototype,"updating",null),u([c({readOnly:!0})],w.prototype,"results",null),u([c()],w.prototype,"computations",void 0),u([c()],w.prototype,"selectedDimension",void 0),u([c()],w.prototype,"selectedComputation",null),u([c()],w.prototype,"userOperation",void 0),u([c()],w.prototype,"_analysisVisualization",void 0),u([c()],w.prototype,"_analysisController",void 0),u([c()],w.prototype,"_dimensionsToComputations",void 0),w=u([I("esri.views.3d.analysis.DimensionAnalysisView3D")],w);const Ta=w;export{Ta as default};
