import{lN as C,n,p as o,lO as O,gW as k,u as L,ad as P,f4 as m,d8 as T,lP as $,lQ as b,hZ as D,lR as S,lS as N,lT as U,b3 as c,lU as V,b6 as v,gK as F,ib as w,lV as Q,gR as W,lW as j,lX as E,lY as G,lZ as x,l_ as A,l$ as H,m0 as p,m1 as B,m2 as Z,m3 as y,eq as z,m4 as X,i as R,h_ as Y}from"./index-BYdCJpuA.js";import{e as J}from"./FeatureIdInfo-iL5WjyEH.js";import{E as K}from"./constants-SxxbBSOD.js";import{e as M}from"./featureServiceUtils-YxRwysXk.js";class ee{constructor(s){this._fieldsIndex=s,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(s=>s.currentUserRequired)}}visitClientWhereClause(s){s&&this._clauses.push(C(s,this._fieldsIndex))}visitFeatureReduction(s){if(s)switch(s.type){case"binning":case"cluster":this.visitLabelingInfo(s.labelsVisible,s.labelingInfo)}}visitLabelingInfo(s,l){if(s&&l!=null)for(const t of l)this.visitClientWhereClause(t.where)}visitDisplayFilter(s,l){if(s)for(const t of l?.filters??[])this.visitClientWhereClause(t.where)}visitFilter(s){this.visitClientWhereClause(s?.where)}visitTrackInfo(s){s!=null&&(this.visitLabelingInfo(s?.latestObservations.labelsVisible,s?.latestObservations.labelingInfo),this.visitLabelingInfo(s?.previousObservations.labelsVisible,s?.previousObservations.labelingInfo),this.visitLabelingInfo(s?.trackLines.labelsVisible,s?.trackLines.labelingInfo))}}const le=g=>{const s=g;let l=class extends s{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([P(()=>{const t=this.layer,e=this.view;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,e?.requiredFieldsOptions?.featureTitleFields&&t&&"featureTitleFields"in t&&t.featureTitleFields,e?.requiredFieldsOptions?.utilityNetworkFields&&$(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,t?.type==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&t.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode]},()=>this._handleChange(),T),m(()=>this.view?.floors,"change",()=>this._handleChange()),m(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),m(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?b(e,[...D(e,t.outFields),...r]):b(e,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?S(t.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){const t=this.effectiveDisplayFilter?.where??null;return t&&this.hasHighlight?N(t,U(this.layer.objectIdField,this.highlightIds)):t}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){c.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?V(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new v(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=F(e.where,w(this))),this.displayFilterEnabled&&(e.where=F(e.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new v(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){const r=[],h=new Set;for(const u of t){const i=Q(u.origin),d=W(i,{...e,checkPopupEnabled:!0});d&&(r.push(u),h.add(d))}if(r.length===0||h.size===0)return[];const f=await this._createPopupQuery(h,e);return await j(this.layer,r,f,{hasRequiredFields:(u,i)=>this._popupFeatureHasRequiredFields(u,i),...e})}_handleChange(){const t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",t),t.then(()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)}),t}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:t}=this,e=new ee(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter(this.featureEffect?.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(const r of t.sublayers)e.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{const r=await e.finish();this._set("requiresCurrentUser",r.requiresCurrentUser)}catch(r){c.getLogger(this).error(r)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r}}=this,h="renderer"in e&&e.renderer,f="orderBy"in e&&e.orderBy,u="featureReduction"in e?e.featureReduction:null,i=new Set,d=[h?h.collectRequiredFields(i,r):null,E(i,e),t&&"elevationInfo"in e?G(i,e):null,this.filter!=null?x(i,e,this.filter):null,t||this.featureEffect==null?null:x(i,e,this.featureEffect.filter),!t&&u?A(i,e,u):null,!t&&f?H(i,e,f):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&p(i,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){const{trackInfo:a}=e;p(i,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&a.timeField!=="startTimeField"||p(i,e.fieldsIndex,[e.timeInfo.startField]),a.timeField==="endTimeField"&&p(i,e.fieldsIndex,[e.timeInfo.endField]),await B(i,e)}if("floorInfo"in e&&e.floorInfo&&p(i,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&this.view?.requiredFieldsOptions?.featureTitleFields&&e.featureTitleFields&&p(i,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&p(i,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&d.push(Z(i,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&c.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),p(i,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){y(i,r,e.subtypeField);const a=e.sublayers.map(I=>Promise.all([I.renderer?.collectRequiredFields(i,r),E(i,I)]));d.push(Promise.all(a))}if(e.type==="catalog-footprint"&&e.parent){const a=e.parent;p(i,r,[a.itemNameField,a.itemSourceField,a.itemTypeField,a.maxScaleField,a.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&y(i,r,K);const q=await Promise.allSettled(d);if(t)y(i,r,e.objectIdField);else for(const a of J(M(e)))y(i,r,a);t&&"displayField"in e&&e.displayField&&y(i,r,e.displayField);for(const a of q)a.status==="rejected"&&c.getLogger(this).error(a.reason);const _=Array.from(i).sort();this._set("requiredFields",_)}_popupFeatureHasRequiredFields(t,e){return z(t,e)}async _createPopupQuery(t,e){const r=this.layer.createQuery(),h=new Set;let f=this.layer.geometryType==="point";for(const u of t){if(!f){const d=await X(u);R(e),f=(d&&d.arcadeUtils.hasGeometryOperations(u))??!1}const i=await Y(this.layer,u);R(e);for(const d of i)h.add(d)}return r.returnGeometry=f,r.returnZ=f,r.returnM=f,r.outFields=Array.from(h),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=F(r.where,w(this))),r}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return n([o()],l.prototype,"_updatingRequiredPromise",void 0),n([o({readOnly:!0})],l.prototype,"availableFields",null),n([o({readOnly:!0})],l.prototype,"displayFilterEnabled",null),n([o({readOnly:!0})],l.prototype,"effectiveDisplayFilter",null),n([o({readOnly:!0})],l.prototype,"effectiveDisplayFilterClause",null),n([o({type:O})],l.prototype,"featureEffect",null),n([o({type:k})],l.prototype,"filter",void 0),n([o()],l.prototype,"layer",void 0),n([o({type:Number})],l.prototype,"maximumNumberOfFeatures",null),n([o({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null),n([o()],l.prototype,"requiresCurrentUser",void 0),n([o({readOnly:!0})],l.prototype,"requiredFields",void 0),n([o({readOnly:!0})],l.prototype,"signedInUser",null),n([o()],l.prototype,"suspended",void 0),n([o()],l.prototype,"view",void 0),l=n([L("esri.views.layers.FeatureLayerView")],l),l};export{le as Q};
